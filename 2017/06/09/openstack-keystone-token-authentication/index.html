<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>OpenStack 源码系列之 Keystone：Token 认证 | Max&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在上一篇博文中我们已经简要介绍了 Keystone，该篇就重点介绍 Keystone Token（Scoped）认证的流程。 有一张图很好概括了 Keystone 的工作流程（图的原始来源目前尚未找到）：    下边我们主要介绍该图虚拟机创建前的流程。">
<meta name="keywords" content="OpenStack,Keystone,Token">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenStack 源码系列之 Keystone：Token 认证">
<meta property="og:url" content="http://xiehongfeng100.github.io/2017/06/09/openstack-keystone-token-authentication/index.html">
<meta property="og:site_name" content="Max&#39;s Blog">
<meta property="og:description" content="在上一篇博文中我们已经简要介绍了 Keystone，该篇就重点介绍 Keystone Token（Scoped）认证的流程。 有一张图很好概括了 Keystone 的工作流程（图的原始来源目前尚未找到）：    下边我们主要介绍该图虚拟机创建前的流程。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/cloud-computation/openstack/keystone/keystone-authentication/keystone_workflow.png">
<meta property="og:updated_time" content="2019-05-01T06:21:57.262Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OpenStack 源码系列之 Keystone：Token 认证">
<meta name="twitter:description" content="在上一篇博文中我们已经简要介绍了 Keystone，该篇就重点介绍 Keystone Token（Scoped）认证的流程。 有一张图很好概括了 Keystone 的工作流程（图的原始来源目前尚未找到）：    下边我们主要介绍该图虚拟机创建前的流程。">
<meta name="twitter:image" content="http://xiehongfeng100.github.io/images/cloud-computation/openstack/keystone/keystone-authentication/keystone_workflow.png">
  
    <link rel="alternative" href="/atom.xml" title="Max&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="img/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/author.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Max</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Stay hungry, stay foolish.</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/categories/读书">读书</a></li>
				        
							<li><a href="/tags/翻译">翻译</a></li>
				        
							<li><a href="/categories/网络">网络</a></li>
				        
							<li><a href="/categories/并发">并发</a></li>
				        
							<li><a href="/categories/安全">安全</a></li>
				        
							<li><a href="/categories/运维">运维</a></li>
				        
							<li><a href="/categories/数据库">数据库</a></li>
				        
							<li><a href="/categories/云计算">云计算</a></li>
				        
							<li><a href="/categories/编程语言">编程语言</a></li>
				        
							<li><a href="/categories/操作系统">操作系统</a></li>
				        
							<li><a href="/categories/机器学习">机器学习</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/xiehongfeng100" title="github">github</a>
					        
								<a class="linkedin" target="_blank" href="http://cn.linkedin.com/in/xiehongfeng100" title="linkedin">linkedin</a>
					        
								<a class="mail" target="_blank" href="mailto:xiehongfeng100@hotmail.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/tmp/" style="font-size: 10px;">/tmp</a> <a href="/tags/AT-T/" style="font-size: 10px;">AT&T</a> <a href="/tags/Affin/" style="font-size: 10px;">Affin</a> <a href="/tags/Alembic/" style="font-size: 10px;">Alembic</a> <a href="/tags/B-树/" style="font-size: 10px;">B+ 树</a> <a href="/tags/BIOS/" style="font-size: 10px;">BIOS</a> <a href="/tags/Buffer-Pool/" style="font-size: 10px;">Buffer Pool</a> <a href="/tags/C-C/" style="font-size: 16.67px;">C/C++</a> <a href="/tags/CA/" style="font-size: 10px;">CA</a> <a href="/tags/CBOW/" style="font-size: 10px;">CBOW</a> <a href="/tags/CNN/" style="font-size: 10.83px;">CNN</a> <a href="/tags/DHCP/" style="font-size: 10px;">DHCP</a> <a href="/tags/Decorator/" style="font-size: 10px;">Decorator</a> <a href="/tags/Django/" style="font-size: 10px;">Django</a> <a href="/tags/Dnsmasq/" style="font-size: 10px;">Dnsmasq</a> <a href="/tags/ELF/" style="font-size: 10px;">ELF</a> <a href="/tags/ELK/" style="font-size: 10px;">ELK</a> <a href="/tags/Elasticsearch/" style="font-size: 11.67px;">Elasticsearch</a> <a href="/tags/GCC/" style="font-size: 10px;">GCC</a> <a href="/tags/HBR/" style="font-size: 10px;">HBR</a> <a href="/tags/IO-Multiplexing/" style="font-size: 11.67px;">IO Multiplexing</a> <a href="/tags/IPTables/" style="font-size: 10px;">IPTables</a> <a href="/tags/Immunity-Debugger/" style="font-size: 10px;">Immunity Debugger</a> <a href="/tags/InnoDB/" style="font-size: 15.83px;">InnoDB</a> <a href="/tags/KD-Tree/" style="font-size: 10.83px;">KD-Tree</a> <a href="/tags/KNN/" style="font-size: 10px;">KNN</a> <a href="/tags/KVM/" style="font-size: 10px;">KVM</a> <a href="/tags/Kali-Linux/" style="font-size: 10px;">Kali Linux</a> <a href="/tags/Keras/" style="font-size: 10px;">Keras</a> <a href="/tags/Keystone/" style="font-size: 13.33px;">Keystone</a> <a href="/tags/Kibana/" style="font-size: 10px;">Kibana</a> <a href="/tags/Lemmatization/" style="font-size: 10px;">Lemmatization</a> <a href="/tags/Libvirt/" style="font-size: 10.83px;">Libvirt</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/LinuxBridge/" style="font-size: 11.67px;">LinuxBridge</a> <a href="/tags/Logging/" style="font-size: 10px;">Logging</a> <a href="/tags/Logstash/" style="font-size: 10px;">Logstash</a> <a href="/tags/MRO/" style="font-size: 10px;">MRO</a> <a href="/tags/Metasploit-Framwork/" style="font-size: 10px;">Metasploit Framwork</a> <a href="/tags/MySQL/" style="font-size: 16.67px;">MySQL</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/Namespace/" style="font-size: 10px;">Namespace</a> <a href="/tags/Neo4J/" style="font-size: 10.83px;">Neo4J</a> <a href="/tags/Neutron/" style="font-size: 13.33px;">Neutron</a> <a href="/tags/Nova/" style="font-size: 14.17px;">Nova</a> <a href="/tags/OpenStack/" style="font-size: 17.5px;">OpenStack</a> <a href="/tags/OpenVSwitch/" style="font-size: 10px;">OpenVSwitch</a> <a href="/tags/PKI/" style="font-size: 10.83px;">PKI</a> <a href="/tags/PasteDeploy/" style="font-size: 10.83px;">PasteDeploy</a> <a href="/tags/Policy/" style="font-size: 10px;">Policy</a> <a href="/tags/Python/" style="font-size: 18.33px;">Python</a> <a href="/tags/QEMU/" style="font-size: 10px;">QEMU</a> <a href="/tags/RBAC/" style="font-size: 10px;">RBAC</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/Redo-Log/" style="font-size: 10px;">Redo Log</a> <a href="/tags/SQLAlchemy-Migrate/" style="font-size: 10px;">SQLAlchemy-Migrate</a> <a href="/tags/SSL/" style="font-size: 10px;">SSL</a> <a href="/tags/Sigmoid/" style="font-size: 10px;">Sigmoid</a> <a href="/tags/Skip-Gram/" style="font-size: 10px;">Skip-Gram</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Stop-Words/" style="font-size: 10px;">Stop Words</a> <a href="/tags/TCP/" style="font-size: 10px;">TCP</a> <a href="/tags/Tap/" style="font-size: 10.83px;">Tap</a> <a href="/tags/Token/" style="font-size: 11.67px;">Token</a> <a href="/tags/Tokenization/" style="font-size: 10px;">Tokenization</a> <a href="/tags/Trampolining/" style="font-size: 10px;">Trampolining</a> <a href="/tags/Tun/" style="font-size: 10.83px;">Tun</a> <a href="/tags/Tunnel/" style="font-size: 10px;">Tunnel</a> <a href="/tags/UUID/" style="font-size: 10px;">UUID</a> <a href="/tags/Undo-Log/" style="font-size: 10px;">Undo Log</a> <a href="/tags/VNC/" style="font-size: 10px;">VNC</a> <a href="/tags/VPN/" style="font-size: 10px;">VPN</a> <a href="/tags/Veth/" style="font-size: 11.67px;">Veth</a> <a href="/tags/VirtualBox/" style="font-size: 10px;">VirtualBox</a> <a href="/tags/Vlan/" style="font-size: 10px;">Vlan</a> <a href="/tags/Vue/" style="font-size: 10px;">Vue</a> <a href="/tags/WSGI/" style="font-size: 13.33px;">WSGI</a> <a href="/tags/Webob/" style="font-size: 10px;">Webob</a> <a href="/tags/Word2Vec/" style="font-size: 10.83px;">Word2Vec</a> <a href="/tags/Yelper/" style="font-size: 15px;">Yelper</a> <a href="/tags/bootsect/" style="font-size: 10px;">bootsect</a> <a href="/tags/cookiecutter/" style="font-size: 10px;">cookiecutter</a> <a href="/tags/delete/" style="font-size: 10px;">delete</a> <a href="/tags/dnsmasq/" style="font-size: 10px;">dnsmasq</a> <a href="/tags/entry-points/" style="font-size: 10px;">entry_points</a> <a href="/tags/epoll/" style="font-size: 10px;">epoll</a> <a href="/tags/fork/" style="font-size: 10px;">fork</a> <a href="/tags/head/" style="font-size: 10px;">head</a> <a href="/tags/inode/" style="font-size: 10px;">inode</a> <a href="/tags/malloc/" style="font-size: 10px;">malloc</a> <a href="/tags/mona/" style="font-size: 10px;">mona</a> <a href="/tags/new/" style="font-size: 10px;">new</a> <a href="/tags/property/" style="font-size: 10px;">property</a> <a href="/tags/read/" style="font-size: 10px;">read</a> <a href="/tags/routes/" style="font-size: 10px;">routes</a> <a href="/tags/select/" style="font-size: 10px;">select</a> <a href="/tags/setup/" style="font-size: 10px;">setup</a> <a href="/tags/setuptools/" style="font-size: 10px;">setuptools</a> <a href="/tags/shell/" style="font-size: 10.83px;">shell</a> <a href="/tags/stevedore/" style="font-size: 10px;">stevedore</a> <a href="/tags/string/" style="font-size: 10px;">string</a> <a href="/tags/tcpdump/" style="font-size: 10px;">tcpdump</a> <a href="/tags/uWSGI/" style="font-size: 10px;">uWSGI</a> <a href="/tags/update-进程/" style="font-size: 10px;">update 进程</a> <a href="/tags/write/" style="font-size: 10px;">write</a> <a href="/tags/wsgiref/" style="font-size: 10px;">wsgiref</a> <a href="/tags/yield/" style="font-size: 14.17px;">yield</a> <a href="/tags/中断/" style="font-size: 10.83px;">中断</a> <a href="/tags/事务/" style="font-size: 13.33px;">事务</a> <a href="/tags/任务调度/" style="font-size: 10px;">任务调度</a> <a href="/tags/传记/" style="font-size: 10.83px;">传记</a> <a href="/tags/信号/" style="font-size: 10px;">信号</a> <a href="/tags/信号量/" style="font-size: 10px;">信号量</a> <a href="/tags/内存对齐/" style="font-size: 10px;">内存对齐</a> <a href="/tags/内存映射-I-O/" style="font-size: 10px;">内存映射 I/O</a> <a href="/tags/内存规划/" style="font-size: 10px;">内存规划</a> <a href="/tags/内核/" style="font-size: 19.17px;">内核</a> <a href="/tags/内核栈/" style="font-size: 10px;">内核栈</a> <a href="/tags/分页/" style="font-size: 10px;">分页</a> <a href="/tags/加密/" style="font-size: 10.83px;">加密</a> <a href="/tags/加载/" style="font-size: 10.83px;">加载</a> <a href="/tags/协程/" style="font-size: 13.33px;">协程</a> <a href="/tags/可执行目标文件/" style="font-size: 10.83px;">可执行目标文件</a> <a href="/tags/可重定位目标文件/" style="font-size: 10px;">可重定位目标文件</a> <a href="/tags/同步/" style="font-size: 10px;">同步</a> <a href="/tags/商业/" style="font-size: 11.67px;">商业</a> <a href="/tags/地心坐标系/" style="font-size: 10px;">地心坐标系</a> <a href="/tags/多线程/" style="font-size: 10.83px;">多线程</a> <a href="/tags/多进程/" style="font-size: 10px;">多进程</a> <a href="/tags/字符串/" style="font-size: 10px;">字符串</a> <a href="/tags/存储器/" style="font-size: 10.83px;">存储器</a> <a href="/tags/宏/" style="font-size: 10px;">宏</a> <a href="/tags/寄存器/" style="font-size: 10px;">寄存器</a> <a href="/tags/开发环境/" style="font-size: 10px;">开发环境</a> <a href="/tags/异常/" style="font-size: 10px;">异常</a> <a href="/tags/异步/" style="font-size: 10px;">异步</a> <a href="/tags/引导块/" style="font-size: 10px;">引导块</a> <a href="/tags/引导程序/" style="font-size: 12.5px;">引导程序</a> <a href="/tags/归一化/" style="font-size: 10px;">归一化</a> <a href="/tags/微处理器/" style="font-size: 13.33px;">微处理器</a> <a href="/tags/总结/" style="font-size: 10px;">总结</a> <a href="/tags/情感分析/" style="font-size: 10px;">情感分析</a> <a href="/tags/扩容/" style="font-size: 10px;">扩容</a> <a href="/tags/指令集/" style="font-size: 10px;">指令集</a> <a href="/tags/指针/" style="font-size: 12.5px;">指针</a> <a href="/tags/数字签名/" style="font-size: 10px;">数字签名</a> <a href="/tags/数字证书/" style="font-size: 10px;">数字证书</a> <a href="/tags/整数/" style="font-size: 10px;">整数</a> <a href="/tags/文件系统/" style="font-size: 12.5px;">文件系统</a> <a href="/tags/时钟/" style="font-size: 10px;">时钟</a> <a href="/tags/时钟中断/" style="font-size: 10px;">时钟中断</a> <a href="/tags/时间衰减函数/" style="font-size: 10px;">时间衰减函数</a> <a href="/tags/权限/" style="font-size: 10px;">权限</a> <a href="/tags/标准输入/" style="font-size: 10px;">标准输入</a> <a href="/tags/标准输出/" style="font-size: 10px;">标准输出</a> <a href="/tags/标准错误输出/" style="font-size: 10px;">标准错误输出</a> <a href="/tags/栈帧/" style="font-size: 10px;">栈帧</a> <a href="/tags/栈溢出/" style="font-size: 10px;">栈溢出</a> <a href="/tags/根设备/" style="font-size: 10px;">根设备</a> <a href="/tags/死锁/" style="font-size: 10px;">死锁</a> <a href="/tags/母板/" style="font-size: 10px;">母板</a> <a href="/tags/汇编/" style="font-size: 10px;">汇编</a> <a href="/tags/浮点数/" style="font-size: 10px;">浮点数</a> <a href="/tags/消息摘要/" style="font-size: 10px;">消息摘要</a> <a href="/tags/特权级/" style="font-size: 10px;">特权级</a> <a href="/tags/环境变量/" style="font-size: 10px;">环境变量</a> <a href="/tags/生成器/" style="font-size: 14.17px;">生成器</a> <a href="/tags/用户栈/" style="font-size: 10px;">用户栈</a> <a href="/tags/相似度/" style="font-size: 10.83px;">相似度</a> <a href="/tags/硬盘/" style="font-size: 12.5px;">硬盘</a> <a href="/tags/硬链接/" style="font-size: 10px;">硬链接</a> <a href="/tags/管道/" style="font-size: 10px;">管道</a> <a href="/tags/系统调用/" style="font-size: 10px;">系统调用</a> <a href="/tags/索引/" style="font-size: 10px;">索引</a> <a href="/tags/缓冲区/" style="font-size: 10.83px;">缓冲区</a> <a href="/tags/缓冲区溢出/" style="font-size: 10px;">缓冲区溢出</a> <a href="/tags/缺页中断/" style="font-size: 10px;">缺页中断</a> <a href="/tags/网络/" style="font-size: 13.33px;">网络</a> <a href="/tags/翻译/" style="font-size: 14.17px;">翻译</a> <a href="/tags/虚拟地址空间/" style="font-size: 10px;">虚拟地址空间</a> <a href="/tags/虚拟盘/" style="font-size: 10px;">虚拟盘</a> <a href="/tags/请求项/" style="font-size: 10px;">请求项</a> <a href="/tags/质数/" style="font-size: 10px;">质数</a> <a href="/tags/超级块/" style="font-size: 10px;">超级块</a> <a href="/tags/软盘/" style="font-size: 10px;">软盘</a> <a href="/tags/软链接/" style="font-size: 10px;">软链接</a> <a href="/tags/进程派生/" style="font-size: 10px;">进程派生</a> <a href="/tags/进程通信/" style="font-size: 10.83px;">进程通信</a> <a href="/tags/迭代器/" style="font-size: 10px;">迭代器</a> <a href="/tags/金融/" style="font-size: 10px;">金融</a> <a href="/tags/锁/" style="font-size: 10.83px;">锁</a> <a href="/tags/阻塞/" style="font-size: 10.83px;">阻塞</a> <a href="/tags/非阻塞/" style="font-size: 10.83px;">非阻塞</a> <a href="/tags/黑客/" style="font-size: 10px;">黑客</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">谢宏峰，毕业于暨南大学（2009 - 2013）、中国科学院（2013 - 2016），现就职于深信服科技，从事 OpenStack 开发。</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Max</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/img/author.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Max</h1>
			</hgroup>
			
			<p class="header-subtitle">Stay hungry, stay foolish.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/categories/读书">读书</a></li>
		        
					<li><a href="/tags/翻译">翻译</a></li>
		        
					<li><a href="/categories/网络">网络</a></li>
		        
					<li><a href="/categories/并发">并发</a></li>
		        
					<li><a href="/categories/安全">安全</a></li>
		        
					<li><a href="/categories/运维">运维</a></li>
		        
					<li><a href="/categories/数据库">数据库</a></li>
		        
					<li><a href="/categories/云计算">云计算</a></li>
		        
					<li><a href="/categories/编程语言">编程语言</a></li>
		        
					<li><a href="/categories/操作系统">操作系统</a></li>
		        
					<li><a href="/categories/机器学习">机器学习</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/xiehongfeng100" title="github">github</a>
			        
						<a class="linkedin" target="_blank" href="http://cn.linkedin.com/in/xiehongfeng100" title="linkedin">linkedin</a>
			        
						<a class="mail" target="_blank" href="mailto:xiehongfeng100@hotmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-openstack-keystone-token-authentication" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/09/openstack-keystone-token-authentication/" class="article-date">
  	<time datetime="2017-06-08T22:09:28.000Z" itemprop="datePublished">2017-06-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      OpenStack 源码系列之 Keystone：Token 认证
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Keystone/">Keystone</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenStack/">OpenStack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Token/">Token</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/云计算/">云计算</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在上一篇博文中我们已经简要介绍了 Keystone，该篇就重点介绍 Keystone Token（Scoped）认证的流程。</p>
<p>有一张图很好概括了 Keystone 的工作流程（图的原始来源目前尚未找到）：</p>
<p><img src="/images/cloud-computation/openstack/keystone/keystone-authentication/keystone_workflow.png" alt>  </p>
<p>下边我们主要介绍该图虚拟机创建前的流程。</p>
<a id="more"></a>
<h1 id="获取-Token"><a href="#获取-Token" class="headerlink" title="获取 Token"></a><strong>获取 Token</strong></h1><p><strong>注：</strong>因写作本文时，手头尚无搭建好的 OpenStack 用于实验，所以获取 Token 部分的例子摘录自博文 <a href="http://www.tralon.com/2015/01/keysone%E5%B7%A5%E4%BD%9C%E6%B5%81/" target="_blank" rel="noopener">OpenStack Keystone 工作流</a></p>
<h2 id="获取临时-Token"><a href="#获取临时-Token" class="headerlink" title="获取临时 Token"></a><strong>获取临时 Token</strong></h2><p>假设我们已经在 OpenStack 创建了用户和相应的租户，那我们可以通过用户名密码获得临时 Token：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">示例请求：</span><br><span class="line">POST http://<span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">5000</span>/v2<span class="number">.0</span>/tokens</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"auth"</span>: &#123;</span><br><span class="line">		<span class="string">"passwordCredentials"</span>: &#123;</span><br><span class="line">			<span class="string">"username"</span>: <span class="string">"demo"</span>,</span><br><span class="line">			<span class="string">"password"</span>: <span class="string">"rootroot"</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">示例响应：</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"access"</span>: &#123;</span><br><span class="line">		<span class="string">"token"</span>: &#123;</span><br><span class="line">			<span class="string">"issued_at"</span>: <span class="string">"2015-01-04T14:23:33.501946"</span>,</span><br><span class="line">			<span class="string">"expires"</span>: <span class="string">"2015-01-04T15:23:33Z"</span>,</span><br><span class="line">			<span class="string">"id"</span>: <span class="string">"a19bc13b46ba459cb3104fa97e414a27"</span>,</span><br><span class="line">			<span class="string">"audit_ids"</span>: [<span class="string">"KA6wWhLFQWGMRpoCv1VYpQ"</span>]</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">"serviceCatalog"</span>: [],</span><br><span class="line">		<span class="string">"user"</span>: &#123;</span><br><span class="line">			<span class="string">"username"</span>: <span class="string">"demo"</span>,</span><br><span class="line">			<span class="string">"roles_links"</span>: [],</span><br><span class="line">			<span class="string">"id"</span>: <span class="string">"f8b9c7807d95484fa829cdb68b410e77"</span>,</span><br><span class="line">			<span class="string">"roles"</span>: [],</span><br><span class="line">			<span class="string">"name"</span>: <span class="string">"demo"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">"metadata"</span>: &#123;</span><br><span class="line">			<span class="string">"is_admin"</span>: <span class="number">0</span>,</span><br><span class="line">			<span class="string">"roles"</span>: []</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="获取用户可以访问的租户"><a href="#获取用户可以访问的租户" class="headerlink" title="获取用户可以访问的租户"></a><strong>获取用户可以访问的租户</strong></h2><p>这里其实有个疑问，就是既然已经拿到了（临时） Token 了，直接用这个 Token 去访问资源（list servers）不就行了吗，为什么还要获取用户的租户？</p>
<p>看起来可行，实际却不可行，主要原因如下：</p>
<ul>
<li>本质上，租户才是资源的集合，用户要有获取资源的权限，必须绑定到具体的租户上；而且在 OpenStack 中，一个用户可以对应于多个租户，在访问资源时必须指出要访问哪个租户的资源。以上所获取到的临时 Token 其实是一个 Unscoped Token，也即没有租户（及域）信息的 Token。所以，为了能够访问到具体租户的资源，需要找出该用户的租户，然后选择一个租户再次请求一个 Scoped Token，这样才可以访问该租户的资源。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET http://<span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">5000</span>/v2<span class="number">.0</span>/tenants</span><br><span class="line">HEADERS[<span class="string">"X-Auth-Token"</span>:<span class="string">"a19bc13b46ba459cb3104fa97e414a27"</span>]</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"tenants_links"</span>: [],</span><br><span class="line">	<span class="string">"tenants"</span>: [&#123;</span><br><span class="line">		<span class="string">"description"</span>: null,</span><br><span class="line">		<span class="string">"enabled"</span>: true,</span><br><span class="line">		<span class="string">"id"</span>: <span class="string">"0e877c09c1924963800c7534bc03106e"</span>,</span><br><span class="line">		<span class="string">"parent_id"</span>: null,</span><br><span class="line">		<span class="string">"name"</span>: <span class="string">"demo"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="string">"description"</span>: null,</span><br><span class="line">		<span class="string">"enabled"</span>: true,</span><br><span class="line">		<span class="string">"id"</span>: <span class="string">"2b6f4d3001e841e9924c8278a8a745db"</span>,</span><br><span class="line">		<span class="string">"parent_id"</span>: null,</span><br><span class="line">		<span class="string">"name"</span>: <span class="string">"invisible_to_admin"</span></span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="获取指定租户的-Token"><a href="#获取指定租户的-Token" class="headerlink" title="获取指定租户的 Token"></a><strong>获取指定租户的 Token</strong></h2><p>这里<strong>最重要</strong>的一点在于获取到的 Token 包含了资源的<code>服务目录（Service Catalog）</code>。其中重要的是 <code>端点（Endpoints）</code>，也即 OpenStack 各 API 服务（如 nova-api）的 URL（由这些 URL 可以路由到对应的后台服务，进而访问资源）。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">示例请求：</span><br><span class="line">POST http://<span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">5000</span>/v2<span class="number">.0</span>/tokens</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"auth"</span>: &#123;</span><br><span class="line">		<span class="string">"tenantName"</span>: <span class="string">"demo"</span>,</span><br><span class="line">		<span class="string">"passwordCredentials"</span>: &#123;</span><br><span class="line">			<span class="string">"username"</span>: <span class="string">"demo"</span>,</span><br><span class="line">			<span class="string">"password"</span>: <span class="string">"rootroot"</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">示例响应：</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"access"</span>: &#123;</span><br><span class="line">		<span class="string">"token"</span>: &#123;</span><br><span class="line">			<span class="string">"issued_at"</span>: <span class="string">"2015-01-04T14:30:42.669320"</span>,</span><br><span class="line">			<span class="string">"expires"</span>: <span class="string">"2015-01-04T15:30:42Z"</span>,</span><br><span class="line">			<span class="string">"id"</span>: <span class="string">"f84bd18554bd4e49b147293ccbabdae2"</span>,</span><br><span class="line">			<span class="string">"tenant"</span>: &#123;</span><br><span class="line">				<span class="string">"description"</span>: null,</span><br><span class="line">				<span class="string">"enabled"</span>: true,</span><br><span class="line">				<span class="string">"id"</span>: <span class="string">"0e877c09c1924963800c7534bc03106e"</span>,</span><br><span class="line">				<span class="string">"parent_id"</span>: null,</span><br><span class="line">				<span class="string">"name"</span>: <span class="string">"demo"</span></span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">"audit_ids"</span>: [<span class="string">"DnJZAdncS7KX-N5M02Q-Ew"</span>]</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">"serviceCatalog"</span>: [&#123;</span><br><span class="line">			<span class="string">"endpoints"</span>: [&#123;</span><br><span class="line">				<span class="string">"adminURL"</span>: <span class="string">"http://192.168.56.2:8774/v2/0e877c09c1924963800c7534bc03106e"</span>,</span><br><span class="line">				<span class="string">"region"</span>: <span class="string">"RegionOne"</span>,</span><br><span class="line">				<span class="string">"internalURL"</span>: <span class="string">"http://192.168.56.2:8774/v2/0e877c09c1924963800c7534bc03106e"</span>,</span><br><span class="line">				<span class="string">"id"</span>: <span class="string">"470f1cc24a1544d388b5f8312cb5e512"</span>,</span><br><span class="line">				<span class="string">"publicURL"</span>: <span class="string">"http://192.168.56.2:8774/v2/0e877c09c1924963800c7534bc03106e"</span></span><br><span class="line">			&#125;],</span><br><span class="line">			<span class="string">"endpoints_links"</span>: [],</span><br><span class="line">			<span class="string">"type"</span>: <span class="string">"compute"</span>,</span><br><span class="line">			<span class="string">"name"</span>: <span class="string">"nova"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"endpoints"</span>: [&#123;</span><br><span class="line">				<span class="string">"adminURL"</span>: <span class="string">"http://192.168.56.2:9696/"</span>,</span><br><span class="line">				<span class="string">"region"</span>: <span class="string">"RegionOne"</span>,</span><br><span class="line">				<span class="string">"internalURL"</span>: <span class="string">"http://192.168.56.2:9696/"</span>,</span><br><span class="line">				<span class="string">"id"</span>: <span class="string">"36c9fd04cda04a3f8e30771549343052"</span>,</span><br><span class="line">				<span class="string">"publicURL"</span>: <span class="string">"http://192.168.56.2:9696/"</span></span><br><span class="line">			&#125;],</span><br><span class="line">			<span class="string">"endpoints_links"</span>: [],</span><br><span class="line">			<span class="string">"type"</span>: <span class="string">"network"</span>,</span><br><span class="line">			<span class="string">"name"</span>: <span class="string">"neutron"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"endpoints"</span>: [&#123;</span><br><span class="line">				<span class="string">"adminURL"</span>: <span class="string">"http://192.168.56.2:8776/v2/0e877c09c1924963800c7534bc03106e"</span>,</span><br><span class="line">				<span class="string">"region"</span>: <span class="string">"RegionOne"</span>,</span><br><span class="line">				<span class="string">"internalURL"</span>: <span class="string">"http://192.168.56.2:8776/v2/0e877c09c1924963800c7534bc03106e"</span>,</span><br><span class="line">				<span class="string">"id"</span>: <span class="string">"48a15d71e8af4370b145b9db7d3f197c"</span>,</span><br><span class="line">				<span class="string">"publicURL"</span>: <span class="string">"http://192.168.56.2:8776/v2/0e877c09c1924963800c7534bc03106e"</span></span><br><span class="line">			&#125;],</span><br><span class="line">			<span class="string">"endpoints_links"</span>: [],</span><br><span class="line">			<span class="string">"type"</span>: <span class="string">"volumev2"</span>,</span><br><span class="line">			<span class="string">"name"</span>: <span class="string">"cinderv2"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"endpoints"</span>: [&#123;</span><br><span class="line">				<span class="string">"adminURL"</span>: <span class="string">"http://192.168.56.2:3333"</span>,</span><br><span class="line">				<span class="string">"region"</span>: <span class="string">"RegionOne"</span>,</span><br><span class="line">				<span class="string">"internalURL"</span>: <span class="string">"http://192.168.56.2:3333"</span>,</span><br><span class="line">				<span class="string">"id"</span>: <span class="string">"ae6067b19be947f3a21d7b1e5f141353"</span>,</span><br><span class="line">				<span class="string">"publicURL"</span>: <span class="string">"http://192.168.56.2:3333"</span></span><br><span class="line">			&#125;],</span><br><span class="line">			<span class="string">"endpoints_links"</span>: [],</span><br><span class="line">			<span class="string">"type"</span>: <span class="string">"s3"</span>,</span><br><span class="line">			<span class="string">"name"</span>: <span class="string">"s3"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"endpoints"</span>: [&#123;</span><br><span class="line">				<span class="string">"adminURL"</span>: <span class="string">"http://192.168.56.2:9292"</span>,</span><br><span class="line">				<span class="string">"region"</span>: <span class="string">"RegionOne"</span>,</span><br><span class="line">				<span class="string">"internalURL"</span>: <span class="string">"http://192.168.56.2:9292"</span>,</span><br><span class="line">				<span class="string">"id"</span>: <span class="string">"280059b3597b4274b36b16ecea4b8fff"</span>,</span><br><span class="line">				<span class="string">"publicURL"</span>: <span class="string">"http://192.168.56.2:9292"</span></span><br><span class="line">			&#125;],</span><br><span class="line">			<span class="string">"endpoints_links"</span>: [],</span><br><span class="line">			<span class="string">"type"</span>: <span class="string">"image"</span>,</span><br><span class="line">			<span class="string">"name"</span>: <span class="string">"glance"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"endpoints"</span>: [&#123;</span><br><span class="line">				<span class="string">"adminURL"</span>: <span class="string">"http://192.168.56.2:8776/v1/0e877c09c1924963800c7534bc03106e"</span>,</span><br><span class="line">				<span class="string">"region"</span>: <span class="string">"RegionOne"</span>,</span><br><span class="line">				<span class="string">"internalURL"</span>: <span class="string">"http://192.168.56.2:8776/v1/0e877c09c1924963800c7534bc03106e"</span>,</span><br><span class="line">				<span class="string">"id"</span>: <span class="string">"0bd31fcde6fe4272b11cd97c79ff4d17"</span>,</span><br><span class="line">				<span class="string">"publicURL"</span>: <span class="string">"http://192.168.56.2:8776/v1/0e877c09c1924963800c7534bc03106e"</span></span><br><span class="line">			&#125;],</span><br><span class="line">			<span class="string">"endpoints_links"</span>: [],</span><br><span class="line">			<span class="string">"type"</span>: <span class="string">"volume"</span>,</span><br><span class="line">			<span class="string">"name"</span>: <span class="string">"cinder"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"endpoints"</span>: [&#123;</span><br><span class="line">				<span class="string">"adminURL"</span>: <span class="string">"http://192.168.56.2:8773/services/Admin"</span>,</span><br><span class="line">				<span class="string">"region"</span>: <span class="string">"RegionOne"</span>,</span><br><span class="line">				<span class="string">"internalURL"</span>: <span class="string">"http://192.168.56.2:8773/services/Cloud"</span>,</span><br><span class="line">				<span class="string">"id"</span>: <span class="string">"02fe3abc06f1492089ef100f63299631"</span>,</span><br><span class="line">				<span class="string">"publicURL"</span>: <span class="string">"http://192.168.56.2:8773/services/Cloud"</span></span><br><span class="line">			&#125;],</span><br><span class="line">			<span class="string">"endpoints_links"</span>: [],</span><br><span class="line">			<span class="string">"type"</span>: <span class="string">"ec2"</span>,</span><br><span class="line">			<span class="string">"name"</span>: <span class="string">"ec2"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"endpoints"</span>: [&#123;</span><br><span class="line">				<span class="string">"adminURL"</span>: <span class="string">"http://192.168.56.2:8774/v2.1/0e877c09c1924963800c7534bc03106e"</span>,</span><br><span class="line">				<span class="string">"region"</span>: <span class="string">"RegionOne"</span>,</span><br><span class="line">				<span class="string">"internalURL"</span>: <span class="string">"http://192.168.56.2:8774/v2.1/0e877c09c1924963800c7534bc03106e"</span>,</span><br><span class="line">				<span class="string">"id"</span>: <span class="string">"86ead91555a44de285f94957c05200ac"</span>,</span><br><span class="line">				<span class="string">"publicURL"</span>: <span class="string">"http://192.168.56.2:8774/v2.1/0e877c09c1924963800c7534bc03106e"</span></span><br><span class="line">			&#125;],</span><br><span class="line">			<span class="string">"endpoints_links"</span>: [],</span><br><span class="line">			<span class="string">"type"</span>: <span class="string">"computev21"</span>,</span><br><span class="line">			<span class="string">"name"</span>: <span class="string">"novav21"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"endpoints"</span>: [&#123;</span><br><span class="line">				<span class="string">"adminURL"</span>: <span class="string">"http://192.168.56.2:35357/v2.0"</span>,</span><br><span class="line">				<span class="string">"region"</span>: <span class="string">"RegionOne"</span>,</span><br><span class="line">				<span class="string">"internalURL"</span>: <span class="string">"http://192.168.56.2:5000/v2.0"</span>,</span><br><span class="line">				<span class="string">"id"</span>: <span class="string">"19885c4b7ed7403eb6bec641b7105443"</span>,</span><br><span class="line">				<span class="string">"publicURL"</span>: <span class="string">"http://192.168.56.2:5000/v2.0"</span></span><br><span class="line">			&#125;],</span><br><span class="line">			<span class="string">"endpoints_links"</span>: [],</span><br><span class="line">			<span class="string">"type"</span>: <span class="string">"identity"</span>,</span><br><span class="line">			<span class="string">"name"</span>: <span class="string">"keystone"</span></span><br><span class="line">		&#125;],</span><br><span class="line">		<span class="string">"user"</span>: &#123;</span><br><span class="line">			<span class="string">"username"</span>: <span class="string">"demo"</span>,</span><br><span class="line">			<span class="string">"roles_links"</span>: [],</span><br><span class="line">			<span class="string">"id"</span>: <span class="string">"f8b9c7807d95484fa829cdb68b410e77"</span>,</span><br><span class="line">			<span class="string">"roles"</span>: [&#123;</span><br><span class="line">				<span class="string">"name"</span>: <span class="string">"_member_"</span></span><br><span class="line">			&#125;,</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="string">"name"</span>: <span class="string">"Member"</span></span><br><span class="line">			&#125;,</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="string">"name"</span>: <span class="string">"anotherrole"</span></span><br><span class="line">			&#125;],</span><br><span class="line">			<span class="string">"name"</span>: <span class="string">"demo"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">"metadata"</span>: &#123;</span><br><span class="line">			<span class="string">"is_admin"</span>: <span class="number">0</span>,</span><br><span class="line">			<span class="string">"roles"</span>: [<span class="string">"9fe2ff9ee4384b1894a90878d3e92bab"</span>,</span><br><span class="line">			<span class="string">"1fa59496fd6b4b07b4ce23a5ee8a3a0b"</span>,</span><br><span class="line">			<span class="string">"89764090d30949acaf9da2f9e0887ec6"</span>]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来，我们就可以通过 URL 列出所有虚拟机：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET http://<span class="number">192.168</span><span class="number">.56</span><span class="number">.2</span>:<span class="number">8774</span>/v2/<span class="number">0e877</span>c09c1924963800c7534bc03106e/servers</span><br><span class="line">HEADERS[<span class="string">"X-Auth-Token"</span>:<span class="string">"a19bc13b46ba459cb3104fa97e414a27"</span>]</span><br><span class="line">......</span><br></pre></td></tr></table></figure></p>
<p>那 Keystone 是怎么认证这个随请求一起发过来的 Token 呢？请看下文</p>
<h1 id="Token-认证源码分析"><a href="#Token-认证源码分析" class="headerlink" title="Token 认证源码分析"></a><strong>Token 认证源码分析</strong></h1><p>其实，我们要是去 Keystone 源码中找 Token 认证（不是 CRUD）相关的代码还是真的找不到，拿这一块代码在哪里呢？且让我们来看看 Nova 的 PasteDeploy 配置文件：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[composite:osapi_compute]</span><br><span class="line">use = call:nova.api.openstack.urlmap:urlmap_factory</span><br><span class="line">/: oscomputeversions</span><br><span class="line">/v2: openstack_compute_api_v21_legacy_v2_compatible</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[composite:openstack_compute_api_v21_legacy_v2_compatible]</span><br><span class="line">use = call:nova.api.auth:pipeline_factory_v21</span><br><span class="line">......</span><br><span class="line">keystone = ... authtoken keystonecontext ...</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[filter:keystonecontext]</span><br><span class="line">paste.filter_factory = nova.api.auth:NovaKeystoneContext.factory</span><br><span class="line"></span><br><span class="line">[filter:authtoken]</span><br><span class="line">paste.filter_factory = keystonemiddleware.auth_token:filter_factory</span><br></pre></td></tr></table></figure></p>
<p>从这个配置文件中，当 Nova 的认证方式为 keystone（在 /etc/nova/nova.conf 中指定）时，Token 的认证是通过 keystonemiddleware 模块来进行的。当然，keystonemiddleware 需要到 keystone 模块获取 Token 的详细信息。所以，大家可以看出，如果每个模块都选择了 keystone 认证，那对这些模块的请求都需要走一次 Token 认证，这对 Keystone 模块的压力是比较大的。</p>
<p>下边就让我们进入源码分析（不会很细，重在流程）。</p>
<h2 id="keystonemiddleware"><a href="#keystonemiddleware" class="headerlink" title="keystonemiddleware"></a><strong>keystonemiddleware</strong></h2><p><code>keystonemiddleware/auth_token/__init__.py</code> 文件对 keystonemiddleware 的功能已经介绍的相当明了：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Token-based Authentication Middleware.</span><br><span class="line"></span><br><span class="line">This WSGI component:</span><br><span class="line"></span><br><span class="line">* Verifies that incoming client requests have valid tokens by validating</span><br><span class="line">  tokens <span class="keyword">with</span> the auth service.</span><br><span class="line">* Rejects unauthenticated requests unless the auth_token middleware <span class="keyword">is</span> <span class="keyword">in</span></span><br><span class="line">  ``delay_auth_decision`` mode, which means the final decision <span class="keyword">is</span> delegated to</span><br><span class="line">  the downstream WSGI component (usually the OpenStack service).</span><br><span class="line">* Collects <span class="keyword">and</span> forwards identity information based on a valid token</span><br><span class="line">  such <span class="keyword">as</span> user name, domain, project, etc.</span><br></pre></td></tr></table></figure></p>
<p>也即，keystonemiddleware（本身是也一个 WSGI 应用）：</p>
<ol>
<li>验证 Token 是否合法</li>
<li>拒绝非法请求（除非该中间件处于 delay_auth_decision 模式）</li>
<li>收集并转发合法 Token 的信息（如用户名）</li>
</ol>
<p>该中间件接受两种类型的 Token，即 auth_token 和 service_token。这里我们只关注前者。</p>
<p>另外，我们还可以参考官方的文档：</p>
<ul>
<li><a href="https://docs.openstack.org/developer/keystonemiddleware/middlewarearchitecture.html" target="_blank" rel="noopener">Middleware Architecture</a></li>
<li><a href="https://docs.openstack.org/developer/keystonemiddleware/api/keystonemiddleware.auth_token.html#module-keystonemiddleware.auth_token" target="_blank" rel="noopener">keystonemiddleware.auth_token package</a></li>
</ul>
<hr>
<p>接下来，我们来看一下源码骨架：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># keystonemiddleware/auth_token/__init__.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseAuthProtocol</span><span class="params">(object)</span>:</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line"><span class="meta">    @webob.dec.wsgify(RequestClass=_request._AuthTokenRequest)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, req)</span>:</span></span><br><span class="line">        <span class="string">"""Handle incoming request."""</span></span><br><span class="line">        response = self.process_request(req)</span><br><span class="line">        <span class="keyword">if</span> response:</span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">        response = req.get_response(self._app)</span><br><span class="line">        <span class="keyword">return</span> self.process_response(response)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="string">"""Process request.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        If this method returns a value then that value will be used as the</span></span><br><span class="line"><span class="string">        response. The next application down the stack will not be executed and</span></span><br><span class="line"><span class="string">        process_response will not be called.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Otherwise, the next application down the stack will be executed and</span></span><br><span class="line"><span class="string">        process_response will be called with the generated response.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        By default this method does not return a value.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param request: Incoming request</span></span><br><span class="line"><span class="string">        :type request: _request.AuthTokenRequest</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        user_auth_ref = <span class="literal">None</span></span><br><span class="line">        serv_auth_ref = <span class="literal">None</span></span><br><span class="line">        allow_expired = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> request.service_token:</span><br><span class="line">            self.log.debug(<span class="string">'Authenticating service token'</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                _, serv_auth_ref = self._do_fetch_token(request.service_token)</span><br><span class="line">                self._validate_token(serv_auth_ref)</span><br><span class="line">                self._confirm_token_bind(serv_auth_ref, request)</span><br><span class="line">            <span class="keyword">except</span> ksm_exceptions.InvalidToken:</span><br><span class="line">                self.log.info(<span class="string">'Invalid service token'</span>)</span><br><span class="line">                request.service_token_valid = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># FIXME(jamielennox): The new behaviour for service tokens is</span></span><br><span class="line">                <span class="comment"># that they have to pass the policy check to be allowed.</span></span><br><span class="line">                <span class="comment"># Previously any token was accepted here. For now we will</span></span><br><span class="line">                <span class="comment"># continue to mark service tokens as valid if they are valid</span></span><br><span class="line">                <span class="comment"># but we will only allow service role tokens to do</span></span><br><span class="line">                <span class="comment"># allow_expired. In future we should reject any token that</span></span><br><span class="line">                <span class="comment"># isn't a service token here.</span></span><br><span class="line">                role_names = set(serv_auth_ref.role_names)</span><br><span class="line">                check = self._service_token_roles.intersection(role_names)</span><br><span class="line">                role_check_passed = bool(check)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># if service_token_role_required then the service token is only</span></span><br><span class="line">                <span class="comment"># valid if the roles check out. Otherwise at this point it is</span></span><br><span class="line">                <span class="comment"># true because keystone has already validated it.</span></span><br><span class="line">                <span class="keyword">if</span> self._service_token_roles_required:</span><br><span class="line">                    request.service_token_valid = role_check_passed</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> self._service_token_warning_emitted:</span><br><span class="line">                        self.log.warning(<span class="string">'A valid token was submitted as '</span></span><br><span class="line">                                         <span class="string">'a service token, but it was not '</span></span><br><span class="line">                                         <span class="string">'a valid service token. This is '</span></span><br><span class="line">                                         <span class="string">'incorrect but backwards '</span></span><br><span class="line">                                         <span class="string">'compatible behaviour. This will '</span></span><br><span class="line">                                         <span class="string">'be removed in future releases.'</span>)</span><br><span class="line">                        <span class="comment"># prevent log spam on every single request</span></span><br><span class="line">                        self._service_token_warning_emitted = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                    request.service_token_valid = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># allow_expired always requires passing the role check.</span></span><br><span class="line">                allow_expired = role_check_passed</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> request.user_token:</span><br><span class="line">            self.log.debug(<span class="string">'Authenticating user token'</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data, user_auth_ref = self._do_fetch_token(</span><br><span class="line">                    request.user_token,</span><br><span class="line">                    allow_expired=allow_expired)</span><br><span class="line">                self._validate_token(user_auth_ref,</span><br><span class="line">                                     allow_expired=allow_expired)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> request.service_token:</span><br><span class="line">                    self._confirm_token_bind(user_auth_ref, request)</span><br><span class="line">            <span class="keyword">except</span> ksm_exceptions.InvalidToken:</span><br><span class="line">                self.log.info(<span class="string">'Invalid user token'</span>)</span><br><span class="line">                request.user_token_valid = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                request.user_token_valid = <span class="literal">True</span></span><br><span class="line">                request.token_info = data</span><br><span class="line"></span><br><span class="line">        request.token_auth = _user_plugin.UserAuthPlugin(user_auth_ref,</span><br><span class="line">                                                         serv_auth_ref)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthProtocol</span><span class="params">(BaseAuthProtocol)</span>:</span></span><br><span class="line">    <span class="string">"""Middleware that handles authenticating client calls."""</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="string">"""Process request.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Evaluate the headers in a request and attempt to authenticate the</span></span><br><span class="line"><span class="string">        request. If authenticated then additional headers are added to the</span></span><br><span class="line"><span class="string">        request for use by applications. If not authenticated the request will</span></span><br><span class="line"><span class="string">        be rejected or marked unauthenticated depending on configuration.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        request.remove_auth_headers()</span><br><span class="line">        self._token_cache.initialize(request.environ)</span><br><span class="line"></span><br><span class="line">        resp = super(AuthProtocol, self).process_request(request)</span><br><span class="line">        <span class="keyword">if</span> resp:</span><br><span class="line">            <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.user_token:</span><br><span class="line">            <span class="comment"># if no user token is present then that's an invalid request</span></span><br><span class="line">            request.user_token_valid = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># NOTE(jamielennox): The service status is allowed to be missing if a</span></span><br><span class="line">        <span class="comment"># service token is not passed. If the service status is missing that's</span></span><br><span class="line">        <span class="comment"># a valid request. We should find a better way to expose this from the</span></span><br><span class="line">        <span class="comment"># request object.</span></span><br><span class="line">        user_status = request.user_token <span class="keyword">and</span> request.user_token_valid</span><br><span class="line">        service_status = request.headers.get(<span class="string">'X-Service-Identity-Status'</span>,</span><br><span class="line">                                             <span class="string">'Confirmed'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (user_status <span class="keyword">and</span> service_status == <span class="string">'Confirmed'</span>):</span><br><span class="line">            <span class="keyword">if</span> self._delay_auth_decision:</span><br><span class="line">                self.log.debug(<span class="string">'Deferring reject downstream'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.log.info(<span class="string">'Rejecting request'</span>)</span><br><span class="line">                message = _(<span class="string">'The request you have made requires '</span></span><br><span class="line">                            <span class="string">'authentication.'</span>)</span><br><span class="line">                body = &#123;<span class="string">'error'</span>: &#123;</span><br><span class="line">                    <span class="string">'code'</span>: <span class="number">401</span>,</span><br><span class="line">                    <span class="string">'title'</span>: <span class="string">'Unauthorized'</span>,</span><br><span class="line">                    <span class="string">'message'</span>: message,</span><br><span class="line">                &#125;&#125;</span><br><span class="line">                <span class="keyword">raise</span> webob.exc.HTTPUnauthorized(</span><br><span class="line">                    body=jsonutils.dumps(body),</span><br><span class="line">                    headers=self._reject_auth_headers,</span><br><span class="line">                    charset=<span class="string">'UTF-8'</span>,</span><br><span class="line">                    content_type=<span class="string">'application/json'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> request.user_token_valid:</span><br><span class="line">            request.set_user_headers(request.token_auth.user)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> self._include_service_catalog:</span><br><span class="line">                request.set_service_catalog_headers(request.token_auth.user)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> request.token_auth:</span><br><span class="line">            request.token_auth._auth = self._auth</span><br><span class="line">            request.token_auth._session = self._session</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> request.service_token <span class="keyword">and</span> request.service_token_valid:</span><br><span class="line">            request.set_service_headers(request.token_auth.service)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.log.isEnabledFor(logging.DEBUG):</span><br><span class="line">            self.log.debug(<span class="string">'Received request from %s'</span>,</span><br><span class="line">                           request.token_auth._log_format)</span><br></pre></td></tr></table></figure></p>
<h3 id="1-去除请求中跟认证相关的头部"><a href="#1-去除请求中跟认证相关的头部" class="headerlink" title="1. 去除请求中跟认证相关的头部"></a><strong>1. 去除请求中跟认证相关的头部</strong></h3><p>为了防止伪造认证的请求，去除掉跟认证信息相关的头部是非常有必要的，请看详细：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># keystonemiddleware/auth_token/__init__.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthProtocol</span><span class="params">(BaseAuthProtocol)</span>:</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="string">"""Process request.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Evaluate the headers in a request and attempt to authenticate the</span></span><br><span class="line"><span class="string">        request. If authenticated then additional headers are added to the</span></span><br><span class="line"><span class="string">        request for use by applications. If not authenticated the request will</span></span><br><span class="line"><span class="string">        be rejected or marked unauthenticated depending on configuration.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        request.remove_auth_headers()</span><br><span class="line">        self._token_cache.initialize(request.environ)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># keystonemiddleware/auth_token/_request.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_AuthTokenRequest</span><span class="params">(webob.Request)</span>:</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    _HEADER_TEMPLATE = &#123;</span><br><span class="line">        <span class="string">'X%s-Domain-Id'</span>: <span class="string">'domain_id'</span>,</span><br><span class="line">        <span class="string">'X%s-Domain-Name'</span>: <span class="string">'domain_name'</span>,</span><br><span class="line">        <span class="string">'X%s-Project-Id'</span>: <span class="string">'project_id'</span>,</span><br><span class="line">        <span class="string">'X%s-Project-Name'</span>: <span class="string">'project_name'</span>,</span><br><span class="line">        <span class="string">'X%s-Project-Domain-Id'</span>: <span class="string">'project_domain_id'</span>,</span><br><span class="line">        <span class="string">'X%s-Project-Domain-Name'</span>: <span class="string">'project_domain_name'</span>,</span><br><span class="line">        <span class="string">'X%s-User-Id'</span>: <span class="string">'user_id'</span>,</span><br><span class="line">        <span class="string">'X%s-User-Name'</span>: <span class="string">'username'</span>,</span><br><span class="line">        <span class="string">'X%s-User-Domain-Id'</span>: <span class="string">'user_domain_id'</span>,</span><br><span class="line">        <span class="string">'X%s-User-Domain-Name'</span>: <span class="string">'user_domain_name'</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _ROLES_TEMPLATE = <span class="string">'X%s-Roles'</span></span><br><span class="line"></span><br><span class="line">    _USER_HEADER_PREFIX = <span class="string">''</span></span><br><span class="line">    _SERVICE_HEADER_PREFIX = <span class="string">'-Service'</span></span><br><span class="line"></span><br><span class="line">    _USER_STATUS_HEADER = <span class="string">'X-Identity-Status'</span></span><br><span class="line">    _SERVICE_STATUS_HEADER = <span class="string">'X-Service-Identity-Status'</span></span><br><span class="line"></span><br><span class="line">    _ADMIN_PROJECT_HEADER = <span class="string">'X-Is-Admin-Project'</span></span><br><span class="line"></span><br><span class="line">    _SERVICE_CATALOG_HEADER = <span class="string">'X-Service-Catalog'</span></span><br><span class="line">    _TOKEN_AUTH = <span class="string">'keystone.token_auth'</span></span><br><span class="line">    _TOKEN_INFO = <span class="string">'keystone.token_info'</span></span><br><span class="line"></span><br><span class="line">    _CONFIRMED = <span class="string">'Confirmed'</span></span><br><span class="line">    _INVALID = <span class="string">'Invalid'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># header names that have been deprecated in favour of something else.</span></span><br><span class="line">    _DEPRECATED_HEADER_MAP = &#123;</span><br><span class="line">        <span class="string">'X-Role'</span>: <span class="string">'X-Roles'</span>,</span><br><span class="line">        <span class="string">'X-User'</span>: <span class="string">'X-User-Name'</span>,</span><br><span class="line">        <span class="string">'X-Tenant-Id'</span>: <span class="string">'X-Project-Id'</span>,</span><br><span class="line">        <span class="string">'X-Tenant-Name'</span>: <span class="string">'X-Project-Name'</span>,</span><br><span class="line">        <span class="string">'X-Tenant'</span>: <span class="string">'X-Project-Name'</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_all_auth_headers</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""All the authentication headers that can be set on the request."""</span></span><br><span class="line">        <span class="keyword">yield</span> self._SERVICE_CATALOG_HEADER</span><br><span class="line">        <span class="keyword">yield</span> self._USER_STATUS_HEADER</span><br><span class="line">        <span class="keyword">yield</span> self._SERVICE_STATUS_HEADER</span><br><span class="line">        <span class="keyword">yield</span> self._ADMIN_PROJECT_HEADER</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> header <span class="keyword">in</span> self._DEPRECATED_HEADER_MAP:</span><br><span class="line">            <span class="keyword">yield</span> header</span><br><span class="line"></span><br><span class="line">        prefixes = (self._USER_HEADER_PREFIX, self._SERVICE_HEADER_PREFIX)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> tmpl, prefix <span class="keyword">in</span> itertools.product(self._HEADER_TEMPLATE, prefixes):</span><br><span class="line">            <span class="keyword">yield</span> tmpl % prefix</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> prefix <span class="keyword">in</span> prefixes:</span><br><span class="line">            <span class="keyword">yield</span> self._ROLES_TEMPLATE % prefix</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">remove_auth_headers</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Remove headers so a user can't fake authentication."""</span></span><br><span class="line">        <span class="keyword">for</span> header <span class="keyword">in</span> self._all_auth_headers():</span><br><span class="line">            self.headers.pop(header, <span class="literal">None</span>)</span><br></pre></td></tr></table></figure>
<h3 id="2-获取-Token"><a href="#2-获取-Token" class="headerlink" title="2. 获取 Token"></a><strong>2. 获取 Token</strong></h3><p>获取 Token 分了几个主要步骤：</p>
<ol>
<li>从缓存中获取（如有，需进行合法性检查）</li>
<li>如无，则利用 <a href="http://xiehongfeng100.github.io/2016/08/24/openstack-understanding-openstack-authentication-keystone-pki/">PKI</a> 或从 Keystone（identity server） 获取 Token。</li>
</ol>
<p><strong>注：</strong>PKI 属于本地认证，这样可以减轻 Keystone 的压力。</p>
<p>详细请看源码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># keystonemiddleware/auth_token/__init__.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseAuthProtocol</span><span class="params">(object)</span>:</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_do_fetch_token</span><span class="params">(self, token, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""Helper method to fetch a token and convert it into an AccessInfo."""</span></span><br><span class="line">        <span class="keyword">if</span> self.kwargs_to_fetch_token:</span><br><span class="line">            data = self.fetch_token(token, **kwargs)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            m = _(<span class="string">'Implementations of auth_token must set '</span></span><br><span class="line">                  <span class="string">'kwargs_to_fetch_token this will be the required and '</span></span><br><span class="line">                  <span class="string">'assumed in Pike.'</span>)</span><br><span class="line">            warnings.warn(m)</span><br><span class="line">            data = self.fetch_token(token)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> data, access.create(body=data, auth_token=token)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            self.log.warning(<span class="string">'Invalid token contents.'</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">raise</span> ksm_exceptions.InvalidToken(_(<span class="string">'Token authorization failed'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthProtocol</span><span class="params">(BaseAuthProtocol)</span>:</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fetch_token</span><span class="params">(self, token, allow_expired=False)</span>:</span></span><br><span class="line">        <span class="string">"""Retrieve a token from either a PKI bundle or the identity server.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param str token: token id</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :raises exc.InvalidToken: if token is rejected</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        data = <span class="literal">None</span></span><br><span class="line">        token_hashes = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            token_hashes = self._token_hashes(token)</span><br><span class="line">            cached = self._cache_get_hashes(token_hashes)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> cached:</span><br><span class="line">                <span class="keyword">if</span> cached == _CACHE_INVALID_INDICATOR:</span><br><span class="line">                    self.log.debug(<span class="string">'Cached token is marked unauthorized'</span>)</span><br><span class="line">                    <span class="keyword">raise</span> ksm_exceptions.InvalidToken()</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> self._check_revocations_for_cached:</span><br><span class="line">                    <span class="comment"># A token might have been revoked, regardless of initial</span></span><br><span class="line">                    <span class="comment"># mechanism used to validate it, and needs to be checked.</span></span><br><span class="line">                    self._revocations.check(token_hashes)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># NOTE(jamielennox): Cached values used to be stored as a tuple</span></span><br><span class="line">                <span class="comment"># of data and expiry time. They no longer are but we have to</span></span><br><span class="line">                <span class="comment"># allow some time to transition the old format so if it's a</span></span><br><span class="line">                <span class="comment"># tuple just use the data.</span></span><br><span class="line">                <span class="keyword">if</span> len(cached) == <span class="number">2</span>:</span><br><span class="line">                    cached = cached[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">                data = cached</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                data = self._validate_offline(token, token_hashes)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                    data = self._identity_server.verify_token(</span><br><span class="line">                        token,</span><br><span class="line">                        allow_expired=allow_expired)</span><br><span class="line"></span><br><span class="line">                self._token_cache.set(token_hashes[<span class="number">0</span>], data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> (ksa_exceptions.ConnectFailure,</span><br><span class="line">                ksa_exceptions.RequestTimeout,</span><br><span class="line">                ksm_exceptions.RevocationListError,</span><br><span class="line">                ksm_exceptions.ServiceError) <span class="keyword">as</span> e:</span><br><span class="line">            self.log.critical(<span class="string">'Unable to validate token: %s'</span>, e)</span><br><span class="line">            <span class="keyword">raise</span> webob.exc.HTTPServiceUnavailable()</span><br><span class="line">        <span class="keyword">except</span> ksm_exceptions.InvalidToken:</span><br><span class="line">            self.log.debug(<span class="string">'Token validation failure.'</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">if</span> token_hashes:</span><br><span class="line">                self._token_cache.set(token_hashes[<span class="number">0</span>],</span><br><span class="line">                                      _CACHE_INVALID_INDICATOR)</span><br><span class="line">            self.log.warning(<span class="string">'Authorization failed for token'</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure></p>
<h3 id="2-验证-Token"><a href="#2-验证-Token" class="headerlink" title="2. 验证 Token"></a><strong>2. 验证 Token</strong></h3><p>主要验证 Token 是否已经失效：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># keystonemiddleware/auth_token/__init__.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseAuthProtocol</span><span class="params">(object)</span>:</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_validate_token</span><span class="params">(self, auth_ref, allow_expired=False)</span>:</span></span><br><span class="line">        <span class="string">"""Perform the validation steps on the token.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param auth_ref: The token data</span></span><br><span class="line"><span class="string">        :type auth_ref: keystoneauth1.access.AccessInfo</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :raises exc.InvalidToken: if token is rejected</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 0 seconds of validity means it is invalid right now</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">not</span> allow_expired) <span class="keyword">and</span> auth_ref.will_expire_soon(stale_duration=<span class="number">0</span>):</span><br><span class="line">            <span class="keyword">raise</span> ksm_exceptions.InvalidToken(_(<span class="string">'Token authorization failed'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthProtocol</span><span class="params">(BaseAuthProtocol)</span>:</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_validate_token</span><span class="params">(self, auth_ref, **kwargs)</span>:</span></span><br><span class="line">        super(AuthProtocol, self)._validate_token(auth_ref, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> auth_ref.version == <span class="string">'v2.0'</span> <span class="keyword">and</span> <span class="keyword">not</span> auth_ref.project_id:</span><br><span class="line">            msg = _(<span class="string">'Unable to determine service tenancy.'</span>)</span><br><span class="line">            <span class="keyword">raise</span> ksm_exceptions.InvalidToken(msg)</span><br></pre></td></tr></table></figure></p>
<h3 id="4-判断认证状态"><a href="#4-判断认证状态" class="headerlink" title="4. 判断认证状态"></a><strong>4. 判断认证状态</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># keystonemiddleware/auth_token/__init__.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthProtocol</span><span class="params">(BaseAuthProtocol)</span>:</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="comment"># NOTE(jamielennox): The service status is allowed to be missing if a</span></span><br><span class="line">        <span class="comment"># service token is not passed. If the service status is missing that's</span></span><br><span class="line">        <span class="comment"># a valid request. We should find a better way to expose this from the</span></span><br><span class="line">        <span class="comment"># request object.</span></span><br><span class="line">        user_status = request.user_token <span class="keyword">and</span> request.user_token_valid</span><br><span class="line">        service_status = request.headers.get(<span class="string">'X-Service-Identity-Status'</span>,</span><br><span class="line">                                             <span class="string">'Confirmed'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (user_status <span class="keyword">and</span> service_status == <span class="string">'Confirmed'</span>):</span><br><span class="line">            <span class="keyword">if</span> self._delay_auth_decision:</span><br><span class="line">                self.log.debug(<span class="string">'Deferring reject downstream'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.log.info(<span class="string">'Rejecting request'</span>)</span><br><span class="line">                message = _(<span class="string">'The request you have made requires '</span></span><br><span class="line">                            <span class="string">'authentication.'</span>)</span><br><span class="line">                body = &#123;<span class="string">'error'</span>: &#123;</span><br><span class="line">                    <span class="string">'code'</span>: <span class="number">401</span>,</span><br><span class="line">                    <span class="string">'title'</span>: <span class="string">'Unauthorized'</span>,</span><br><span class="line">                    <span class="string">'message'</span>: message,</span><br><span class="line">                &#125;&#125;</span><br><span class="line">                <span class="keyword">raise</span> webob.exc.HTTPUnauthorized(</span><br><span class="line">                    body=jsonutils.dumps(body),</span><br><span class="line">                    headers=self._reject_auth_headers,</span><br><span class="line">                    charset=<span class="string">'UTF-8'</span>,</span><br><span class="line">                    content_type=<span class="string">'application/json'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="5-设置头部信息"><a href="#5-设置头部信息" class="headerlink" title="5. 设置头部信息"></a><strong>5. 设置头部信息</strong></h3><p>这部分特别重要，因为这部分会把请求用户<strong>已认证</strong>的详细身份信息填写到请求头部中，作为 keystonemiddleware 下一个 WSGI 应用的认证信息（请看下文的 Nova Context 部分）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># keystonemiddleware/auth_token/__init__.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthProtocol</span><span class="params">(BaseAuthProtocol)</span>:</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> request.user_token_valid:</span><br><span class="line">            request.set_user_headers(request.token_auth.user)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> self._include_service_catalog:</span><br><span class="line">                request.set_service_catalog_headers(request.token_auth.user)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># keystonemiddleware/auth_token/_request.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_AuthTokenRequest</span><span class="params">(webob.Request)</span>:</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    _HEADER_TEMPLATE = &#123;</span><br><span class="line">        <span class="string">'X%s-Domain-Id'</span>: <span class="string">'domain_id'</span>,</span><br><span class="line">        <span class="string">'X%s-Domain-Name'</span>: <span class="string">'domain_name'</span>,</span><br><span class="line">        <span class="string">'X%s-Project-Id'</span>: <span class="string">'project_id'</span>,</span><br><span class="line">        <span class="string">'X%s-Project-Name'</span>: <span class="string">'project_name'</span>,</span><br><span class="line">        <span class="string">'X%s-Project-Domain-Id'</span>: <span class="string">'project_domain_id'</span>,</span><br><span class="line">        <span class="string">'X%s-Project-Domain-Name'</span>: <span class="string">'project_domain_name'</span>,</span><br><span class="line">        <span class="string">'X%s-User-Id'</span>: <span class="string">'user_id'</span>,</span><br><span class="line">        <span class="string">'X%s-User-Name'</span>: <span class="string">'username'</span>,</span><br><span class="line">        <span class="string">'X%s-User-Domain-Id'</span>: <span class="string">'user_domain_id'</span>,</span><br><span class="line">        <span class="string">'X%s-User-Domain-Name'</span>: <span class="string">'user_domain_name'</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _ROLES_TEMPLATE = <span class="string">'X%s-Roles'</span></span><br><span class="line"></span><br><span class="line">    _USER_HEADER_PREFIX = <span class="string">''</span></span><br><span class="line">    _SERVICE_HEADER_PREFIX = <span class="string">'-Service'</span></span><br><span class="line"></span><br><span class="line">    _USER_STATUS_HEADER = <span class="string">'X-Identity-Status'</span></span><br><span class="line">    _SERVICE_STATUS_HEADER = <span class="string">'X-Service-Identity-Status'</span></span><br><span class="line"></span><br><span class="line">    _ADMIN_PROJECT_HEADER = <span class="string">'X-Is-Admin-Project'</span></span><br><span class="line"></span><br><span class="line">    _SERVICE_CATALOG_HEADER = <span class="string">'X-Service-Catalog'</span></span><br><span class="line">    _TOKEN_AUTH = <span class="string">'keystone.token_auth'</span></span><br><span class="line">    _TOKEN_INFO = <span class="string">'keystone.token_info'</span></span><br><span class="line"></span><br><span class="line">    _CONFIRMED = <span class="string">'Confirmed'</span></span><br><span class="line">    _INVALID = <span class="string">'Invalid'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># header names that have been deprecated in favour of something else.</span></span><br><span class="line">    _DEPRECATED_HEADER_MAP = &#123;</span><br><span class="line">        <span class="string">'X-Role'</span>: <span class="string">'X-Roles'</span>,</span><br><span class="line">        <span class="string">'X-User'</span>: <span class="string">'X-User-Name'</span>,</span><br><span class="line">        <span class="string">'X-Tenant-Id'</span>: <span class="string">'X-Project-Id'</span>,</span><br><span class="line">        <span class="string">'X-Tenant-Name'</span>: <span class="string">'X-Project-Name'</span>,</span><br><span class="line">        <span class="string">'X-Tenant'</span>: <span class="string">'X-Project-Name'</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_set_auth_headers</span><span class="params">(self, auth_ref, prefix)</span>:</span></span><br><span class="line">        names = <span class="string">','</span>.join(auth_ref.role_names)</span><br><span class="line">        self.headers[self._ROLES_TEMPLATE % prefix] = names</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> header_tmplt, attr <span class="keyword">in</span> six.iteritems(self._HEADER_TEMPLATE):</span><br><span class="line">            self.headers[header_tmplt % prefix] = getattr(auth_ref, attr)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_user_headers</span><span class="params">(self, auth_ref)</span>:</span></span><br><span class="line">        <span class="string">"""Convert token object into headers.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Build headers that represent authenticated user - see main</span></span><br><span class="line"><span class="string">        doc info at start of __init__ file for details of headers to be defined</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self._set_auth_headers(auth_ref, self._USER_HEADER_PREFIX)</span><br><span class="line">        self.headers[self._ADMIN_PROJECT_HEADER] = _is_admin_project(auth_ref)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> six.iteritems(self._DEPRECATED_HEADER_MAP):</span><br><span class="line">            self.headers[k] = self.headers[v]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_service_catalog_headers</span><span class="params">(self, auth_ref)</span>:</span></span><br><span class="line">        <span class="string">"""Convert service catalog from token object into headers.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Build headers that represent the catalog - see main</span></span><br><span class="line"><span class="string">        doc info at start of __init__ file for details of headers to be defined</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param auth_ref: The token data</span></span><br><span class="line"><span class="string">        :type auth_ref: keystoneauth.access.AccessInfo</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> auth_ref.has_service_catalog():</span><br><span class="line">            self.headers.pop(self._SERVICE_CATALOG_HEADER, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        catalog = auth_ref.service_catalog.catalog</span><br><span class="line">        <span class="keyword">if</span> auth_ref.version == <span class="string">'v3'</span>:</span><br><span class="line">            catalog = _v3_to_v2_catalog(catalog)</span><br><span class="line"></span><br><span class="line">        c = jsonutils.dumps(catalog)</span><br><span class="line">        self.headers[self._SERVICE_CATALOG_HEADER] = c</span><br></pre></td></tr></table></figure>
<h2 id="Nova-Context"><a href="#Nova-Context" class="headerlink" title="Nova Context"></a><strong>Nova Context</strong></h2><p>请求经过 keystonemiddleware 处理后，就会进行下一步，设置具体模块 Nova 的请求上下文 context，详细源码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nova/api/auth.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NovaKeystoneContext</span><span class="params">(wsgi.Middleware)</span>:</span></span><br><span class="line">    <span class="string">"""Make a request context from keystone headers."""</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @webob.dec.wsgify(RequestClass=wsgi.Request)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, req)</span>:</span></span><br><span class="line">        <span class="comment"># Build a context, including the auth_token...</span></span><br><span class="line">        remote_address = req.remote_addr</span><br><span class="line">        <span class="keyword">if</span> CONF.api.use_forwarded_for:</span><br><span class="line">            remote_address = req.headers.get(<span class="string">'X-Forwarded-For'</span>, remote_address)</span><br><span class="line"></span><br><span class="line">        service_catalog = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> req.headers.get(<span class="string">'X_SERVICE_CATALOG'</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                catalog_header = req.headers.get(<span class="string">'X_SERVICE_CATALOG'</span>)</span><br><span class="line">                service_catalog = jsonutils.loads(catalog_header)</span><br><span class="line">            <span class="keyword">except</span> ValueError:</span><br><span class="line">                <span class="keyword">raise</span> webob.exc.HTTPInternalServerError(</span><br><span class="line">                          _(<span class="string">'Invalid service catalog json.'</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># NOTE(jamielennox): This is a full auth plugin set by auth_token</span></span><br><span class="line">        <span class="comment"># middleware in newer versions.</span></span><br><span class="line">        user_auth_plugin = req.environ.get(<span class="string">'keystone.token_auth'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 上下文设置</span></span><br><span class="line">        ctx = context.RequestContext.from_environ(</span><br><span class="line">            req.environ,</span><br><span class="line">            user_auth_plugin=user_auth_plugin,</span><br><span class="line">            remote_address=remote_address,</span><br><span class="line">            service_catalog=service_catalog)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ctx.user_id <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            LOG.debug(<span class="string">"Neither X_USER_ID nor X_USER found in request"</span>)</span><br><span class="line">            <span class="keyword">return</span> webob.exc.HTTPUnauthorized()</span><br><span class="line"></span><br><span class="line">        req.environ[<span class="string">'nova.context'</span>] = ctx	<span class="comment"># 这就是底层 Nova API 经常使用的 nova.context</span></span><br><span class="line">        <span class="keyword">return</span> self.application</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># nova/context.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestContext</span><span class="params">(context.RequestContext)</span>:</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_environ</span><span class="params">(cls, environ, **kwargs)</span>:</span></span><br><span class="line">        ctx = super(RequestContext, cls).from_environ(environ, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># the base oslo.context sets its user param and tenant param but not</span></span><br><span class="line">        <span class="comment"># our user_id and project_id param so fix those up.</span></span><br><span class="line">        <span class="keyword">if</span> ctx.user <span class="keyword">and</span> <span class="keyword">not</span> ctx.user_id:</span><br><span class="line">            ctx.user_id = ctx.user</span><br><span class="line">        <span class="keyword">if</span> ctx.tenant <span class="keyword">and</span> <span class="keyword">not</span> ctx.project_id:</span><br><span class="line">            ctx.project_id = ctx.tenant</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># oslo.context\oslo_context\context.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># These arguments will be passed to a new context from the first available</span></span><br><span class="line"><span class="comment"># header to support backwards compatibility.</span></span><br><span class="line">_ENVIRON_HEADERS = &#123;</span><br><span class="line">    <span class="string">'auth_token'</span>: [<span class="string">'HTTP_X_AUTH_TOKEN'</span>,</span><br><span class="line">                   <span class="string">'HTTP_X_STORAGE_TOKEN'</span>],</span><br><span class="line">    <span class="string">'user'</span>: [<span class="string">'HTTP_X_USER_ID'</span>,</span><br><span class="line">             <span class="string">'HTTP_X_USER'</span>],</span><br><span class="line">    <span class="string">'tenant'</span>: [<span class="string">'HTTP_X_PROJECT_ID'</span>,</span><br><span class="line">               <span class="string">'HTTP_X_TENANT_ID'</span>,</span><br><span class="line">               <span class="string">'HTTP_X_TENANT'</span>],</span><br><span class="line">    <span class="string">'user_domain'</span>: [<span class="string">'HTTP_X_USER_DOMAIN_ID'</span>],</span><br><span class="line">    <span class="string">'project_domain'</span>: [<span class="string">'HTTP_X_PROJECT_DOMAIN_ID'</span>],</span><br><span class="line">    <span class="string">'user_name'</span>: [<span class="string">'HTTP_X_USER_NAME'</span>],</span><br><span class="line">    <span class="string">'project_name'</span>: [<span class="string">'HTTP_X_PROJECT_NAME'</span>,</span><br><span class="line">                     <span class="string">'HTTP_X_TENANT_NAME'</span>],</span><br><span class="line">    <span class="string">'user_domain_name'</span>: [<span class="string">'HTTP_X_USER_DOMAIN_NAME'</span>],</span><br><span class="line">    <span class="string">'project_domain_name'</span>: [<span class="string">'HTTP_X_PROJECT_DOMAIN_NAME'</span>],</span><br><span class="line">    <span class="string">'request_id'</span>: [<span class="string">'openstack.request_id'</span>],</span><br><span class="line">    <span class="string">'global_request_id'</span>: [<span class="string">'openstack.global_request_id'</span>],</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">'service_token'</span>: [<span class="string">'HTTP_X_SERVICE_TOKEN'</span>],</span><br><span class="line">    <span class="string">'service_user_id'</span>: [<span class="string">'HTTP_X_SERVICE_USER_ID'</span>],</span><br><span class="line">    <span class="string">'service_user_name'</span>: [<span class="string">'HTTP_X_SERVICE_USER_NAME'</span>],</span><br><span class="line">    <span class="string">'service_user_domain_id'</span>: [<span class="string">'HTTP_X_SERVICE_USER_DOMAIN_ID'</span>],</span><br><span class="line">    <span class="string">'service_user_domain_name'</span>: [<span class="string">'HTTP_X_SERVICE_USER_DOMAIN_NAME'</span>],</span><br><span class="line">    <span class="string">'service_project_id'</span>: [<span class="string">'HTTP_X_SERVICE_PROJECT_ID'</span>],</span><br><span class="line">    <span class="string">'service_project_name'</span>: [<span class="string">'HTTP_X_SERVICE_PROJECT_NAME'</span>],</span><br><span class="line">    <span class="string">'service_project_domain_id'</span>: [<span class="string">'HTTP_X_SERVICE_PROJECT_DOMAIN_ID'</span>],</span><br><span class="line">    <span class="string">'service_project_domain_name'</span>: [<span class="string">'HTTP_X_SERVICE_PROJECT_DOMAIN_NAME'</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestContext</span><span class="params">(object)</span>:</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_environ</span><span class="params">(cls, environ, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""Load a context object from a request environment.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        If keyword arguments are provided then they override the values in the</span></span><br><span class="line"><span class="string">        request environment.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param environ: The environment dictionary associated with a request.</span></span><br><span class="line"><span class="string">        :type environ: dict</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># Load a new context object from the environment variables set by</span></span><br><span class="line">        <span class="comment"># auth_token middleware. See:</span></span><br><span class="line">        <span class="comment"># https://docs.openstack.org/developer/keystonemiddleware/api/keystonemiddleware.auth_token.html#what-auth-token-adds-to-the-request-for-use-by-the-openstack-service</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># add kwarg if not specified by user from a list of possible headers</span></span><br><span class="line">        <span class="keyword">for</span> k, v_list <span class="keyword">in</span> _ENVIRON_HEADERS.items():</span><br><span class="line">            <span class="keyword">if</span> k <span class="keyword">in</span> kwargs:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> v <span class="keyword">in</span> v_list:</span><br><span class="line">                <span class="keyword">if</span> v <span class="keyword">in</span> environ:</span><br><span class="line">                    kwargs[k] = environ[v]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'roles'</span> <span class="keyword">not</span> <span class="keyword">in</span> kwargs:</span><br><span class="line">            roles = environ.get(<span class="string">'HTTP_X_ROLES'</span>, environ.get(<span class="string">'HTTP_X_ROLE'</span>))</span><br><span class="line">            roles = [r.strip() <span class="keyword">for</span> r <span class="keyword">in</span> roles.split(<span class="string">','</span>)] <span class="keyword">if</span> roles <span class="keyword">else</span> []</span><br><span class="line">            kwargs[<span class="string">'roles'</span>] = roles</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'service_roles'</span> <span class="keyword">not</span> <span class="keyword">in</span> kwargs:</span><br><span class="line">            roles = environ.get(<span class="string">'HTTP_X_SERVICE_ROLES'</span>)</span><br><span class="line">            roles = [r.strip() <span class="keyword">for</span> r <span class="keyword">in</span> roles.split(<span class="string">','</span>)] <span class="keyword">if</span> roles <span class="keyword">else</span> []</span><br><span class="line">            kwargs[<span class="string">'service_roles'</span>] = roles</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'is_admin_project'</span> <span class="keyword">not</span> <span class="keyword">in</span> kwargs:</span><br><span class="line">            <span class="comment"># NOTE(jamielennox): we default is_admin_project to true because if</span></span><br><span class="line">            <span class="comment"># nothing is provided we have to assume it is the admin project to</span></span><br><span class="line">            <span class="comment"># make old policy continue to work.</span></span><br><span class="line">            is_admin_proj_str = environ.get(<span class="string">'HTTP_X_IS_ADMIN_PROJECT'</span>, <span class="string">'true'</span>)</span><br><span class="line">            kwargs[<span class="string">'is_admin_project'</span>] = is_admin_proj_str.lower() == <span class="string">'true'</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cls(**kwargs)</span><br></pre></td></tr></table></figure></p>
<p>接下来的请求操作就可以利用以上设置的上下文了。</p>
<h2 id="访问控制和授权"><a href="#访问控制和授权" class="headerlink" title="访问控制和授权"></a><strong>访问控制和授权</strong></h2><p>如果你足够细心，会发现其实以上 Keystonemiddleware 的 Token 认证并没有完成一件很重要的事——<code>访问控制和授权</code>。这也不能怪 Keystonemiddleware，因为这跟其主要定位于校验 Token 合法性有关系，关注的是大的方面的权限验证；而对于很多模块而言，如 nova，资源多种多样，每种资源的操作权限可能都不一样，如果让 Keystonemiddleware 也来做这些很细的东西，那它将会是非常复杂，还不如把这些小的方面的权限控制放到具体模块去，由具体模块来控制实施。这样各个模块在复用 Keystonemiddleware 的同时还能够保持灵活性。</p>
<p>这进一步的访问控制是通过 Policy 机制来完成的。具体可以参考以前博文 <a href="http://xiehongfeng100.github.io/2017/06/09/openstack-keystone-introduction-and-basic-concepts/">OpenStack 源码系列之 Keystone：简介及基本概念介绍</a>的“访问管理和授权”部分。</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/06/19/ops-elk-setup/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          ELK 安装
        
      </div>
    </a>
  
  
    <a href="/2017/06/09/openstack-keystone-service-startup/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">OpenStack 源码系列之 Keystone：服务启动</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>







      <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>

<script>
var gitalk = new Gitalk({
  clientID: '64c19d7f57bebbb343c4',
  clientSecret: '287daeba39e73fdde92f24540c9f3c0fd5238512',
  repo: 'BlogComments',
  owner: 'xiemax100',
  admin: ['xiemax100'],
  id: md5(window.location.pathname),
  distractionFreeMode: true
})

gitalk.render('gitalk-container')
</script>






    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#获取-Token"><span class="toc-number">1.</span> <span class="toc-text">获取 Token</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#获取临时-Token"><span class="toc-number">1.1.</span> <span class="toc-text">获取临时 Token</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取用户可以访问的租户"><span class="toc-number">1.2.</span> <span class="toc-text">获取用户可以访问的租户</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取指定租户的-Token"><span class="toc-number">1.3.</span> <span class="toc-text">获取指定租户的 Token</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Token-认证源码分析"><span class="toc-number">2.</span> <span class="toc-text">Token 认证源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#keystonemiddleware"><span class="toc-number">2.1.</span> <span class="toc-text">keystonemiddleware</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-去除请求中跟认证相关的头部"><span class="toc-number">2.1.1.</span> <span class="toc-text">1. 去除请求中跟认证相关的头部</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-获取-Token"><span class="toc-number">2.1.2.</span> <span class="toc-text">2. 获取 Token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-验证-Token"><span class="toc-number">2.1.3.</span> <span class="toc-text">2. 验证 Token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-判断认证状态"><span class="toc-number">2.1.4.</span> <span class="toc-text">4. 判断认证状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-设置头部信息"><span class="toc-number">2.1.5.</span> <span class="toc-text">5. 设置头部信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nova-Context"><span class="toc-number">2.2.</span> <span class="toc-text">Nova Context</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#访问控制和授权"><span class="toc-number">2.3.</span> <span class="toc-text">访问控制和授权</span></a></li></ol></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录" title="点击按钮隐藏或者显示文章目录">

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var toc_button = document.getElementById("tocButton");
    var toc_div = document.getElementById("toc");
    toc_button.onclick=function() {
        if (toc_div.style.display == "none") {
            toc_div.style.display = "block";
            toc_button.value = "隐藏目录";
            document.getElementById("switch-btn").style.display = "none";
            document.getElementById("switch-area").style.display = "none";
        }
        else {
            toc_div.style.display = "none";
            toc_button.value = "显示目录";
            document.getElementById("switch-btn").style.display = "block";
            document.getElementById("switch-area").style.display = "block";
        }
    }

    if ($(".toc").length < 1) {
        $("#toc").css("display","none");
        $("#tocButton").css("display","none");
        $(".switch-btn").css("display","block");
        $(".switch-area").css("display","block");
    }
</script>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2019 Max
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>