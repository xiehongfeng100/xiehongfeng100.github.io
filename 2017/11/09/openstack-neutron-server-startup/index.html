<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>OpenStack 源码系列之 Neutron：Neutron Server 启动 | Max&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在我们正式开始之前，我们先来看一下博文两张图总结 Neutron 架构总结的 Neutron 架构图（特别简明易懂）。 图片来源 这里我们关注的是 Neutron Server 那一部分的初始化。跟以前 Nova 源码分析一样，我们主要还是会用 UML 来进行代码的分析。">
<meta name="keywords" content="OpenStack,Neutron,网络">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenStack 源码系列之 Neutron：Neutron Server 启动">
<meta property="og:url" content="http://xiehongfeng100.github.io/2017/11/09/openstack-neutron-server-startup/index.html">
<meta property="og:site_name" content="Max&#39;s Blog">
<meta property="og:description" content="在我们正式开始之前，我们先来看一下博文两张图总结 Neutron 架构总结的 Neutron 架构图（特别简明易懂）。 图片来源 这里我们关注的是 Neutron Server 那一部分的初始化。跟以前 Nova 源码分析一样，我们主要还是会用 UML 来进行代码的分析。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/cloud-computation/openstack/neutron/neutron-server-startup/neutron-architecture.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/cloud-computation/openstack/neutron/neutron-server-startup/neutron-server-startup.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/cloud-computation/openstack/neutron/neutron-server-startup/apirouter.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/cloud-computation/openstack/neutron/neutron-server-startup/ml2-n-l2agents.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/cloud-computation/openstack/neutron/neutron-server-startup/ml2-framework.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/cloud-computation/openstack/neutron/neutron-server-startup/ml2_plugin.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/cloud-computation/openstack/neutron/neutron-server-startup/l3_router_plugin.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/cloud-computation/openstack/neutron/neutron-server-startup/extensions_loading.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/cloud-computation/openstack/neutron/neutron-server-startup/routes-n-plugins.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/cloud-computation/openstack/neutron/neutron-server-startup/launch-neutron-api-service.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/cloud-computation/openstack/neutron/neutron-server-startup/launch-plugins-rpc-listeners-n-workers.png">
<meta property="og:updated_time" content="2019-05-01T06:21:57.253Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OpenStack 源码系列之 Neutron：Neutron Server 启动">
<meta name="twitter:description" content="在我们正式开始之前，我们先来看一下博文两张图总结 Neutron 架构总结的 Neutron 架构图（特别简明易懂）。 图片来源 这里我们关注的是 Neutron Server 那一部分的初始化。跟以前 Nova 源码分析一样，我们主要还是会用 UML 来进行代码的分析。">
<meta name="twitter:image" content="http://xiehongfeng100.github.io/images/cloud-computation/openstack/neutron/neutron-server-startup/neutron-architecture.png">
  
    <link rel="alternative" href="/atom.xml" title="Max&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="img/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/author.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Max</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Stay hungry, stay foolish.</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/categories/读书">读书</a></li>
				        
							<li><a href="/tags/翻译">翻译</a></li>
				        
							<li><a href="/categories/网络">网络</a></li>
				        
							<li><a href="/categories/并发">并发</a></li>
				        
							<li><a href="/categories/安全">安全</a></li>
				        
							<li><a href="/categories/运维">运维</a></li>
				        
							<li><a href="/categories/数据库">数据库</a></li>
				        
							<li><a href="/categories/云计算">云计算</a></li>
				        
							<li><a href="/categories/编程语言">编程语言</a></li>
				        
							<li><a href="/categories/操作系统">操作系统</a></li>
				        
							<li><a href="/categories/机器学习">机器学习</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/xiehongfeng100" title="github">github</a>
					        
								<a class="linkedin" target="_blank" href="http://cn.linkedin.com/in/xiehongfeng100" title="linkedin">linkedin</a>
					        
								<a class="mail" target="_blank" href="mailto:xiehongfeng100@yeah.net" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/tmp/" style="font-size: 10px;">/tmp</a> <a href="/tags/AT-T/" style="font-size: 10px;">AT&T</a> <a href="/tags/Affin/" style="font-size: 10px;">Affin</a> <a href="/tags/Alembic/" style="font-size: 10px;">Alembic</a> <a href="/tags/B-树/" style="font-size: 10px;">B+ 树</a> <a href="/tags/BIOS/" style="font-size: 10px;">BIOS</a> <a href="/tags/C-C/" style="font-size: 16.36px;">C/C++</a> <a href="/tags/CA/" style="font-size: 10px;">CA</a> <a href="/tags/CBOW/" style="font-size: 10px;">CBOW</a> <a href="/tags/CNN/" style="font-size: 10.91px;">CNN</a> <a href="/tags/DHCP/" style="font-size: 10px;">DHCP</a> <a href="/tags/Decorator/" style="font-size: 10px;">Decorator</a> <a href="/tags/Django/" style="font-size: 10px;">Django</a> <a href="/tags/Dnsmasq/" style="font-size: 10px;">Dnsmasq</a> <a href="/tags/ELF/" style="font-size: 10px;">ELF</a> <a href="/tags/ELK/" style="font-size: 10px;">ELK</a> <a href="/tags/Elasticsearch/" style="font-size: 11.82px;">Elasticsearch</a> <a href="/tags/GCC/" style="font-size: 10px;">GCC</a> <a href="/tags/HBR/" style="font-size: 10px;">HBR</a> <a href="/tags/IO-Multiplexing/" style="font-size: 11.82px;">IO Multiplexing</a> <a href="/tags/IPTables/" style="font-size: 10px;">IPTables</a> <a href="/tags/Immunity-Debugger/" style="font-size: 10px;">Immunity Debugger</a> <a href="/tags/InnoDB/" style="font-size: 10px;">InnoDB</a> <a href="/tags/KD-Tree/" style="font-size: 10.91px;">KD-Tree</a> <a href="/tags/KNN/" style="font-size: 10px;">KNN</a> <a href="/tags/KVM/" style="font-size: 10px;">KVM</a> <a href="/tags/Kali-Linux/" style="font-size: 10px;">Kali Linux</a> <a href="/tags/Keras/" style="font-size: 10px;">Keras</a> <a href="/tags/Keystone/" style="font-size: 13.64px;">Keystone</a> <a href="/tags/Kibana/" style="font-size: 10px;">Kibana</a> <a href="/tags/Lemmatization/" style="font-size: 10px;">Lemmatization</a> <a href="/tags/Libvirt/" style="font-size: 10.91px;">Libvirt</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/LinuxBridge/" style="font-size: 11.82px;">LinuxBridge</a> <a href="/tags/Logging/" style="font-size: 10px;">Logging</a> <a href="/tags/Logstash/" style="font-size: 10px;">Logstash</a> <a href="/tags/MRO/" style="font-size: 10px;">MRO</a> <a href="/tags/Metasploit-Framwork/" style="font-size: 10px;">Metasploit Framwork</a> <a href="/tags/MySQL/" style="font-size: 10.91px;">MySQL</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/Namespace/" style="font-size: 10px;">Namespace</a> <a href="/tags/Neo4J/" style="font-size: 10.91px;">Neo4J</a> <a href="/tags/Neutron/" style="font-size: 13.64px;">Neutron</a> <a href="/tags/Nova/" style="font-size: 14.55px;">Nova</a> <a href="/tags/OpenStack/" style="font-size: 17.27px;">OpenStack</a> <a href="/tags/OpenVSwitch/" style="font-size: 10px;">OpenVSwitch</a> <a href="/tags/PKI/" style="font-size: 10.91px;">PKI</a> <a href="/tags/PasteDeploy/" style="font-size: 10.91px;">PasteDeploy</a> <a href="/tags/Policy/" style="font-size: 10px;">Policy</a> <a href="/tags/Python/" style="font-size: 18.18px;">Python</a> <a href="/tags/QEMU/" style="font-size: 10px;">QEMU</a> <a href="/tags/RBAC/" style="font-size: 10px;">RBAC</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/SQLAlchemy-Migrate/" style="font-size: 10px;">SQLAlchemy-Migrate</a> <a href="/tags/SSL/" style="font-size: 10px;">SSL</a> <a href="/tags/Sigmoid/" style="font-size: 10px;">Sigmoid</a> <a href="/tags/Skip-Gram/" style="font-size: 10px;">Skip-Gram</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Stop-Words/" style="font-size: 10px;">Stop Words</a> <a href="/tags/TCP/" style="font-size: 10px;">TCP</a> <a href="/tags/Tap/" style="font-size: 10.91px;">Tap</a> <a href="/tags/Token/" style="font-size: 11.82px;">Token</a> <a href="/tags/Tokenization/" style="font-size: 10px;">Tokenization</a> <a href="/tags/Trampolining/" style="font-size: 10px;">Trampolining</a> <a href="/tags/Tun/" style="font-size: 10.91px;">Tun</a> <a href="/tags/Tunnel/" style="font-size: 10px;">Tunnel</a> <a href="/tags/UUID/" style="font-size: 10px;">UUID</a> <a href="/tags/VNC/" style="font-size: 10px;">VNC</a> <a href="/tags/VPN/" style="font-size: 10px;">VPN</a> <a href="/tags/Veth/" style="font-size: 11.82px;">Veth</a> <a href="/tags/VirtualBox/" style="font-size: 10px;">VirtualBox</a> <a href="/tags/Vlan/" style="font-size: 10px;">Vlan</a> <a href="/tags/Vue/" style="font-size: 10px;">Vue</a> <a href="/tags/WSGI/" style="font-size: 13.64px;">WSGI</a> <a href="/tags/Webob/" style="font-size: 10px;">Webob</a> <a href="/tags/Word2Vec/" style="font-size: 10.91px;">Word2Vec</a> <a href="/tags/Yelper/" style="font-size: 15.45px;">Yelper</a> <a href="/tags/bootsect/" style="font-size: 10px;">bootsect</a> <a href="/tags/cookiecutter/" style="font-size: 10px;">cookiecutter</a> <a href="/tags/delete/" style="font-size: 10px;">delete</a> <a href="/tags/dnsmasq/" style="font-size: 10px;">dnsmasq</a> <a href="/tags/entry-points/" style="font-size: 10px;">entry_points</a> <a href="/tags/epoll/" style="font-size: 10px;">epoll</a> <a href="/tags/fork/" style="font-size: 10px;">fork</a> <a href="/tags/head/" style="font-size: 10px;">head</a> <a href="/tags/inode/" style="font-size: 10px;">inode</a> <a href="/tags/malloc/" style="font-size: 10px;">malloc</a> <a href="/tags/mona/" style="font-size: 10px;">mona</a> <a href="/tags/new/" style="font-size: 10px;">new</a> <a href="/tags/property/" style="font-size: 10px;">property</a> <a href="/tags/read/" style="font-size: 10px;">read</a> <a href="/tags/routes/" style="font-size: 10px;">routes</a> <a href="/tags/select/" style="font-size: 10px;">select</a> <a href="/tags/setup/" style="font-size: 10px;">setup</a> <a href="/tags/setuptools/" style="font-size: 10px;">setuptools</a> <a href="/tags/shell/" style="font-size: 10.91px;">shell</a> <a href="/tags/stevedore/" style="font-size: 10px;">stevedore</a> <a href="/tags/string/" style="font-size: 10px;">string</a> <a href="/tags/tcpdump/" style="font-size: 10px;">tcpdump</a> <a href="/tags/uWSGI/" style="font-size: 10px;">uWSGI</a> <a href="/tags/update-进程/" style="font-size: 10px;">update 进程</a> <a href="/tags/write/" style="font-size: 10px;">write</a> <a href="/tags/wsgiref/" style="font-size: 10px;">wsgiref</a> <a href="/tags/yield/" style="font-size: 14.55px;">yield</a> <a href="/tags/中断/" style="font-size: 10.91px;">中断</a> <a href="/tags/任务调度/" style="font-size: 10px;">任务调度</a> <a href="/tags/传记/" style="font-size: 10.91px;">传记</a> <a href="/tags/信号/" style="font-size: 10px;">信号</a> <a href="/tags/信号量/" style="font-size: 10px;">信号量</a> <a href="/tags/内存对齐/" style="font-size: 10px;">内存对齐</a> <a href="/tags/内存映射-I-O/" style="font-size: 10px;">内存映射 I/O</a> <a href="/tags/内存规划/" style="font-size: 10px;">内存规划</a> <a href="/tags/内核/" style="font-size: 19.09px;">内核</a> <a href="/tags/内核栈/" style="font-size: 10px;">内核栈</a> <a href="/tags/分页/" style="font-size: 10px;">分页</a> <a href="/tags/加密/" style="font-size: 10.91px;">加密</a> <a href="/tags/加载/" style="font-size: 10.91px;">加载</a> <a href="/tags/协程/" style="font-size: 13.64px;">协程</a> <a href="/tags/可执行目标文件/" style="font-size: 10.91px;">可执行目标文件</a> <a href="/tags/可重定位目标文件/" style="font-size: 10px;">可重定位目标文件</a> <a href="/tags/同步/" style="font-size: 10px;">同步</a> <a href="/tags/商业/" style="font-size: 11.82px;">商业</a> <a href="/tags/地心坐标系/" style="font-size: 10px;">地心坐标系</a> <a href="/tags/多线程/" style="font-size: 10.91px;">多线程</a> <a href="/tags/多进程/" style="font-size: 10px;">多进程</a> <a href="/tags/字符串/" style="font-size: 10px;">字符串</a> <a href="/tags/存储器/" style="font-size: 10.91px;">存储器</a> <a href="/tags/宏/" style="font-size: 10px;">宏</a> <a href="/tags/寄存器/" style="font-size: 10px;">寄存器</a> <a href="/tags/开发环境/" style="font-size: 10px;">开发环境</a> <a href="/tags/异常/" style="font-size: 10px;">异常</a> <a href="/tags/异步/" style="font-size: 10px;">异步</a> <a href="/tags/引导块/" style="font-size: 10px;">引导块</a> <a href="/tags/引导程序/" style="font-size: 12.73px;">引导程序</a> <a href="/tags/归一化/" style="font-size: 10px;">归一化</a> <a href="/tags/微处理器/" style="font-size: 13.64px;">微处理器</a> <a href="/tags/总结/" style="font-size: 10px;">总结</a> <a href="/tags/情感分析/" style="font-size: 10px;">情感分析</a> <a href="/tags/扩容/" style="font-size: 10px;">扩容</a> <a href="/tags/指令集/" style="font-size: 10px;">指令集</a> <a href="/tags/指针/" style="font-size: 12.73px;">指针</a> <a href="/tags/数字签名/" style="font-size: 10px;">数字签名</a> <a href="/tags/数字证书/" style="font-size: 10px;">数字证书</a> <a href="/tags/整数/" style="font-size: 10px;">整数</a> <a href="/tags/文件系统/" style="font-size: 12.73px;">文件系统</a> <a href="/tags/时钟/" style="font-size: 10px;">时钟</a> <a href="/tags/时钟中断/" style="font-size: 10px;">时钟中断</a> <a href="/tags/时间衰减函数/" style="font-size: 10px;">时间衰减函数</a> <a href="/tags/权限/" style="font-size: 10px;">权限</a> <a href="/tags/标准输入/" style="font-size: 10px;">标准输入</a> <a href="/tags/标准输出/" style="font-size: 10px;">标准输出</a> <a href="/tags/标准错误输出/" style="font-size: 10px;">标准错误输出</a> <a href="/tags/栈帧/" style="font-size: 10px;">栈帧</a> <a href="/tags/栈溢出/" style="font-size: 10px;">栈溢出</a> <a href="/tags/根设备/" style="font-size: 10px;">根设备</a> <a href="/tags/母板/" style="font-size: 10px;">母板</a> <a href="/tags/汇编/" style="font-size: 10px;">汇编</a> <a href="/tags/浮点数/" style="font-size: 10px;">浮点数</a> <a href="/tags/消息摘要/" style="font-size: 10px;">消息摘要</a> <a href="/tags/特权级/" style="font-size: 10px;">特权级</a> <a href="/tags/环境变量/" style="font-size: 10px;">环境变量</a> <a href="/tags/生成器/" style="font-size: 14.55px;">生成器</a> <a href="/tags/用户栈/" style="font-size: 10px;">用户栈</a> <a href="/tags/相似度/" style="font-size: 10.91px;">相似度</a> <a href="/tags/硬盘/" style="font-size: 12.73px;">硬盘</a> <a href="/tags/硬链接/" style="font-size: 10px;">硬链接</a> <a href="/tags/管道/" style="font-size: 10px;">管道</a> <a href="/tags/系统调用/" style="font-size: 10px;">系统调用</a> <a href="/tags/索引/" style="font-size: 10px;">索引</a> <a href="/tags/缓冲区/" style="font-size: 10.91px;">缓冲区</a> <a href="/tags/缓冲区溢出/" style="font-size: 10px;">缓冲区溢出</a> <a href="/tags/缺页中断/" style="font-size: 10px;">缺页中断</a> <a href="/tags/网络/" style="font-size: 13.64px;">网络</a> <a href="/tags/翻译/" style="font-size: 14.55px;">翻译</a> <a href="/tags/虚拟地址空间/" style="font-size: 10px;">虚拟地址空间</a> <a href="/tags/虚拟盘/" style="font-size: 10px;">虚拟盘</a> <a href="/tags/请求项/" style="font-size: 10px;">请求项</a> <a href="/tags/质数/" style="font-size: 10px;">质数</a> <a href="/tags/超级块/" style="font-size: 10px;">超级块</a> <a href="/tags/软盘/" style="font-size: 10px;">软盘</a> <a href="/tags/软链接/" style="font-size: 10px;">软链接</a> <a href="/tags/进程派生/" style="font-size: 10px;">进程派生</a> <a href="/tags/进程通信/" style="font-size: 10.91px;">进程通信</a> <a href="/tags/迭代器/" style="font-size: 10px;">迭代器</a> <a href="/tags/金融/" style="font-size: 10px;">金融</a> <a href="/tags/阻塞/" style="font-size: 10.91px;">阻塞</a> <a href="/tags/非阻塞/" style="font-size: 10.91px;">非阻塞</a> <a href="/tags/黑客/" style="font-size: 10px;">黑客</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">谢宏峰，毕业于暨南大学（2009 - 2013）、中国科学院（2013 - 2016），现就职于深信服科技，从事 OpenStack 开发。</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Max</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/img/author.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Max</h1>
			</hgroup>
			
			<p class="header-subtitle">Stay hungry, stay foolish.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/categories/读书">读书</a></li>
		        
					<li><a href="/tags/翻译">翻译</a></li>
		        
					<li><a href="/categories/网络">网络</a></li>
		        
					<li><a href="/categories/并发">并发</a></li>
		        
					<li><a href="/categories/安全">安全</a></li>
		        
					<li><a href="/categories/运维">运维</a></li>
		        
					<li><a href="/categories/数据库">数据库</a></li>
		        
					<li><a href="/categories/云计算">云计算</a></li>
		        
					<li><a href="/categories/编程语言">编程语言</a></li>
		        
					<li><a href="/categories/操作系统">操作系统</a></li>
		        
					<li><a href="/categories/机器学习">机器学习</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/xiehongfeng100" title="github">github</a>
			        
						<a class="linkedin" target="_blank" href="http://cn.linkedin.com/in/xiehongfeng100" title="linkedin">linkedin</a>
			        
						<a class="mail" target="_blank" href="mailto:xiehongfeng100@yeah.net" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-openstack-neutron-server-startup" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/09/openstack-neutron-server-startup/" class="article-date">
  	<time datetime="2017-11-08T22:29:38.000Z" itemprop="datePublished">2017-11-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      OpenStack 源码系列之 Neutron：Neutron Server 启动
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Neutron/">Neutron</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenStack/">OpenStack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/网络/">网络</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/云计算/">云计算</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在我们正式开始之前，我们先来看一下博文<a href="http://www.cnblogs.com/CloudMan6/p/5778505.html" target="_blank" rel="noopener">两张图总结 Neutron 架构</a>总结的 Neutron 架构图（特别简明易懂）。</p>
<p><img src="/images/cloud-computation/openstack/neutron/neutron-server-startup/neutron-architecture.png" alt><br><em><a href="http://www.cnblogs.com/CloudMan6/p/5778505.html" target="_blank" rel="noopener">图片来源</a></em></p>
<p>这里我们关注的是 Neutron Server 那一部分的初始化。跟以前 Nova 源码分析一样，我们主要还是会用 UML 来进行代码的分析。</p>
<a id="more"></a>
<h1 id="PasteDeploy-特点"><a href="#PasteDeploy-特点" class="headerlink" title="PasteDeploy 特点"></a><strong>PasteDeploy 特点</strong></h1><p>这个特点其实在博文 <a href="http://xiehongfeng100.github.io/2017/05/20/python-web-paste-deploy/">PasteDeploy</a> 其实有说过，就是 PasteDeploy 中<code>初始化 pipeline 和调用 pipeline 的执行顺序是相反的</code>。以 Neutron 的 api-paste.ini 为例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[composite:neutronapi_v2_0]</span><br><span class="line">...</span><br><span class="line">keystone = ... extensions neutronapiapp_v2_0</span><br></pre></td></tr></table></figure></p>
<p><code>初始化该 pipeline(composite) 的顺序是 ...extensions.factory(neutronapiapp_v2_0.factory)，先执行的是（括号里）最后一个应用 neutronapiapp_v2_0 的函数 factory；而调用该 pipeline 就不一样了，执行顺序是 neutronapiapp_v2_0.__call__(extensions.__call__(...))，先执行的也是括号里的函数，最后执行的才是 neutronapiapp_v2_0 的函数 __call__。</code></p>
<p><strong>注：</strong>上边的 <code>__call__</code> 只是用来表示函数或类调用，实际不一定如此。</p>
<h1 id="Neutron-Server-启动概览"><a href="#Neutron-Server-启动概览" class="headerlink" title="Neutron Server 启动概览"></a><strong>Neutron Server 启动概览</strong></h1><p>其实，<code>Neutron Server 就是一个 WSGI Service，向外接收 REST API 请求，向内路由请求到具体的处理函数。</code></p>
<p>根据 setup.cfg (neutron-server) 及 api-paste.ini 文件，我们可以得到 Neutron Server 的启动概览：<br><img src="/images/cloud-computation/openstack/neutron/neutron-server-startup/neutron-server-startup.png" alt>  </p>
<h1 id="Neutron-API-Service-初始化"><a href="#Neutron-API-Service-初始化" class="headerlink" title="Neutron API Service 初始化"></a><strong>Neutron API Service 初始化</strong></h1><p>下文就分为 <code>APIRouter</code> 及 <code>Extensions Routes</code> 两部分进行分析。</p>
<p>在此之前，我们先来看一个 api-paste.ini 文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[composite:neutronapi_v2_0]</span><br><span class="line">...</span><br><span class="line">keystone = ... extensions neutronapiapp_v2_0</span><br><span class="line"></span><br><span class="line">[filter:extensions]</span><br><span class="line">paste.filter_factory = neutron.api.extensions:plugin_aware_extension_middleware_factory</span><br><span class="line"></span><br><span class="line">[app:neutronapiapp_v2_0]</span><br><span class="line">paste.app_factory = neutron.api.v2.router:APIRouter.factory</span><br></pre></td></tr></table></figure></p>
<p>按照 <code>PasteDeploy 中初始化 pipeline 和调用 pipeline 的执行顺序是相反的</code>的原则，neutronapiapp_v2_0 app 的初始化要早于 extensions app。我们也先从前者（APIRouter）开始说起。</p>
<h2 id="APIRouter"><a href="#APIRouter" class="headerlink" title="APIRouter"></a><strong>APIRouter</strong></h2><p>APIRouter 初始化核心代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIRouter</span><span class="params">(base_wsgi.Router)</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">factory</span><span class="params">(cls, global_config, **local_config)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls(**local_config)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, **local_config)</span>:</span></span><br><span class="line">        mapper = routes_mapper.Mapper()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1.</span></span><br><span class="line">        <span class="comment"># 初始化 NeutronManager，加载了 Core Plugin 及 Service Plugins</span></span><br><span class="line">        <span class="comment"># 而其中 Core Plugin 又会加载 type/mechanism/extension driver</span></span><br><span class="line">        manager.init()</span><br><span class="line"></span><br><span class="line">        plugin = directory.get_plugin()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2.</span></span><br><span class="line">        <span class="comment"># 初始化 PluginAwareExtensionManager (Extension Manager)</span></span><br><span class="line">        <span class="comment"># 实际加载了 neutron/extensions 目录下的所有 extension</span></span><br><span class="line">        ext_mgr = extensions.PluginAwareExtensionManager.get_instance()</span><br><span class="line">        ext_mgr.extend_resources(<span class="string">"2.0"</span>, attributes.RESOURCE_ATTRIBUTE_MAP)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3.</span></span><br><span class="line">        <span class="comment"># Core plugin 路由映射</span></span><br><span class="line">        col_kwargs = dict(collection_actions=COLLECTION_ACTIONS,</span><br><span class="line">                          member_actions=MEMBER_ACTIONS)</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_map_resource</span><span class="params">(collection, resource, params, parent=None)</span>:</span></span><br><span class="line">            allow_bulk = cfg.CONF.allow_bulk</span><br><span class="line">            controller = base.create_resource(</span><br><span class="line">                collection, resource, plugin, params, allow_bulk=allow_bulk,</span><br><span class="line">                parent=parent, allow_pagination=<span class="literal">True</span>,</span><br><span class="line">                allow_sorting=<span class="literal">True</span>)</span><br><span class="line">            path_prefix = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">if</span> parent:</span><br><span class="line">                path_prefix = <span class="string">"/%s/&#123;%s_id&#125;/%s"</span> % (parent[<span class="string">'collection_name'</span>],</span><br><span class="line">                                                  parent[<span class="string">'member_name'</span>],</span><br><span class="line">                                                  collection)</span><br><span class="line">            mapper_kwargs = dict(controller=controller,</span><br><span class="line">                                 requirements=REQUIREMENTS,</span><br><span class="line">                                 path_prefix=path_prefix,</span><br><span class="line">                                 **col_kwargs)</span><br><span class="line">            <span class="keyword">return</span> mapper.collection(collection, resource,</span><br><span class="line">                                     **mapper_kwargs)</span><br><span class="line"></span><br><span class="line">        mapper.connect(<span class="string">'index'</span>, <span class="string">'/'</span>, controller=Index(RESOURCES))</span><br><span class="line">        <span class="keyword">for</span> resource <span class="keyword">in</span> RESOURCES:</span><br><span class="line">            _map_resource(RESOURCES[resource], resource,</span><br><span class="line">                          attributes.RESOURCE_ATTRIBUTE_MAP.get(</span><br><span class="line">                              RESOURCES[resource], dict()))</span><br><span class="line">            resource_registry.register_resource_by_name(resource)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> resource <span class="keyword">in</span> SUB_RESOURCES:</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">        super(APIRouter, self).__init__(mapper)</span><br></pre></td></tr></table></figure></p>
<p>代码执行路径可用 UML 表示如下：</p>
<p><img src="/images/cloud-computation/openstack/neutron/neutron-server-startup/apirouter.png" alt>  </p>
<h3 id="NeutronManager"><a href="#NeutronManager" class="headerlink" title="NeutronManager"></a><strong>NeutronManager</strong></h3><h4 id="Core-Plugin"><a href="#Core-Plugin" class="headerlink" title="Core Plugin"></a><strong>Core Plugin</strong></h4><p>这里我们所指的 Core Plugin 是 ML2：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># /etc/neutron/neutron.conf</span><br><span class="line">[DEFAULT]</span><br><span class="line">core_plugin = ml2</span><br></pre></td></tr></table></figure></p>
<h5 id="ML2-简介"><a href="#ML2-简介" class="headerlink" title="ML2 简介"></a><strong>ML2 简介</strong></h5><p>博文 <a href="https://www.ibm.com/developerworks/cn/cloud/library/cl-cn-openstackneutronml2/index.html" target="_blank" rel="noopener">OpenStack Neutron ML2 Deep Dive</a> 对 ML2 有一个很简要的介绍：</p>
<blockquote>
<p>OpenStack Neutron 作为一种 SDN（Software Defined Network），在其内部使用 ML2 模块来管理 Layer2。ML2 全称是 Modular Layer 2。它是一个可以同时管理多种 Layer 2 技术的框架。在 OpenStack Neutron 的项目代码中，ML2 目前支持 Open vSwitch，linux bridge，SR-IOV 等虚拟化 Layer 2 技术。</p>
</blockquote>
<p>它解决了 Neutron 老版本（ML2 之前）存在的两个问题：</p>
<blockquote>
<ol>
<li>每支持一种 Layer 2 技术，对 OpenStack Neutron 中的 L2 resource（例如 Network/Subnet/Port）的逻辑需要进行一次重写，这大大增加了相应的工作量；</li>
<li>OpenStack Neutron 最多只支持一种 Layer 2 技术，也就是说如果配置使用了 Open vSwitch，那么整个 OpenStack 环境都只能使用 neutron-openvswitch-agent 作为 Layer 2 的管理服务与 Open vSwitch 交互。<br>ML2 的提出解决了上面两个问题。ML2 之前的 Layer 2 plugin 代码相同的部分被提取到了 ML2 plugin 中。这样，当一个新的 Layer 2 需要被 Neutron 支持时，只需要实现其特殊部分的代码，需要的代码工作大大减少，开发人员甚至不需要详细了解 Neutron 的具体实现机制，只需要实现对应的接口。</li>
</ol>
</blockquote>
<p>这样，ML2 通过其中的 Mechanism drivers 可以同时管理多种 Layer 2 技术，如下图：<br><img src="/images/cloud-computation/openstack/neutron/neutron-server-startup/ml2-n-l2agents.png" alt><br><em>图片来源：<a href="https://www.ibm.com/developerworks/cn/cloud/library/cl-cn-openstackneutronml2/index.html" target="_blank" rel="noopener">OpenStack Neutron ML2 Deep Dive</a></em></p>
<p>ML2 的框架如下图所示：<br><img src="/images/cloud-computation/openstack/neutron/neutron-server-startup/ml2-framework.png" alt><br><em>图片来源：<a href="https://www.ibm.com/developerworks/cn/cloud/library/cl-cn-openstackneutronml2/index.html" target="_blank" rel="noopener">OpenStack Neutron ML2 Deep Dive</a></em></p>
<p>其中，该博客还对框架中各模块有一个简介（简单汇总了下）：</p>
<blockquote>
<ul>
<li>ML2 plugin：所有对 Neutron 中 L2 resource 操作的入口，实现文件是 neutron/plugins/ml2/plugin.py。</li>
<li>Extensions drivers：extensions drivers 就是建立 Neutron 中 L2 resource 与其他 resource 之间的联系。当创建、更新或删除 Neutron 中 L2 resource 时，对应的 extensions driver 会被执行，并更新对应的其他 resource。同时 extensions drivers 还会将其他 resource 与 Neutron L2 resource 的关联报告给 ML2 plugin，这样，用户在查看 Port 信息的时候，就能看到对应的 Security Group。</li>
<li>Types drivers：物理环境中的 L2 网络类型有很多种，而在虚拟网络 OpenStack Neutron 中，也支持多种网络类型。这些网络类型的支持由 ML2 的 types drivers 来完成。</li>
<li>Mechanism drivers：这部分是对各种 L2 技术的支持，例如 Open vSwitch，linux bridge 等等。最近流行的 OVN 也是作为一个 mechanism driver，通过 ML2 与 OpenStack Neutron 工作。</li>
<li>RPC：这是 ML2 与 L2 agents 通讯的部分，是基于 AMQP 的实现。例如，删除 Network，需要通过 rpc 通知 L2 agents 也删除相应的流表，虚拟端口等等。</li>
</ul>
</blockquote>
<h5 id="初始化概览"><a href="#初始化概览" class="headerlink" title="初始化概览"></a><strong>初始化概览</strong></h5><p>ML2 初始化部分概览如下：<br><img src="/images/cloud-computation/openstack/neutron/neutron-server-startup/ml2_plugin.png" alt>  </p>
<p>上图中重要的除了一些 driver 的加载，还有一点值得说的是 Neutron 所用的 Callback System。这部分因为在 Service Plugin 也会涉及，所以我们放到本文最后一起说。</p>
<h5 id="DHCP"><a href="#DHCP" class="headerlink" title="DHCP"></a><strong>DHCP</strong></h5><p>这里很重要的一点就是初始化 DHCP，导入 network_scheduler_driver：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/plugins/ml2/plugin.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ml2Plugin</span><span class="params">(...)</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    @<span class="title">resource_registry</span>.<span class="title">tracked_resources</span><span class="params">(...)</span></span></span><br><span class="line"><span class="class">    <span class="title">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        ...</span><br><span class="line">        self._setup_dhcp()</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_setup_dhcp</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Initialize components to support DHCP."""</span></span><br><span class="line">        self.network_scheduler = importutils.import_object(</span><br><span class="line">            cfg.CONF.network_scheduler_driver</span><br><span class="line">        )</span><br><span class="line">        self.add_periodic_dhcp_agent_status_check()</span><br></pre></td></tr></table></figure></p>
<h5 id="RPC-Notifiers"><a href="#RPC-Notifiers" class="headerlink" title="RPC Notifiers"></a><strong>RPC Notifiers</strong></h5><p>在前边初始化分析 Core Plugin 的时候（UML）的时候就已经提到初始化 Core Plugin 的时候就会初始化 RPC Notifiers：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/plugins/ml2/plugin.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ml2Plugin</span><span class="params">(...)</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    @<span class="title">resource_registry</span>.<span class="title">tracked_resources</span><span class="params">(...)</span></span></span><br><span class="line"><span class="class">    <span class="title">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        ...</span><br><span class="line">        self._start_rpc_notifiers()</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line"><span class="meta">    @log_helpers.log_method_call</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_start_rpc_notifiers</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Initialize RPC notifiers for agents."""</span></span><br><span class="line">        self.ovo_notifier = ovo_rpc.OVOServerRpcInterface()	<span class="comment"># ovo -&gt; oslo versioned object</span></span><br><span class="line">        self.notifier = rpc.AgentNotifierApi(topics.AGENT)</span><br><span class="line">        self.agent_notifiers[const.AGENT_TYPE_DHCP] = (</span><br><span class="line">            dhcp_rpc_agent_api.DhcpAgentNotifyAPI()</span><br><span class="line">        )</span><br></pre></td></tr></table></figure></p>
<h4 id="Service-Plugins"><a href="#Service-Plugins" class="headerlink" title="Service Plugins"></a><strong>Service Plugins</strong></h4><p>Service Plugins 比较多，如我们在 setup.cfg 文件就可以看到声明的诸多 plugin：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># setup.cfg</span><br><span class="line">neutron.service_plugins =</span><br><span class="line">    dummy = neutron.tests.unit.dummy_plugin:DummyServicePlugin</span><br><span class="line">    router = neutron.services.l3_router.l3_router_plugin:L3RouterPlugin</span><br><span class="line">    metering = neutron.services.metering.metering_plugin:MeteringPlugin</span><br><span class="line">    qos = neutron.services.qos.qos_plugin:QoSPlugin</span><br><span class="line">    tag = neutron.services.tag.tag_plugin:TagPlugin</span><br><span class="line">    flavors = neutron.services.flavors.flavors_plugin:FlavorsPlugin</span><br><span class="line">    auto_allocate = neutron.services.auto_allocate.plugin:Plugin</span><br><span class="line">    segments = neutron.services.segments.plugin:Plugin</span><br><span class="line">    network_ip_availability = neutron.services.network_ip_availability.plugin:NetworkIPAvailabilityPlugin</span><br><span class="line">    revisions = neutron.services.revisions.revision_plugin:RevisionPlugin</span><br><span class="line">    timestamp = neutron.services.timestamp.timestamp_plugin:TimeStampPlugin</span><br><span class="line">    trunk = neutron.services.trunk.plugin:TrunkPlugin</span><br><span class="line">    loki = neutron.services.loki.loki_plugin:LokiPlugin</span><br></pre></td></tr></table></figure></p>
<p>但<code>实际只加载 cfg.CONF.service_plugins 及 DEFAULT_SERVICE_PLUGINS 所限定的。</code></p>
<p>下边我们以 L3RouterPlugin 为例来做一个简要说明。</p>
<h5 id="L3-Router-Plugin"><a href="#L3-Router-Plugin" class="headerlink" title="L3 Router Plugin"></a><strong>L3 Router Plugin</strong></h5><p>一个粗略的加载图如下：<br><img src="/images/cloud-computation/openstack/neutron/neutron-server-startup/l3_router_plugin.png" alt>  </p>
<p>Service Plugin 的详细加载就不细说了，我们会在后续博文中单位为一些重要的 plguin 做分析，那时再做详细解析。</p>
<h5 id="RPC-Notifiers-1"><a href="#RPC-Notifiers-1" class="headerlink" title="RPC Notifiers"></a><strong>RPC Notifiers</strong></h5><p>如 L3 Router Plugin 定义的 RPC Notifiers 如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">L3RouterPlugin</span><span class="params">(...)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"><span class="meta">    @resource_registry.tracked_resources(...)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        ...</span><br><span class="line">        self.agent_notifiers.update(</span><br><span class="line">            &#123;n_const.AGENT_TYPE_L3: l3_rpc_agent_api.L3AgentNotifyAPI()&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="Extension-Manager"><a href="#Extension-Manager" class="headerlink" title="Extension Manager"></a><strong>Extension Manager</strong></h3><p>在 APIRouter 初始化完 Core Plugin 和 Service Plugins 之后就是加载 PluginAwareExtensionManager(Extension Manager)，进一步又会把 <code>neutron/extensions</code> 目录下的 Extension(<code>API</code>) 都加载，具体如下：<br><img src="/images/cloud-computation/openstack/neutron/neutron-server-startup/extensions_loading.png" alt>  </p>
<h3 id="Core-Plugin-Routes"><a href="#Core-Plugin-Routes" class="headerlink" title="Core Plugin Routes"></a><strong>Core Plugin Routes</strong></h3><p>加载完 Core Plugin 及 Service Plugins 之后，接下来一步就是建立路由映射了，不过这里的路由映射<code>只做了 Core Plugin 的路由映射（network/subnet/subnetpool/port）</code>。具体看代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/api/v2/router.py</span></span><br><span class="line">RESOURCES = &#123;<span class="string">'network'</span>: <span class="string">'networks'</span>,</span><br><span class="line">             <span class="string">'subnet'</span>: <span class="string">'subnets'</span>,</span><br><span class="line">             <span class="string">'subnetpool'</span>: <span class="string">'subnetpools'</span>,</span><br><span class="line">             <span class="string">'port'</span>: <span class="string">'ports'</span>&#125;	<span class="comment"># !!!important</span></span><br><span class="line">SUB_RESOURCES = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIRouter</span><span class="params">(base_wsgi.Router)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, **local_config)</span>:</span></span><br><span class="line">        mapper = routes_mapper.Mapper()</span><br><span class="line">        ...</span><br><span class="line">        plugin = directory.get_plugin()	<span class="comment"># get the core plugin instance</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        col_kwargs = dict(collection_actions=COLLECTION_ACTIONS,</span><br><span class="line">                          member_actions=MEMBER_ACTIONS)</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_map_resource</span><span class="params">(collection, resource, params, parent=None)</span>:</span></span><br><span class="line">            allow_bulk = cfg.CONF.allow_bulk</span><br><span class="line">            <span class="comment"># collection 为资源复数形式，如 networks; resource 为资源单数形式，如 network。</span></span><br><span class="line">            controller = base.create_resource(</span><br><span class="line">                collection, resource, plugin, params, allow_bulk=allow_bulk,</span><br><span class="line">                parent=parent, allow_pagination=<span class="literal">True</span>,</span><br><span class="line">                allow_sorting=<span class="literal">True</span>)</span><br><span class="line">            path_prefix = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">if</span> parent:</span><br><span class="line">                path_prefix = <span class="string">"/%s/&#123;%s_id&#125;/%s"</span> % (parent[<span class="string">'collection_name'</span>],</span><br><span class="line">                                                  parent[<span class="string">'member_name'</span>],</span><br><span class="line">                                                  collection)</span><br><span class="line">            mapper_kwargs = dict(controller=controller,</span><br><span class="line">                                 requirements=REQUIREMENTS,</span><br><span class="line">                                 path_prefix=path_prefix,</span><br><span class="line">                                 **col_kwargs)</span><br><span class="line">            <span class="keyword">return</span> mapper.collection(collection, resource,</span><br><span class="line">                                     **mapper_kwargs)</span><br><span class="line"></span><br><span class="line">        mapper.connect(<span class="string">'index'</span>, <span class="string">'/'</span>, controller=Index(RESOURCES))</span><br><span class="line">        <span class="keyword">for</span> resource <span class="keyword">in</span> RESOURCES:	<span class="comment"># !!!important</span></span><br><span class="line">            _map_resource(RESOURCES[resource], resource,</span><br><span class="line">                          attributes.RESOURCE_ATTRIBUTE_MAP.get(</span><br><span class="line">                              RESOURCES[resource], dict()))</span><br><span class="line">            resource_registry.register_resource_by_name(resource)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> resource <span class="keyword">in</span> SUB_RESOURCES:</span><br><span class="line">            ...</span><br></pre></td></tr></table></figure></p>
<p>关于路由映射可参考之前博文 <a href="http://xiehongfeng100.github.io/2017/05/20/python-web-routes/">routes</a>。不过这里想重点说一下 <code>create_resource</code> 这个函数，它返回的是一个 (WSGI) Controller。这个函数很重要，Core Plugin、Extensions 路由映射都会调用它。下边我们来重点看下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/api/v2/base.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_resource</span><span class="params">(collection, resource, plugin, params, allow_bulk=False,</span></span></span><br><span class="line"><span class="function"><span class="params">                    member_actions=None, parent=None, allow_pagination=False,</span></span></span><br><span class="line"><span class="function"><span class="params">                    allow_sorting=False)</span>:</span></span><br><span class="line">    controller = Controller(plugin, collection, resource, params, allow_bulk,</span><br><span class="line">                            member_actions=member_actions, parent=parent,</span><br><span class="line">                            allow_pagination=allow_pagination,</span><br><span class="line">                            allow_sorting=allow_sorting)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wsgi_resource.Resource(controller, FAULT_MAP)</span><br></pre></td></tr></table></figure></p>
<p>如果我们看一下 Controller 这个类，我们很容易就可以看出它究竟做的是什么事情了：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/api/v2/base.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Controller</span><span class="params">(object)</span>:</span></span><br><span class="line">    LIST = <span class="string">'list'</span></span><br><span class="line">    SHOW = <span class="string">'show'</span></span><br><span class="line">    CREATE = <span class="string">'create'</span></span><br><span class="line">    UPDATE = <span class="string">'update'</span></span><br><span class="line">    DELETE = <span class="string">'delete'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, plugin, collection, resource, attr_info,</span></span></span><br><span class="line"><span class="function"><span class="params">                 allow_bulk=False, member_actions=None, parent=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 allow_pagination=False, allow_sorting=False)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> member_actions <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            member_actions = []</span><br><span class="line">        self._plugin = plugin	<span class="comment"># 实际执行者，Core Plugin 或 Service Plugin</span></span><br><span class="line">        self._collection = collection.replace(<span class="string">'-'</span>, <span class="string">'_'</span>)</span><br><span class="line">        self._resource = resource.replace(<span class="string">'-'</span>, <span class="string">'_'</span>)</span><br><span class="line">        ...</span><br><span class="line">        self._member_actions = member_actions</span><br><span class="line">        ...</span><br><span class="line">        self.parent = parent</span><br><span class="line">        <span class="keyword">if</span> parent:</span><br><span class="line">            self._parent_id_name = <span class="string">'%s_id'</span> % parent[<span class="string">'member_name'</span>]</span><br><span class="line">            parent_part = <span class="string">'_%s'</span> % parent[<span class="string">'member_name'</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._parent_id_name = <span class="literal">None</span></span><br><span class="line">            parent_part = <span class="string">''</span></span><br><span class="line">        self._plugin_handlers = &#123;</span><br><span class="line">            self.LIST: <span class="string">'get%s_%s'</span> % (parent_part, self._collection),</span><br><span class="line">            self.SHOW: <span class="string">'get%s_%s'</span> % (parent_part, self._resource)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> action <span class="keyword">in</span> [self.CREATE, self.UPDATE, self.DELETE]:</span><br><span class="line">            self._plugin_handlers[action] = <span class="string">'%s%s_%s'</span> % (action, parent_part,</span><br><span class="line">                                                         self._resource)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @db_api.retry_db_errors</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""Returns a list of the requested entity."""</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line"><span class="meta">    @db_api.retry_db_errors</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self, request, id, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""Returns detailed information about the requested entity."""</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, request, body=None, **kwargs)</span>:</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> self._create(request, body, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @db_api.retry_db_errors</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_create</span><span class="params">(self, request, body, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""Creates a new instance of the requested entity."""</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(self, request, id, body=None, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""Updates the specified entity's attributes."""</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, request, id, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""Deletes the specified entity."""</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure></p>
<p>也就是说，它定义了一些资源的常见操作（CRUD），然后再根据具体资源及 action 将这些操作映射到对 plugin (Core Plguin or Service Plugin) 的真正操作上，如 show 函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/api/v2/base.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Controller</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="meta">    @db_api.retry_db_errors</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self, request, id, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""Returns detailed information about the requested entity."""</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">return</span> &#123;..., self._item(...)&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_item</span><span class="params">(self, request, id, do_authz=False, field_list=None,</span></span></span><br><span class="line"><span class="function"><span class="params">              parent_id=None)</span>:</span></span><br><span class="line">        <span class="string">"""Retrieves and formats a single element of the requested entity."""</span></span><br><span class="line">        kwargs = &#123;<span class="string">'fields'</span>: field_list&#125;</span><br><span class="line">        action = self._plugin_handlers[self.SHOW]</span><br><span class="line">        <span class="keyword">if</span> parent_id:</span><br><span class="line">            kwargs[self._parent_id_name] = parent_id</span><br><span class="line">        obj_getter = getattr(self._plugin, action)</span><br><span class="line">        obj = obj_getter(request.context, id, **kwargs)</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> obj</span><br></pre></td></tr></table></figure></p>
<p>这样确实能够统一处理所有 plugin 的路由映射了，只要它们的 action 符合这个 Controller 定义的标准即可。但是也正因为路由构造如此高度抽象，一开始看很容易看晕…</p>
<p>不过，<code>这个 Controller 还不是一个 WSGI 应用，需要继续进一步包装</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/api/v2/base.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_resource</span><span class="params">(collection, resource, plugin, params, allow_bulk=False,</span></span></span><br><span class="line"><span class="function"><span class="params">                    member_actions=None, parent=None, allow_pagination=False,</span></span></span><br><span class="line"><span class="function"><span class="params">                    allow_sorting=False)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> wsgi_resource.Resource(controller, FAULT_MAP)</span><br><span class="line"></span><br><span class="line"><span class="comment"># neutron/api/v2/resource.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Resource</span><span class="params">(controller, ...)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"><span class="meta">    @webob.dec.wsgify(RequestClass=Request)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">resource</span><span class="params">(request)</span>:</span>	<span class="comment"># 类似于下例中 BaseController 的 __call__ 函数</span></span><br><span class="line">        route_args = request.environ.get(<span class="string">'wsgiorg.routing_args'</span>)</span><br><span class="line">        <span class="keyword">if</span> route_args:</span><br><span class="line">            args = route_args[<span class="number">1</span>].copy()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            args = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        action = args.pop(<span class="string">'action'</span>, <span class="literal">None</span>)</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ...</span><br><span class="line">            method = getattr(controller, action)</span><br><span class="line">            result = method(request=request, **args)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> webob.Response(request=request, status=status,</span><br><span class="line">                              content_type=content_type,</span><br><span class="line">                              body=body)</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> resource</span><br></pre></td></tr></table></figure></p>
<p>一看就很熟悉对不对？我们只要比较一下 OpenStack 其他模块（如 Nova）常用的路由 <a href="http://xiehongfeng100.github.io/2017/05/20/python-web-routes/#Routes_in_OpenStack">Controller 构造方法</a>就很清楚了（样例）：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> webob.dec</span><br><span class="line"><span class="keyword">import</span> webob.exc</span><br><span class="line"><span class="keyword">import</span> routes.middleware</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Environment variable used to pass the request context</span></span><br><span class="line">CONTEXT_ENV = <span class="string">'openstack.context'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Environment variable used to pass the request params</span></span><br><span class="line">PARAMS_ENV = <span class="string">'openstack.params'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseController</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_normalize_arg</span><span class="params">(self, arg)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> arg.replace(<span class="string">':'</span>, <span class="string">'_'</span>).replace(<span class="string">'-'</span>, <span class="string">'_'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_normalize_dict</span><span class="params">(self, d)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> &#123;self._normalize_arg(k): v <span class="keyword">for</span> (k, v) <span class="keyword">in</span> d.items()&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_render_response</span><span class="params">(self, body=None, status=None, method=None)</span>:</span></span><br><span class="line">        <span class="string">'''Form a WSGI response.'''</span></span><br><span class="line">        resp = webob.Response(body=body, status=status)</span><br><span class="line">        resp.method = method</span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="meta">    @webob.dec.wsgify</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, req)</span>:</span></span><br><span class="line">        arg_dict = req.environ[<span class="string">'wsgiorg.routing_args'</span>][<span class="number">1</span>]</span><br><span class="line">        action = arg_dict.pop(<span class="string">'action'</span>)</span><br><span class="line">        <span class="keyword">del</span> arg_dict[<span class="string">'controller'</span>]</span><br><span class="line"></span><br><span class="line">        params = req.environ.get(PARAMS_ENV, &#123;&#125;)</span><br><span class="line">        params.update(arg_dict)</span><br><span class="line"></span><br><span class="line">        method = getattr(self, action)</span><br><span class="line">        params = self._normalize_dict(params)</span><br><span class="line">        result = method(req, **params)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self._render_response(body=result.body, status=result.status, method=req.method)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span><span class="params">(BaseController)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_user</span><span class="params">(self, req, user_id)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> webob.Response(<span class="string">'I am a user, my ID is %s.'</span> % user_id)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TenantController</span><span class="params">(BaseController)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_tenant</span><span class="params">(self, req, tenant_id)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> webob.Response(<span class="string">'I am a tenant, my ID is %s.'</span> % tenant_id)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._mapper = routes.Mapper()</span><br><span class="line">        self._mapper.connect(<span class="string">'/users/&#123;user_id&#125;'</span>,</span><br><span class="line">                             controller=UserController(),</span><br><span class="line">                             action=<span class="string">'get_user'</span>,</span><br><span class="line">                             conditions=&#123;<span class="string">'method'</span>: [<span class="string">'GET'</span>]&#125;)</span><br><span class="line">        self._mapper.connect(<span class="string">'/tenants/&#123;tenant_id&#125;'</span>,</span><br><span class="line">                             controller=TenantController(),</span><br><span class="line">                             action=<span class="string">'get_tenant'</span>,</span><br><span class="line">                             conditions=&#123;<span class="string">'method'</span>: [<span class="string">'GET'</span>]&#125;)</span><br><span class="line"></span><br><span class="line">        self._router = routes.middleware.RoutesMiddleware(self._dispatch, self._mapper)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @webob.dec.wsgify</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, req)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._router</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line"><span class="meta">    @webob.dec.wsgify</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_dispatch</span><span class="params">(req)</span>:</span></span><br><span class="line">        match = req.environ[<span class="string">'wsgiorg.routing_args'</span>][<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> match:</span><br><span class="line">            <span class="keyword">return</span> webob.exc.HTTPNotFound()</span><br><span class="line"></span><br><span class="line">        app = match[<span class="string">'controller'</span>]</span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router = Router()</span><br><span class="line">httpd = make_server(<span class="string">'localhost'</span>, <span class="number">8080</span>, router)</span><br><span class="line">httpd.serve_forever()</span><br></pre></td></tr></table></figure></p>
<h2 id="Extensions-Routes"><a href="#Extensions-Routes" class="headerlink" title=" Extensions Routes"></a><strong> Extensions Routes</strong></h2><p>虽然前边 Service Plugins 已经加载完毕了，但它们的路由还没建立…</p>
<p>本文一开始就在提到 <code>PasteDeploy 中初始化 pipeline 和调用 pipeline 的执行顺序是相反的</code>，这也就是为什么在 api-paste.ini 中 extensions app 的初始化要在 neutronapiapp_v2_0 app 之后。且看详细：：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[composite:neutronapi_v2_0]</span><br><span class="line">...</span><br><span class="line">keystone = ... extensions neutronapiapp_v2_0</span><br><span class="line"></span><br><span class="line">[filter:extensions]</span><br><span class="line">paste.filter_factory = neutron.api.extensions:plugin_aware_extension_middleware_factory</span><br></pre></td></tr></table></figure></p>
<p>下边就直接以代码来说明。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/api/extensions.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plugin_aware_extension_middleware_factory</span><span class="params">(global_config, **local_config)</span>:</span></span><br><span class="line">    <span class="string">"""Paste factory."""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_factory</span><span class="params">(app)</span>:</span></span><br><span class="line">        ext_mgr = PluginAwareExtensionManager.get_instance()	<span class="comment"># 这一步已经在 APIRouter 中初始化了，直接返回</span></span><br><span class="line">        <span class="keyword">return</span> ExtensionMiddleware(app, ext_mgr=ext_mgr)</span><br><span class="line">    <span class="keyword">return</span> _factory</span><br></pre></td></tr></table></figure></p>
<p>也就是说，这里分成了两步，第 1 步是加载扩展 Extension Manager，第 2 步才是做路由映射。第 1 步已经在 APIRouter 中完成了，接下来我们要看的是第 2 步。</p>
<p>直接上代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/api/extensions.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtensionMiddleware</span><span class="params">(base.ConfigurableMiddleware)</span>:</span></span><br><span class="line">    <span class="string">"""Extensions middleware for WSGI."""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, application,</span></span></span><br><span class="line"><span class="function"><span class="params">                 ext_mgr=None)</span>:</span></span><br><span class="line">        self.ext_mgr = (ext_mgr <span class="keyword">or</span> ExtensionManager(get_extensions_path()))	<span class="comment"># 在 APIRouter 已初始化过</span></span><br><span class="line">        mapper = routes.Mapper()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># extended resources</span></span><br><span class="line">        <span class="keyword">for</span> resource <span class="keyword">in</span> self.ext_mgr.get_resources():	<span class="comment"># !!! get_resources 函数是重点</span></span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="comment"># !!! 重点</span></span><br><span class="line">            mapper.resource(resource.collection, resource.collection,</span><br><span class="line">                            controller=resource.controller,</span><br><span class="line">                            member=resource.member_actions,</span><br><span class="line">                            parent_resource=resource.parent,</span><br><span class="line">                            path_prefix=path_prefix)</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        self._router = routes.middleware.RoutesMiddleware(self._dispatch, mapper)</span><br><span class="line">        super(ExtensionMiddleware, self).__init__(application)</span><br></pre></td></tr></table></figure></p>
<p>self.ext_mgr.get_resources() 实际调用的是每个 extension 的 get_resources 函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/api/extensions.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtensionMiddleware</span><span class="params">(base.ConfigurableMiddleware)</span>:</span></span><br><span class="line">    <span class="string">"""Extensions middleware for WSGI."""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_resources</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Returns a list of ResourceExtension objects."""</span></span><br><span class="line">        resources = []</span><br><span class="line">        <span class="comment"># 添加一个 extension 本身的 CRUD，如 list extensions 可以拿到</span></span><br><span class="line">        <span class="comment"># neutron 所加载的 extension 列表，命令行为 neutron ext-list</span></span><br><span class="line">        resources.append(ResourceExtension(<span class="string">'extensions'</span>, ExtensionController(self)))</span><br><span class="line">        <span class="comment"># 一个个调用 extension 的 get_resources 函数</span></span><br><span class="line">        <span class="keyword">for</span> ext <span class="keyword">in</span> self.extensions.values():</span><br><span class="line">            resources.extend(ext.get_resources())</span><br><span class="line">        <span class="keyword">return</span> resources</span><br></pre></td></tr></table></figure></p>
<p>下边我们以 L3 extension 为例来说明实际的路由映射是怎么做的。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/extensions/l3.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">L3</span><span class="params">(extensions.ExtensionDescriptor)</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_resources</span><span class="params">(cls)</span>:</span></span><br><span class="line">        <span class="string">"""Returns Ext Resources."""</span></span><br><span class="line">        plural_mappings = resource_helper.build_plural_mappings(</span><br><span class="line">            &#123;&#125;, RESOURCE_ATTRIBUTE_MAP)</span><br><span class="line">        <span class="comment"># member actions</span></span><br><span class="line">        action_map = &#123;<span class="string">'router'</span>: &#123;<span class="string">'add_router_interface'</span>: <span class="string">'PUT'</span>,</span><br><span class="line">                                 <span class="string">'remove_router_interface'</span>: <span class="string">'PUT'</span>&#125;&#125;</span><br><span class="line">        <span class="keyword">return</span> resource_helper.build_resource_info(plural_mappings,</span><br><span class="line">                                                   RESOURCE_ATTRIBUTE_MAP,</span><br><span class="line">                                                   constants.L3,</span><br><span class="line">                                                   action_map=action_map,</span><br><span class="line">                                                   register_quota=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># neutron/api/v2/resource_helper.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_resource_info</span><span class="params">(plural_mappings, resource_map, which_service,</span></span></span><br><span class="line"><span class="function"><span class="params">                        action_map=None, register_quota=False,</span></span></span><br><span class="line"><span class="function"><span class="params">                        translate_name=False, allow_bulk=False)</span>:</span></span><br><span class="line">    <span class="string">"""Build resources for advanced services.</span></span><br><span class="line"><span class="string">       ...</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    resources = []</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> which_service:</span><br><span class="line">        which_service = constants.CORE</span><br><span class="line">    <span class="keyword">if</span> action_map <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        action_map = &#123;&#125;</span><br><span class="line">    <span class="comment"># !!! 重要</span></span><br><span class="line">    plugin = directory.get_plugin(which_service)</span><br><span class="line">    path_prefix = getattr(plugin, <span class="string">"path_prefix"</span>, <span class="string">""</span>)</span><br><span class="line">    LOG.debug(<span class="string">'Service %(service)s assigned prefix: %(prefix)s'</span>,</span><br><span class="line">              &#123;<span class="string">'service'</span>: which_service, <span class="string">'prefix'</span>: path_prefix&#125;)</span><br><span class="line">    <span class="keyword">for</span> collection_name <span class="keyword">in</span> resource_map:</span><br><span class="line">        resource_name = plural_mappings[collection_name]</span><br><span class="line">        params = resource_map.get(collection_name, &#123;&#125;)</span><br><span class="line">        <span class="keyword">if</span> translate_name:</span><br><span class="line">            collection_name = collection_name.replace(<span class="string">'_'</span>, <span class="string">'-'</span>)</span><br><span class="line">        <span class="keyword">if</span> register_quota:</span><br><span class="line">            resource_registry.register_resource_by_name(resource_name)</span><br><span class="line">        member_actions = action_map.get(resource_name, &#123;&#125;)</span><br><span class="line">        <span class="comment"># !!! 重要</span></span><br><span class="line">        controller = base.create_resource(</span><br><span class="line">            collection_name, resource_name, plugin, params,</span><br><span class="line">            member_actions=member_actions,</span><br><span class="line">            allow_bulk=allow_bulk,</span><br><span class="line">            allow_pagination=<span class="literal">True</span>,</span><br><span class="line">            allow_sorting=<span class="literal">True</span>)</span><br><span class="line">        resource = extensions.ResourceExtension(</span><br><span class="line">            collection_name,</span><br><span class="line">            controller,</span><br><span class="line">            path_prefix=path_prefix,</span><br><span class="line">            member_actions=member_actions,</span><br><span class="line">            attr_map=params)</span><br><span class="line">        resources.append(resource)</span><br><span class="line">    <span class="keyword">return</span> resources</span><br></pre></td></tr></table></figure></p>
<p>上边有两个地方很重：</p>
<ol>
<li>获取 plugin，这里具体获取的是 neutron.services.l3_router.l3_router_plugin.L3RouterPlugin，它的初始化在前文说过了；</li>
<li>extension 的路由映射和 Core Plugin 一样最终都会调用 <code>create_resource</code> 这个函数。接下来的步骤参考 Core Plugin 的就行了。</li>
</ol>
<p><strong>注：</strong>如果我们仔细看，有些 Extension（如 timestamp） 的 get_resources 返回的是一个空列表，也就是说，这些 Extension 不会做路由映射。</p>
<h2 id="Extension-与-Service-Plugin-关系"><a href="#Extension-与-Service-Plugin-关系" class="headerlink" title="Extension 与 Service Plugin 关系"></a><strong>Extension 与 Service Plugin 关系</strong></h2><p>对于 Core Plugin 来说，它的路由映射是单独做的，不容易误解；但<code>对 Service Plugin 来说，它的路由是由 Extension 来做的。把 Extension 成为 Extension API 更为合适。</code></p>
<p>API 与 Plugin 之间的关系可参考陈沙克老师画的一张<a href="http://www.chenshake.com/openstack-superficial-understanding-of-neutron-network/" target="_blank" rel="noopener">图</a>：<br><img src="/images/cloud-computation/openstack/neutron/neutron-server-startup/routes-n-plugins.png" alt>  </p>
<h1 id="服务启动"><a href="#服务启动" class="headerlink" title="服务启动"></a><strong>服务启动</strong></h1><p>这里的服务指的是 <code>NeutronAPIServie、RPC 以及 Plugins（Core Plugin &amp; Service Plugin）</code>。服务启动部分我们在 <code>&quot;Neutron Server 启动概览&quot;</code> 部分的 UML 图中均有体现出来（<code>_run_wsgi</code> 及 <code>start_api_and_rpc_workers</code> 函数）。涉及代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/server/wsgi_eventlet.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eventlet_wsgi_server</span><span class="params">()</span>:</span></span><br><span class="line">    neutron_api = service.serve_wsgi(service.NeutronApiService)</span><br><span class="line">    start_api_and_rpc_workers(neutron_api)</span><br></pre></td></tr></table></figure></p>
<h2 id="NeutronApiService"><a href="#NeutronApiService" class="headerlink" title="NeutronApiService"></a><strong>NeutronApiService</strong></h2><p>NeutronApiService 的启动在 <code>_run_wsgi</code> 函数中：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/service.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_run_wsgi</span><span class="params">(app_name)</span>:</span></span><br><span class="line">    app = config.load_paste_app(app_name)	<span class="comment"># 初始化 NeutronApiService 前文已经分析过</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> run_wsgi_app(app)</span><br></pre></td></tr></table></figure></p>
<p>它做的第 1 件事初始化 NeutronApiService 前文已经分析过，接下来我们要来看一下它如何启动 NeutronApiService：</p>
<p>下边我们就以启动 NeutronApiService 为例来说明启动详细过程（不包括 evenlet 部分）：<br><img src="/images/cloud-computation/openstack/neutron/neutron-server-startup/launch-neutron-api-service.png" alt>  </p>
<h2 id="Plugins-RPC-Listeners-amp-Workers"><a href="#Plugins-RPC-Listeners-amp-Workers" class="headerlink" title="Plugins RPC Listeners &amp; Workers"></a><strong>Plugins RPC Listeners &amp; Workers</strong></h2><p>这里的 Plugins 包括了 Core Plugin 及 Service Plugins。它们的 RPC Listeners &amp; Workers 启动在 <code>start_api_and_rpc_workers</code> 的函数中：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/server/wsgi_eventlet.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eventlet_wsgi_server</span><span class="params">()</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    start_api_and_rpc_workers(neutron_api)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_api_and_rpc_workers</span><span class="params">(neutron_api)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        worker_launcher = service.start_all_workers()</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># neutron/service.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_all_workers</span><span class="params">()</span>:</span></span><br><span class="line">    workers = _get_rpc_workers() + _get_plugins_workers()</span><br><span class="line">    <span class="keyword">return</span> _start_workers(workers)</span><br></pre></td></tr></table></figure></p>
<p>详细分析见如下的 UML 图：<br><img src="/images/cloud-computation/openstack/neutron/neutron-server-startup/launch-plugins-rpc-listeners-n-workers.png" alt>  </p>
<h3 id="RPC-Listeners-Workers"><a href="#RPC-Listeners-Workers" class="headerlink" title="RPC Listeners(Workers)"></a><strong>RPC Listeners(Workers)</strong></h3><p>这里我们以 Core Plugin 为例（）。Core Plugin 的 <code>start_rpc_listeners</code>、<code>start_rpc_state_reports_listener (只有 Core Plugin 才有)</code> 定义如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/plugins/ml2/plugin.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ml2Plugin</span><span class="params">(...)</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @log_helpers.log_method_call</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_rpc_listeners</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Start the RPC loop to let the plugin communicate with agents."""</span></span><br><span class="line">        self._setup_rpc()</span><br><span class="line">        self.topic = topics.PLUGIN</span><br><span class="line">        self.conn = n_rpc.create_connection()</span><br><span class="line">        self.conn.create_consumer(self.topic, self.endpoints, fanout=<span class="literal">False</span>)</span><br><span class="line">        self.conn.create_consumer(</span><br><span class="line">            topics.SERVER_RESOURCE_VERSIONS,</span><br><span class="line">            [resources_rpc.ResourcesPushToServerRpcCallback()],</span><br><span class="line">            fanout=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># process state reports despite dedicated rpc workers</span></span><br><span class="line">        self.conn.create_consumer(topics.REPORTS,</span><br><span class="line">                                  [agents_db.AgentExtRpcCallback()],</span><br><span class="line">                                  fanout=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> self.conn.consume_in_threads()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_rpc_state_reports_listener</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.conn_reports = n_rpc.create_connection()</span><br><span class="line">        self.conn_reports.create_consumer(topics.REPORTS,</span><br><span class="line">                                          [agents_db.AgentExtRpcCallback()],</span><br><span class="line">                                          fanout=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> self.conn_reports.consume_in_threads()</span><br></pre></td></tr></table></figure></p>
<h3 id="Plugin-Workers"><a href="#Plugin-Workers" class="headerlink" title="Plugin Workers"></a><strong>Plugin Workers</strong></h3><p>而关于 Core &amp; Service Plugins 的 Workers 的获取则是调用每个 Plugin 的 get_workers 函数，具体代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/service.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_plugins_workers</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># NOTE(twilson) get_plugins also returns the core plugin</span></span><br><span class="line">    plugins = directory.get_unique_plugins()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># TODO(twilson) Instead of defaulting here, come up with a good way to</span></span><br><span class="line">    <span class="comment"># share a common get_workers default between NeutronPluginBaseV2 and</span></span><br><span class="line">    <span class="comment"># ServicePluginBase</span></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        plugin_worker</span><br><span class="line">        <span class="keyword">for</span> plugin <span class="keyword">in</span> plugins <span class="keyword">if</span> hasattr(plugin, <span class="string">'get_workers'</span>)</span><br><span class="line">        <span class="keyword">for</span> plugin_worker <span class="keyword">in</span> plugin.get_workers()</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure></p>
<h3 id="启动-RPC-amp-Plugins-Workers"><a href="#启动-RPC-amp-Plugins-Workers" class="headerlink" title="启动 RPC &amp; Plugins Workers"></a><strong>启动 RPC &amp; Plugins Workers</strong></h3><p>获取到 RPC &amp; Plugins Workers 之后就是要启动这些 Workers，具体代码在 <code>_start_workers</code> 函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/service.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_start_workers</span><span class="params">(workers)</span>:</span></span><br><span class="line">    process_workers = [</span><br><span class="line">        plugin_worker <span class="keyword">for</span> plugin_worker <span class="keyword">in</span> workers</span><br><span class="line">        <span class="keyword">if</span> plugin_worker.worker_process_count &gt; <span class="number">0</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> process_workers:</span><br><span class="line">            worker_launcher = common_service.ProcessLauncher(</span><br><span class="line">                cfg.CONF, wait_interval=<span class="number">1.0</span></span><br><span class="line">            )</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">for</span> worker <span class="keyword">in</span> process_workers:</span><br><span class="line">                worker_launcher.launch_service(worker,</span><br><span class="line">                                               worker.worker_process_count)</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure></p>
<p>这个启动方式我们在 NeutronAPIService 服务启动里分析过，请参考之。</p>
<h2 id="Wait-for-NeutronApiService-RPC-Plugins-Workers"><a href="#Wait-for-NeutronApiService-RPC-Plugins-Workers" class="headerlink" title="Wait for NeutronApiService/RPC/Plugins Workers"></a><strong>Wait for NeutronApiService/RPC/Plugins Workers</strong></h2><p>当 NeutronApiService/RPC/Plugins Workers (Services) 都启动起来后，就会用 eventlet thread 来调用这些 Workers (Services) 的 wait 函数（如 oslo_service.service::ProcessLauncher、neutron.wsgi::WorkerService 的 wait 函数）：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron/server/wsgi_eventlet.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_api_and_rpc_workers</span><span class="params">(neutron_api)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        worker_launcher = service.start_all_workers()</span><br><span class="line"></span><br><span class="line">        pool = eventlet.GreenPool()</span><br><span class="line">        api_thread = pool.spawn(neutron_api.wait)</span><br><span class="line">        plugin_workers_thread = pool.spawn(worker_launcher.wait)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># api and other workers should die together. When one dies,</span></span><br><span class="line">        <span class="comment"># kill the other.</span></span><br><span class="line">        api_thread.link(<span class="keyword">lambda</span> gt: plugin_workers_thread.kill())</span><br><span class="line">        plugin_workers_thread.link(<span class="keyword">lambda</span> gt: api_thread.kill())</span><br><span class="line"></span><br><span class="line">        pool.waitall()</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></p>
<h1 id="附：Callback-System"><a href="#附：Callback-System" class="headerlink" title="附：Callback System"></a><strong>附：Callback System</strong></h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><strong>简介</strong></h2><p>不同于 Nova，Neutron 多了回调系统（Callback System）和消息回调系统（Messaging Callback System）。这两种系统的<a href="https://docs.openstack.org/neutron/latest/contributor/internals/rpc_callbacks.html" target="_blank" rel="noopener">区别</a>在于用途及实现方式：</p>
<blockquote>
<p>Neutron already has a callback system for in-process resource callbacks where publishers and subscribers are able to publish and subscribe for resource events.<br>This system (Messaging Callback System) is different, and is intended to be used for inter-process callbacks, via the messaging fanout mechanisms.</p>
</blockquote>
<p>也就是说，回调系统用于进程内通信（如 Neutron Server 进程里的 core plugin 与 service plugin 通信）；消息回调系统用于进程间通信，通过消息队列的广播机制实现。前者相对于后者来说比较简单，无需通过复杂机制来实现。</p>
<p>这里其实还有一个疑问，就是既然是进程内通信了，那还有必要弄一个回调系统吗？应该说，不用该系统也是可以实现进程内各服务之间的通信的，但考虑到 Neutron 的复杂性（多 service plugin），<a href="https://docs.openstack.org/neutron-lib/latest/contributor/callbacks.html" target="_blank" rel="noopener">不用回调系统会使得各服务之间强耦合，而且不便于 service 独立开发</a>：</p>
<blockquote>
<p>In Neutron, core and service components may need to cooperate during the execution of certain operations, or they may need to react upon the occurrence of certain events. For instance, when a Neutron resource is associated to multiple services, the components in charge of these services may need to play an active role in determining what the right state of the resource needs to be.<br><code>The cooperation may be achieved by making each object aware of each other, but this leads to tight coupling, or alternatively it can be achieved by using a callback-based system, where the same objects are allowed to cooperate in a loose manner.</code><br><code>This is particularly important since the spin off of the advanced services like VPN, Firewall and Load Balancer, where each service’s codebase lives independently from the core and from one another. This means that the tight coupling is no longer a practical solution for object cooperation. In addition to this, if more services are developed independently, there is no viable integration between them and the Neutron core.</code> A callback system, and its registry, tries to address these issues.</p>
</blockquote>
<p>这样使用回调系统的好处就是解耦，<a href="https://docs.openstack.org/neutron-lib/latest/contributor/callbacks.html" target="_blank" rel="noopener">各个 service 只需知道作为通信的中介（intermediary）即可</a>：</p>
<blockquote>
<p>The intermediary is then in charge of keeping track of who is interested in the messages and in delivering the messages forth and back, when required. As mentioned earlier, the use of an intermediary has the benefit of decoupling the parties involved in the communications, as now they only need to know about the intermediary; the other benefit is that the use of an intermediary opens up the possibility of multiple party communication: more than one object can express interest in receiving the same message, and the same message can be delivered to more than one object.</p>
</blockquote>
<p>对于一个回调系统而言，我们需要考虑以下<a href="https://docs.openstack.org/neutron-lib/latest/contributor/callbacks.html" target="_blank" rel="noopener">三个问题</a>：</p>
<ul>
<li>how to become consumer of messages (i.e. how to be on the receiving end of the message);</li>
<li>how to become producer of messages (i.e. how to be on the sending end of the message);</li>
<li>how to consume/produce messages selectively;</li>
</ul>
<p>针对 Neutron 而言，<a href="https://docs.openstack.org/neutron-lib/latest/contributor/callbacks.html" target="_blank" rel="noopener">该系统主要用于资源的生命周期事件方面</a>：</p>
<blockquote>
<p>Translate and narrow this down to Neutron needs, and this means the design of a callback system where messages are about <code>lifecycle events (e.g. before creation, before deletion, etc.)</code> of Neutron <code>resources (e.g. networks, routers, ports, etc.)</code>.</p>
</blockquote>
<h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a><strong>源码解析</strong></h2><p>回调系统的代码还挺简单，很容易看懂。代码路径：neutron.callbacks.manager.py::CallbacksManager。</p>
<h3 id="subscribe-amp-unsubscribe"><a href="#subscribe-amp-unsubscribe" class="headerlink" title="subscribe &amp; unsubscribe"></a><strong>subscribe &amp; unsubscribe</strong></h3><p>订阅与取消订阅实际就是注册或注销回调函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron.callbacks.manager.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CallbacksManager</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""A callback system that allows objects to cooperate in a loose manner."""</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">subscribe</span><span class="params">(self, callback, resource, event)</span>:</span></span><br><span class="line">        <span class="string">"""Subscribe callback for a resource event.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        The same callback may register for more than one event.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param callback: the callback. It must raise or return a boolean.</span></span><br><span class="line"><span class="string">        :param resource: the resource. It must be a valid resource.</span></span><br><span class="line"><span class="string">        :param event: the event. It must be a valid event.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        LOG.debug(<span class="string">"Subscribe: %(callback)s %(resource)s %(event)s"</span>,</span><br><span class="line">                  &#123;<span class="string">'callback'</span>: callback, <span class="string">'resource'</span>: resource, <span class="string">'event'</span>: event&#125;)</span><br><span class="line"></span><br><span class="line">        callback_id = _get_id(callback)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._callbacks[resource][event][callback_id] = callback</span><br><span class="line">        ...</span><br><span class="line">        self._index[callback_id][resource].add(event)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">unsubscribe</span><span class="params">(self, callback, resource, event)</span>:</span></span><br><span class="line">        <span class="string">"""Unsubscribe callback from the registry.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param callback: the callback.</span></span><br><span class="line"><span class="string">        :param resource: the resource.</span></span><br><span class="line"><span class="string">        :param event: the event.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        ...</span><br><span class="line">        callback_id = self._find(callback)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> callback_id:</span><br><span class="line">            LOG.debug(<span class="string">"Callback %s not found"</span>, callback_id)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> resource <span class="keyword">and</span> event:</span><br><span class="line">            <span class="keyword">del</span> self._callbacks[resource][event][callback_id]</span><br><span class="line">            self._index[callback_id][resource].discard(event)</span><br><span class="line">            ...</span><br></pre></td></tr></table></figure></p>
<h3 id="notify"><a href="#notify" class="headerlink" title="notify"></a><strong>notify</strong></h3><p>通知也挺简单的，就是遍历，然后一个一个调用订阅某一事件的回调函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># neutron.callbacks.manager.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CallbacksManager</span><span class="params">(object)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">notify</span><span class="params">(self, resource, event, trigger, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""Notify all subscribed callback(s).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Dispatch the resource's event to the subscribed callbacks.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param resource: the resource.</span></span><br><span class="line"><span class="string">        :param event: the event.</span></span><br><span class="line"><span class="string">        :param trigger: the trigger. A reference to the sender of the event.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        errors = self._notify_loop(resource, event, trigger, **kwargs)</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_notify_loop</span><span class="params">(self, resource, event, trigger, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""The notification loop."""</span></span><br><span class="line">        errors = []</span><br><span class="line">        callbacks = list(self._callbacks[resource].get(event, &#123;&#125;).items())</span><br><span class="line">        LOG.debug(<span class="string">"Notify callbacks %s for %s, %s"</span>,</span><br><span class="line">                  callbacks, resource, event)</span><br><span class="line">        <span class="comment"># TODO(armax): consider using a GreenPile</span></span><br><span class="line">        <span class="keyword">for</span> callback_id, callback <span class="keyword">in</span> callbacks:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                callback(resource, event, trigger, **kwargs)</span><br><span class="line">            ...</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/11/23/openstack-server-creation-source-code-analysis-network-n-subnet-creation/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          OpenStack 虚拟机创建源码分析：创建网络及子网
        
      </div>
    </a>
  
  
    <a href="/2017/11/01/openstack-neutron-routing-and-public-ip/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">《每天 5 分钟玩转 OpenStack》系列学习笔记：路由器及公网 IP</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>







      <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>

<script>
var gitalk = new Gitalk({
  clientID: '64c19d7f57bebbb343c4',
  clientSecret: '287daeba39e73fdde92f24540c9f3c0fd5238512',
  repo: 'BlogComments',
  owner: 'xiemax100',
  admin: ['xiemax100'],
  id: md5(window.location.pathname),
  distractionFreeMode: true
})

gitalk.render('gitalk-container')
</script>






    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#PasteDeploy-特点"><span class="toc-number">1.</span> <span class="toc-text">PasteDeploy 特点</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Neutron-Server-启动概览"><span class="toc-number">2.</span> <span class="toc-text">Neutron Server 启动概览</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Neutron-API-Service-初始化"><span class="toc-number">3.</span> <span class="toc-text">Neutron API Service 初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#APIRouter"><span class="toc-number">3.1.</span> <span class="toc-text">APIRouter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NeutronManager"><span class="toc-number">3.1.1.</span> <span class="toc-text">NeutronManager</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Core-Plugin"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">Core Plugin</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ML2-简介"><span class="toc-number">3.1.1.1.1.</span> <span class="toc-text">ML2 简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#初始化概览"><span class="toc-number">3.1.1.1.2.</span> <span class="toc-text">初始化概览</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#DHCP"><span class="toc-number">3.1.1.1.3.</span> <span class="toc-text">DHCP</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RPC-Notifiers"><span class="toc-number">3.1.1.1.4.</span> <span class="toc-text">RPC Notifiers</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service-Plugins"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">Service Plugins</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#L3-Router-Plugin"><span class="toc-number">3.1.1.2.1.</span> <span class="toc-text">L3 Router Plugin</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RPC-Notifiers-1"><span class="toc-number">3.1.1.2.2.</span> <span class="toc-text">RPC Notifiers</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Extension-Manager"><span class="toc-number">3.1.2.</span> <span class="toc-text">Extension Manager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Core-Plugin-Routes"><span class="toc-number">3.1.3.</span> <span class="toc-text">Core Plugin Routes</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Extensions-Routes"><span class="toc-number">3.2.</span> <span class="toc-text"> Extensions Routes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Extension-与-Service-Plugin-关系"><span class="toc-number">3.3.</span> <span class="toc-text">Extension 与 Service Plugin 关系</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#服务启动"><span class="toc-number">4.</span> <span class="toc-text">服务启动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NeutronApiService"><span class="toc-number">4.1.</span> <span class="toc-text">NeutronApiService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Plugins-RPC-Listeners-amp-Workers"><span class="toc-number">4.2.</span> <span class="toc-text">Plugins RPC Listeners &amp; Workers</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RPC-Listeners-Workers"><span class="toc-number">4.2.1.</span> <span class="toc-text">RPC Listeners(Workers)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Plugin-Workers"><span class="toc-number">4.2.2.</span> <span class="toc-text">Plugin Workers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-RPC-amp-Plugins-Workers"><span class="toc-number">4.2.3.</span> <span class="toc-text">启动 RPC &amp; Plugins Workers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Wait-for-NeutronApiService-RPC-Plugins-Workers"><span class="toc-number">4.3.</span> <span class="toc-text">Wait for NeutronApiService/RPC/Plugins Workers</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#附：Callback-System"><span class="toc-number">5.</span> <span class="toc-text">附：Callback System</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">5.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#源码解析"><span class="toc-number">5.2.</span> <span class="toc-text">源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#subscribe-amp-unsubscribe"><span class="toc-number">5.2.1.</span> <span class="toc-text">subscribe &amp; unsubscribe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#notify"><span class="toc-number">5.2.2.</span> <span class="toc-text">notify</span></a></li></ol></li></ol></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录" title="点击按钮隐藏或者显示文章目录">

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var toc_button = document.getElementById("tocButton");
    var toc_div = document.getElementById("toc");
    toc_button.onclick=function() {
        if (toc_div.style.display == "none") {
            toc_div.style.display = "block";
            toc_button.value = "隐藏目录";
            document.getElementById("switch-btn").style.display = "none";
            document.getElementById("switch-area").style.display = "none";
        }
        else {
            toc_div.style.display = "none";
            toc_button.value = "显示目录";
            document.getElementById("switch-btn").style.display = "block";
            document.getElementById("switch-area").style.display = "block";
        }
    }

    if ($(".toc").length < 1) {
        $("#toc").css("display","none");
        $("#tocButton").css("display","none");
        $(".switch-btn").css("display","block");
        $(".switch-area").css("display","block");
    }
</script>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2019 Max
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>