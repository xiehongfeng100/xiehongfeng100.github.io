<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Linux 内核学习笔记：malloc 函数 | Max&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Linux 0.11 实现的 malloc 函数实际上分配的是内核程序所用的内存，而不是用户程序的，因为源码中找不到类似系统调用 malloc 的代码。在 Linux 0.98 后，为了不与用户程序使用的 malloc 相混淆，将内核使用的 malloc 函数改名为 kmalloc（free_s 改名为 kfree_s）。 对于 malloc 函数，malloc.c 文件开头的注释其实解释的很清晰">
<meta name="keywords" content="Linux,内核,malloc">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux 内核学习笔记：malloc 函数">
<meta property="og:url" content="http://xiehongfeng100.github.io/2016/03/14/linux-kenel-0-11-topic-malloc/index.html">
<meta property="og:site_name" content="Max&#39;s Blog">
<meta property="og:description" content="Linux 0.11 实现的 malloc 函数实际上分配的是内核程序所用的内存，而不是用户程序的，因为源码中找不到类似系统调用 malloc 的代码。在 Linux 0.98 后，为了不与用户程序使用的 malloc 相混淆，将内核使用的 malloc 函数改名为 kmalloc（free_s 改名为 kfree_s）。 对于 malloc 函数，malloc.c 文件开头的注释其实解释的很清晰">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/os/linux-kenel-0.11/malloc/malloc所用到的数据结构.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/os/linux-kenel-0.11/malloc/空闲桶描述符链表结构.png">
<meta property="og:updated_time" content="2019-05-01T06:53:11.583Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux 内核学习笔记：malloc 函数">
<meta name="twitter:description" content="Linux 0.11 实现的 malloc 函数实际上分配的是内核程序所用的内存，而不是用户程序的，因为源码中找不到类似系统调用 malloc 的代码。在 Linux 0.98 后，为了不与用户程序使用的 malloc 相混淆，将内核使用的 malloc 函数改名为 kmalloc（free_s 改名为 kfree_s）。 对于 malloc 函数，malloc.c 文件开头的注释其实解释的很清晰">
<meta name="twitter:image" content="http://xiehongfeng100.github.io/images/os/linux-kenel-0.11/malloc/malloc所用到的数据结构.png">
  
    <link rel="alternative" href="/atom.xml" title="Max&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="img/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/author.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Max</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Stay hungry, stay foolish.</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/categories/架构">架构</a></li>
				        
							<li><a href="/categories/读书">读书</a></li>
				        
							<li><a href="/tags/翻译">翻译</a></li>
				        
							<li><a href="/categories/网络">网络</a></li>
				        
							<li><a href="/categories/并发">并发</a></li>
				        
							<li><a href="/categories/安全">安全</a></li>
				        
							<li><a href="/categories/运维">运维</a></li>
				        
							<li><a href="/categories/数据库">数据库</a></li>
				        
							<li><a href="/categories/云计算">云计算</a></li>
				        
							<li><a href="/categories/编程语言">编程语言</a></li>
				        
							<li><a href="/categories/操作系统">操作系统</a></li>
				        
							<li><a href="/categories/机器学习">机器学习</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/xiehongfeng100" title="github">github</a>
					        
								<a class="linkedin" target="_blank" href="http://cn.linkedin.com/in/xiehongfeng100" title="linkedin">linkedin</a>
					        
								<a class="mail" target="_blank" href="mailto:xiehongfeng100@hotmail.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/tmp/" style="font-size: 10px;">/tmp</a> <a href="/tags/AT-T/" style="font-size: 10px;">AT&T</a> <a href="/tags/Affin/" style="font-size: 10px;">Affin</a> <a href="/tags/Alembic/" style="font-size: 10px;">Alembic</a> <a href="/tags/B-树/" style="font-size: 10px;">B+ 树</a> <a href="/tags/BIOS/" style="font-size: 10px;">BIOS</a> <a href="/tags/C-C/" style="font-size: 16.36px;">C/C++</a> <a href="/tags/CA/" style="font-size: 10px;">CA</a> <a href="/tags/CBOW/" style="font-size: 10px;">CBOW</a> <a href="/tags/CNN/" style="font-size: 10.91px;">CNN</a> <a href="/tags/DHCP/" style="font-size: 10px;">DHCP</a> <a href="/tags/Decorator/" style="font-size: 10px;">Decorator</a> <a href="/tags/Django/" style="font-size: 10px;">Django</a> <a href="/tags/Dnsmasq/" style="font-size: 10px;">Dnsmasq</a> <a href="/tags/ELF/" style="font-size: 10px;">ELF</a> <a href="/tags/ELK/" style="font-size: 10px;">ELK</a> <a href="/tags/Elasticsearch/" style="font-size: 11.82px;">Elasticsearch</a> <a href="/tags/GCC/" style="font-size: 10px;">GCC</a> <a href="/tags/HBR/" style="font-size: 10px;">HBR</a> <a href="/tags/IO-Multiplexing/" style="font-size: 11.82px;">IO Multiplexing</a> <a href="/tags/IPTables/" style="font-size: 10px;">IPTables</a> <a href="/tags/Immunity-Debugger/" style="font-size: 10px;">Immunity Debugger</a> <a href="/tags/InnoDB/" style="font-size: 10px;">InnoDB</a> <a href="/tags/KD-Tree/" style="font-size: 10.91px;">KD-Tree</a> <a href="/tags/KNN/" style="font-size: 10px;">KNN</a> <a href="/tags/KVM/" style="font-size: 10px;">KVM</a> <a href="/tags/Kali-Linux/" style="font-size: 10px;">Kali Linux</a> <a href="/tags/Keras/" style="font-size: 10px;">Keras</a> <a href="/tags/Keystone/" style="font-size: 13.64px;">Keystone</a> <a href="/tags/Kibana/" style="font-size: 10px;">Kibana</a> <a href="/tags/Lemmatization/" style="font-size: 10px;">Lemmatization</a> <a href="/tags/Libvirt/" style="font-size: 10.91px;">Libvirt</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/LinuxBridge/" style="font-size: 11.82px;">LinuxBridge</a> <a href="/tags/Logging/" style="font-size: 10px;">Logging</a> <a href="/tags/Logstash/" style="font-size: 10px;">Logstash</a> <a href="/tags/MRO/" style="font-size: 10px;">MRO</a> <a href="/tags/Metasploit-Framwork/" style="font-size: 10px;">Metasploit Framwork</a> <a href="/tags/MySQL/" style="font-size: 10.91px;">MySQL</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/Namespace/" style="font-size: 10px;">Namespace</a> <a href="/tags/Neo4J/" style="font-size: 10.91px;">Neo4J</a> <a href="/tags/Neutron/" style="font-size: 13.64px;">Neutron</a> <a href="/tags/Nova/" style="font-size: 14.55px;">Nova</a> <a href="/tags/OpenStack/" style="font-size: 17.27px;">OpenStack</a> <a href="/tags/OpenVSwitch/" style="font-size: 10px;">OpenVSwitch</a> <a href="/tags/PKI/" style="font-size: 10.91px;">PKI</a> <a href="/tags/PasteDeploy/" style="font-size: 10.91px;">PasteDeploy</a> <a href="/tags/Policy/" style="font-size: 10px;">Policy</a> <a href="/tags/Python/" style="font-size: 18.18px;">Python</a> <a href="/tags/QEMU/" style="font-size: 10px;">QEMU</a> <a href="/tags/RBAC/" style="font-size: 10px;">RBAC</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/SQLAlchemy-Migrate/" style="font-size: 10px;">SQLAlchemy-Migrate</a> <a href="/tags/SSL/" style="font-size: 10px;">SSL</a> <a href="/tags/Sigmoid/" style="font-size: 10px;">Sigmoid</a> <a href="/tags/Skip-Gram/" style="font-size: 10px;">Skip-Gram</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Stop-Words/" style="font-size: 10px;">Stop Words</a> <a href="/tags/TCP/" style="font-size: 10px;">TCP</a> <a href="/tags/Tap/" style="font-size: 10.91px;">Tap</a> <a href="/tags/Token/" style="font-size: 11.82px;">Token</a> <a href="/tags/Tokenization/" style="font-size: 10px;">Tokenization</a> <a href="/tags/Trampolining/" style="font-size: 10px;">Trampolining</a> <a href="/tags/Tun/" style="font-size: 10.91px;">Tun</a> <a href="/tags/Tunnel/" style="font-size: 10px;">Tunnel</a> <a href="/tags/UUID/" style="font-size: 10px;">UUID</a> <a href="/tags/VNC/" style="font-size: 10px;">VNC</a> <a href="/tags/VPN/" style="font-size: 10px;">VPN</a> <a href="/tags/Veth/" style="font-size: 11.82px;">Veth</a> <a href="/tags/VirtualBox/" style="font-size: 10px;">VirtualBox</a> <a href="/tags/Vlan/" style="font-size: 10px;">Vlan</a> <a href="/tags/Vue/" style="font-size: 10px;">Vue</a> <a href="/tags/WSGI/" style="font-size: 13.64px;">WSGI</a> <a href="/tags/Webob/" style="font-size: 10px;">Webob</a> <a href="/tags/Word2Vec/" style="font-size: 10.91px;">Word2Vec</a> <a href="/tags/Yelper/" style="font-size: 15.45px;">Yelper</a> <a href="/tags/bootsect/" style="font-size: 10px;">bootsect</a> <a href="/tags/cookiecutter/" style="font-size: 10px;">cookiecutter</a> <a href="/tags/delete/" style="font-size: 10px;">delete</a> <a href="/tags/dnsmasq/" style="font-size: 10px;">dnsmasq</a> <a href="/tags/entry-points/" style="font-size: 10px;">entry_points</a> <a href="/tags/epoll/" style="font-size: 10px;">epoll</a> <a href="/tags/fork/" style="font-size: 10px;">fork</a> <a href="/tags/head/" style="font-size: 10px;">head</a> <a href="/tags/inode/" style="font-size: 10px;">inode</a> <a href="/tags/malloc/" style="font-size: 10px;">malloc</a> <a href="/tags/mona/" style="font-size: 10px;">mona</a> <a href="/tags/new/" style="font-size: 10px;">new</a> <a href="/tags/property/" style="font-size: 10px;">property</a> <a href="/tags/read/" style="font-size: 10px;">read</a> <a href="/tags/routes/" style="font-size: 10px;">routes</a> <a href="/tags/select/" style="font-size: 10px;">select</a> <a href="/tags/setup/" style="font-size: 10px;">setup</a> <a href="/tags/setuptools/" style="font-size: 10px;">setuptools</a> <a href="/tags/shell/" style="font-size: 10.91px;">shell</a> <a href="/tags/stevedore/" style="font-size: 10px;">stevedore</a> <a href="/tags/string/" style="font-size: 10px;">string</a> <a href="/tags/tcpdump/" style="font-size: 10px;">tcpdump</a> <a href="/tags/uWSGI/" style="font-size: 10px;">uWSGI</a> <a href="/tags/update-进程/" style="font-size: 10px;">update 进程</a> <a href="/tags/write/" style="font-size: 10px;">write</a> <a href="/tags/wsgiref/" style="font-size: 10px;">wsgiref</a> <a href="/tags/yield/" style="font-size: 14.55px;">yield</a> <a href="/tags/中断/" style="font-size: 10.91px;">中断</a> <a href="/tags/任务调度/" style="font-size: 10px;">任务调度</a> <a href="/tags/传记/" style="font-size: 10.91px;">传记</a> <a href="/tags/信号/" style="font-size: 10px;">信号</a> <a href="/tags/信号量/" style="font-size: 10px;">信号量</a> <a href="/tags/内存对齐/" style="font-size: 10px;">内存对齐</a> <a href="/tags/内存映射-I-O/" style="font-size: 10px;">内存映射 I/O</a> <a href="/tags/内存规划/" style="font-size: 10px;">内存规划</a> <a href="/tags/内核/" style="font-size: 19.09px;">内核</a> <a href="/tags/内核栈/" style="font-size: 10px;">内核栈</a> <a href="/tags/分页/" style="font-size: 10px;">分页</a> <a href="/tags/加密/" style="font-size: 10.91px;">加密</a> <a href="/tags/加载/" style="font-size: 10.91px;">加载</a> <a href="/tags/协程/" style="font-size: 13.64px;">协程</a> <a href="/tags/可执行目标文件/" style="font-size: 10.91px;">可执行目标文件</a> <a href="/tags/可重定位目标文件/" style="font-size: 10px;">可重定位目标文件</a> <a href="/tags/同步/" style="font-size: 10px;">同步</a> <a href="/tags/商业/" style="font-size: 11.82px;">商业</a> <a href="/tags/地心坐标系/" style="font-size: 10px;">地心坐标系</a> <a href="/tags/多线程/" style="font-size: 10.91px;">多线程</a> <a href="/tags/多进程/" style="font-size: 10px;">多进程</a> <a href="/tags/字符串/" style="font-size: 10px;">字符串</a> <a href="/tags/存储器/" style="font-size: 10.91px;">存储器</a> <a href="/tags/宏/" style="font-size: 10px;">宏</a> <a href="/tags/寄存器/" style="font-size: 10px;">寄存器</a> <a href="/tags/开发环境/" style="font-size: 10px;">开发环境</a> <a href="/tags/异常/" style="font-size: 10px;">异常</a> <a href="/tags/异步/" style="font-size: 10px;">异步</a> <a href="/tags/引导块/" style="font-size: 10px;">引导块</a> <a href="/tags/引导程序/" style="font-size: 12.73px;">引导程序</a> <a href="/tags/归一化/" style="font-size: 10px;">归一化</a> <a href="/tags/微处理器/" style="font-size: 13.64px;">微处理器</a> <a href="/tags/总结/" style="font-size: 10px;">总结</a> <a href="/tags/情感分析/" style="font-size: 10px;">情感分析</a> <a href="/tags/扩容/" style="font-size: 10px;">扩容</a> <a href="/tags/指令集/" style="font-size: 10px;">指令集</a> <a href="/tags/指针/" style="font-size: 12.73px;">指针</a> <a href="/tags/数字签名/" style="font-size: 10px;">数字签名</a> <a href="/tags/数字证书/" style="font-size: 10px;">数字证书</a> <a href="/tags/整数/" style="font-size: 10px;">整数</a> <a href="/tags/文件系统/" style="font-size: 12.73px;">文件系统</a> <a href="/tags/时钟/" style="font-size: 10px;">时钟</a> <a href="/tags/时钟中断/" style="font-size: 10px;">时钟中断</a> <a href="/tags/时间衰减函数/" style="font-size: 10px;">时间衰减函数</a> <a href="/tags/权限/" style="font-size: 10px;">权限</a> <a href="/tags/架构实践/" style="font-size: 10px;">架构实践</a> <a href="/tags/标准输入/" style="font-size: 10px;">标准输入</a> <a href="/tags/标准输出/" style="font-size: 10px;">标准输出</a> <a href="/tags/标准错误输出/" style="font-size: 10px;">标准错误输出</a> <a href="/tags/栈帧/" style="font-size: 10px;">栈帧</a> <a href="/tags/栈溢出/" style="font-size: 10px;">栈溢出</a> <a href="/tags/根设备/" style="font-size: 10px;">根设备</a> <a href="/tags/母板/" style="font-size: 10px;">母板</a> <a href="/tags/汇编/" style="font-size: 10px;">汇编</a> <a href="/tags/浮点数/" style="font-size: 10px;">浮点数</a> <a href="/tags/消息摘要/" style="font-size: 10px;">消息摘要</a> <a href="/tags/特权级/" style="font-size: 10px;">特权级</a> <a href="/tags/环境变量/" style="font-size: 10px;">环境变量</a> <a href="/tags/生成器/" style="font-size: 14.55px;">生成器</a> <a href="/tags/用户栈/" style="font-size: 10px;">用户栈</a> <a href="/tags/相似度/" style="font-size: 10.91px;">相似度</a> <a href="/tags/硬盘/" style="font-size: 12.73px;">硬盘</a> <a href="/tags/硬链接/" style="font-size: 10px;">硬链接</a> <a href="/tags/管道/" style="font-size: 10px;">管道</a> <a href="/tags/系统调用/" style="font-size: 10px;">系统调用</a> <a href="/tags/索引/" style="font-size: 10px;">索引</a> <a href="/tags/缓冲区/" style="font-size: 10.91px;">缓冲区</a> <a href="/tags/缓冲区溢出/" style="font-size: 10px;">缓冲区溢出</a> <a href="/tags/缺页中断/" style="font-size: 10px;">缺页中断</a> <a href="/tags/网络/" style="font-size: 13.64px;">网络</a> <a href="/tags/翻译/" style="font-size: 14.55px;">翻译</a> <a href="/tags/虚拟地址空间/" style="font-size: 10px;">虚拟地址空间</a> <a href="/tags/虚拟盘/" style="font-size: 10px;">虚拟盘</a> <a href="/tags/请求项/" style="font-size: 10px;">请求项</a> <a href="/tags/质数/" style="font-size: 10px;">质数</a> <a href="/tags/超级块/" style="font-size: 10px;">超级块</a> <a href="/tags/软盘/" style="font-size: 10px;">软盘</a> <a href="/tags/软链接/" style="font-size: 10px;">软链接</a> <a href="/tags/进程派生/" style="font-size: 10px;">进程派生</a> <a href="/tags/进程通信/" style="font-size: 10.91px;">进程通信</a> <a href="/tags/迭代器/" style="font-size: 10px;">迭代器</a> <a href="/tags/金融/" style="font-size: 10px;">金融</a> <a href="/tags/阻塞/" style="font-size: 10.91px;">阻塞</a> <a href="/tags/非阻塞/" style="font-size: 10.91px;">非阻塞</a> <a href="/tags/黑客/" style="font-size: 10px;">黑客</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">谢宏峰，毕业于暨南大学（2009 - 2013）、中国科学院（2013 - 2016），现就职于深信服科技，从事 OpenStack 开发。</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Max</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/img/author.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Max</h1>
			</hgroup>
			
			<p class="header-subtitle">Stay hungry, stay foolish.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/categories/架构">架构</a></li>
		        
					<li><a href="/categories/读书">读书</a></li>
		        
					<li><a href="/tags/翻译">翻译</a></li>
		        
					<li><a href="/categories/网络">网络</a></li>
		        
					<li><a href="/categories/并发">并发</a></li>
		        
					<li><a href="/categories/安全">安全</a></li>
		        
					<li><a href="/categories/运维">运维</a></li>
		        
					<li><a href="/categories/数据库">数据库</a></li>
		        
					<li><a href="/categories/云计算">云计算</a></li>
		        
					<li><a href="/categories/编程语言">编程语言</a></li>
		        
					<li><a href="/categories/操作系统">操作系统</a></li>
		        
					<li><a href="/categories/机器学习">机器学习</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/xiehongfeng100" title="github">github</a>
			        
						<a class="linkedin" target="_blank" href="http://cn.linkedin.com/in/xiehongfeng100" title="linkedin">linkedin</a>
			        
						<a class="mail" target="_blank" href="mailto:xiehongfeng100@hotmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-linux-kenel-0-11-topic-malloc" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/14/linux-kenel-0-11-topic-malloc/" class="article-date">
  	<time datetime="2016-03-14T07:40:03.000Z" itemprop="datePublished">2016-03-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Linux 内核学习笔记：malloc 函数
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/malloc/">malloc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/内核/">内核</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/操作系统/">操作系统</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Linux 0.11 实现的 malloc 函数实际上分配的是内核程序所用的内存，而不是用户程序的，因为源码中找不到类似系统调用 malloc 的代码。在 Linux 0.98 后，为了不与用户程序使用的 malloc 相混淆，将内核使用的 malloc 函数改名为 kmalloc（free_s 改名为 kfree_s）。</p>
<p>对于 malloc 函数，malloc.c 文件开头的注释其实解释的很清晰：  </p>
<blockquote>
<ul>
<li>malloc.c — a general purpose kernel memory allocator for Linux.</li>
<li>Written by Theodore Ts’o (<a href="mailto:tytso@mit.edu" target="_blank" rel="noopener">tytso@mit.edu</a>), 11/29/91</li>
<li>This routine is written to be as fast as possible, so that it can be called from the interrupt level.</li>
<li>Limitations: maximum size of memory we can allocate using this routine is 4k, the size of a page in Linux.</li>
<li>The general game plan is that each page (called a bucket) will only hold objects of a given size.  When all of the object on a page are released, the page can be returned to the general free pool.  When malloc() is called, it looks for the smallest bucket size which will fulfill its request, and allocate a piece of memory from that bucket pool.</li>
<li>Each bucket has as its control block a bucket descriptor which keeps track of how many objects are in use on that page, and the free list for that page.  Like the buckets themselves, bucket descriptors are stored on pages requested from get_free_page().  However, unlike buckets, pages devoted to bucket descriptor pages are never released back to the system.  Fortunately, a system should probably only need 1 or 2 bucket descriptor pages, since a page can hold 256 bucket descriptors (which corresponds to 1 megabyte worth of bucket pages.)  If the kernel is using  that much allocated memory, it’s probably doing something wrong.  :-)</li>
<li>Note: malloc() and free() both call get_free_page() and free_page() in sections of code where interrupts are turned off, to allow malloc() and free() to be safely called from an interrupt routine. (We will probably need this functionality when networking code, particularily things like NFS, is added to Linux.)  However, this presumes that get_free_page() and free_page() are interrupt-level safe, which they may not be once paging is added.  If this is the case, we will need to modify malloc() to keep a few unused pages “pre-allocated” so that it can safely draw upon those pages if it is called from an interrupt routine. </li>
<li>Another concern is that get_free_page() should not sleep; if it  does, the code is carefully ordered so as to avoid any race  conditions.  The catch is that if malloc() is called re-entrantly, there is a chance that unecessary pages will be grabbed from the  system. Except for the pages for the bucket descriptor page, the  extra pages will eventually get released back to the system, though, so it isn’t all that bad.</li>
</ul>
</blockquote>
<a id="more"></a>
<p>也可以直接看翻译：  </p>
<blockquote>
<ul>
<li>malloc.c - Linux 的通用内核内存分配函数。</li>
<li>由Theodore Ts’o 编制 (<a href="mailto:tytso@mit.edu" target="_blank" rel="noopener">tytso@mit.edu</a>), 11/29/91</li>
<li>该函数被编写成尽可能地快，从而可以从中断层调用此函数。</li>
<li>限制：使用该函数一次所能分配的最大内存是 4k，也即 Linux 中内存页面的大小。</li>
<li>编写该函数所遵循的一般规则是每页(被称为一个存储桶)仅分配所要容纳对象的大小。当一页上的所有对象都释放后，该页就可以返回通用空闲内存池。当 malloc() 被调用时，它会寻找满足要求的最小的存储桶，并从该存储桶中分配一块内存。</li>
<li>每个存储桶都有一个作为其控制用的存储桶描述符，其中记录了页面上有多少对象正被使用以及该页上空闲内存的列表。就象存储桶自身一样，存储桶描述符也是存储在使用 get_free_page() 申请到的页面上的，但是与存储桶不同的是，桶描述符所占用的页面将不再会释放给系统。幸运的是一个系统大约只需要1 到2 页的桶描述符页面，因为一个页面可以存放 256 个桶描述符(对应 1MB 内存的存储桶页面)。如果系统为桶描述符分配了许多内存，那么肯定系统什么地方出了问题?。</li>
<li>注意！malloc() 和 free() 两者关闭了中断的代码部分都调用了 get_free_page() 和 free_page() 函数，以使 malloc() 和 free() 可以安全地被从中断程序中调用(当网络代码，尤其是 NFS 等被加入到 Linux 中时就可能需要这种功能)。但前提是假设 get_free_page() 和 free_page() 是可以安全地在中断级程序中使用的，这在一旦加入了分页处理之后就可能不是安全的。如果真是这种情况，那么我们就需要修改 malloc() 来“预先分配”几页不用的内存，如果 malloc() 和 free() 被从中断程序中调用时就可以安全地使用这些页面。<br>另外需要考虑到的是 get_free_page() 不应该睡眠；如果会睡眠的话，则为了防止任何竞争条件，代码需要仔细地安排顺序。 关键在于如果 malloc() 是可以重入地被调用的话，那么就会存在不必要的页面被从系统中取走的机会。除了用于桶描述符的页面，这些额外的页面最终会释放给系统，所以并不是象想象的那样不好。</li>
</ul>
</blockquote>
<h1 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a><strong>数据结构</strong></h1><p>malloc 函数使用了桶（bucket）的原理对分配的内存进行管理。基本思想是对不同请求的内存块大小（长度），使用桶目录进行管理。例如，对于请求内存块的长度在 64 字节或 64 字节以下但大于 32 字节时，就使用桶目录中的第 3 项桶目录项所指向的桶描述符链表分配内存。</p>
<p>malloc 函数所涉及的数据结构有 3 个，即桶描述符、桶目录项、桶目录。桶目录存储桶目录项，而桶目录项指向桶描述符链表。具体代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/malloc.c --------------------------------</span></span><br><span class="line"><span class="comment">// 桶描述符</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bucket_desc</span> &#123;</span>	<span class="comment">/* 16 bytes */</span></span><br><span class="line">	<span class="keyword">void</span>			*page;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bucket_desc</span>	*<span class="title">next</span>;</span></span><br><span class="line">	<span class="keyword">void</span>			*freeptr;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span>		refcnt;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span>		bucket_size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 桶目录项</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">bucket_dir</span> &#123;</span>	<span class="comment">/* 8 bytes */</span></span><br><span class="line">	<span class="keyword">int</span>			size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bucket_desc</span>	*<span class="title">chain</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The following is the where we store a pointer to the first bucket</span></span><br><span class="line"><span class="comment"> * descriptor for a given size.  </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If it turns out that the Linux kernel allocates a lot of objects of a</span></span><br><span class="line"><span class="comment"> * specific size, then we may want to add that specific size to this list,</span></span><br><span class="line"><span class="comment"> * since that will allow the memory to be allocated more efficiently.</span></span><br><span class="line"><span class="comment"> * However, since an entire page must be dedicated to each specific size</span></span><br><span class="line"><span class="comment"> * on this list, some amount of temperance must be exercised here.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that this list *must* be kept in order.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 桶目录</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">bucket_dir</span> <span class="title">bucket_dir</span>[] = &#123;</span></span><br><span class="line">	&#123; <span class="number">16</span>,	(struct bucket_desc *) <span class="number">0</span>&#125;,</span><br><span class="line">	&#123; <span class="number">32</span>,	(struct bucket_desc *) <span class="number">0</span>&#125;,</span><br><span class="line">	&#123; <span class="number">64</span>,	(struct bucket_desc *) <span class="number">0</span>&#125;,</span><br><span class="line">	&#123; <span class="number">128</span>,	(struct bucket_desc *) <span class="number">0</span>&#125;,</span><br><span class="line">	&#123; <span class="number">256</span>,	(struct bucket_desc *) <span class="number">0</span>&#125;,</span><br><span class="line">	&#123; <span class="number">512</span>,	(struct bucket_desc *) <span class="number">0</span>&#125;,</span><br><span class="line">	&#123; <span class="number">1024</span>,	(struct bucket_desc *) <span class="number">0</span>&#125;,</span><br><span class="line">	&#123; <span class="number">2048</span>, (struct bucket_desc *) <span class="number">0</span>&#125;,</span><br><span class="line">	&#123; <span class="number">4096</span>, (struct bucket_desc *) <span class="number">0</span>&#125;,</span><br><span class="line">	&#123; <span class="number">0</span>,    (struct bucket_desc *) <span class="number">0</span>&#125;&#125;;   <span class="comment">/* End of list marker */</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/images/os/linux-kenel-0.11/malloc/malloc所用到的数据结构.png" alt>图片来源：《Linux 内核完全注释》（修改过）  </p>
<h1 id="malloc-函数"><a href="#malloc-函数" class="headerlink" title="malloc 函数"></a><strong>malloc 函数</strong></h1><h2 id="桶描述符链表初始化"><a href="#桶描述符链表初始化" class="headerlink" title="桶描述符链表初始化"></a><strong>桶描述符链表初始化</strong></h2><p>第一次调用 malloc 函数是，需要对桶描述符链表进行初始化。代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/malloc.c --------------------------------</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This contains a linked list of free bucket descriptor blocks</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bucket_desc</span> *<span class="title">free_bucket_desc</span> = (<span class="title">struct</span> <span class="title">bucket_desc</span> *) 0;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This routine initializes a bucket description page.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">init_bucket_desc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bucket_desc</span> *<span class="title">bdesc</span>, *<span class="title">first</span>;</span></span><br><span class="line">	<span class="keyword">int</span>	i;</span><br><span class="line">	</span><br><span class="line">	first = bdesc = (struct bucket_desc *) get_free_page();</span><br><span class="line">	<span class="keyword">if</span> (!bdesc)</span><br><span class="line">		panic(<span class="string">"Out of memory in init_bucket_desc()"</span>);</span><br><span class="line">	<span class="keyword">for</span> (i = PAGE_SIZE/<span class="keyword">sizeof</span>(struct bucket_desc); i &gt; <span class="number">1</span>; i--) &#123;</span><br><span class="line">		bdesc-&gt;next = bdesc+<span class="number">1</span>;</span><br><span class="line">		bdesc++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * This is done last, to avoid race conditions in case </span></span><br><span class="line"><span class="comment">	 * get_free_page() sleeps and this routine gets called again....</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	bdesc-&gt;next = free_bucket_desc;</span><br><span class="line">	free_bucket_desc = first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上述代码可用图表示如下：<br><img src="/images/os/linux-kenel-0.11/malloc/空闲桶描述符链表结构.png" alt>图片来源：《Linux 内核完全注释》（修改过）  </p>
<p>需要<strong>注意</strong>的是，这个<code>桶描述符链表是给&quot;所有&quot;桶目录项共用的，而不是只给某个桶目录项使用。一个桶目录项会有属于自己的&quot;局部&quot;桶描述符链表，只不过这个链表是全局的局部。</code></p>
<h2 id="malloc-函数-1"><a href="#malloc-函数-1" class="headerlink" title="malloc 函数"></a><strong>malloc 函数</strong></h2><p>malloc 函数定义如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/malloc.c --------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">bucket_dir</span>	*<span class="title">bdir</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bucket_desc</span>	*<span class="title">bdesc</span>;</span></span><br><span class="line">	<span class="keyword">void</span>			*retval;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * First we search the bucket_dir to find the right bucket change</span></span><br><span class="line"><span class="comment">	 * for this request.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">for</span> (bdir = bucket_dir; bdir-&gt;size; bdir++)</span><br><span class="line">		<span class="keyword">if</span> (bdir-&gt;size &gt;= len)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">if</span> (!bdir-&gt;size) &#123;</span><br><span class="line">		printk(<span class="string">"malloc called with impossibly large argument (%d)\n"</span>,</span><br><span class="line">			len);</span><br><span class="line">		panic(<span class="string">"malloc: bad arg"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Now we search for a bucket descriptor which has free space</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	cli();	<span class="comment">/* Avoid race conditions */</span></span><br><span class="line">	<span class="keyword">for</span> (bdesc = bdir-&gt;chain; bdesc; bdesc = bdesc-&gt;next) </span><br><span class="line">		<span class="keyword">if</span> (bdesc-&gt;freeptr)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If we didn't find a bucket with free space, then we'll </span></span><br><span class="line"><span class="comment">	 * allocate a new one.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!bdesc) &#123;</span><br><span class="line">		<span class="keyword">char</span>		*cp;</span><br><span class="line">		<span class="keyword">int</span>		i;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!free_bucket_desc)	</span><br><span class="line">			init_bucket_desc();</span><br><span class="line">		bdesc = free_bucket_desc;</span><br><span class="line">		free_bucket_desc = bdesc-&gt;next;</span><br><span class="line">		bdesc-&gt;refcnt = <span class="number">0</span>;</span><br><span class="line">		bdesc-&gt;bucket_size = bdir-&gt;size;</span><br><span class="line">		bdesc-&gt;page = bdesc-&gt;freeptr = (<span class="keyword">void</span> *) cp = get_free_page();</span><br><span class="line">		<span class="keyword">if</span> (!cp)</span><br><span class="line">			panic(<span class="string">"Out of memory in kernel malloc()"</span>);</span><br><span class="line">		<span class="comment">/* Set up the chain of free objects */</span></span><br><span class="line">		<span class="keyword">for</span> (i=PAGE_SIZE/bdir-&gt;size; i &gt; <span class="number">1</span>; i--) &#123;</span><br><span class="line">			*((<span class="keyword">char</span> **) cp) = cp + bdir-&gt;size;	<span class="comment">// ！！！</span></span><br><span class="line">			cp += bdir-&gt;size;</span><br><span class="line">		&#125;</span><br><span class="line">		*((<span class="keyword">char</span> **) cp) = <span class="number">0</span>;</span><br><span class="line">		bdesc-&gt;next = bdir-&gt;chain; <span class="comment">/* OK, link it in! */</span></span><br><span class="line">		bdir-&gt;chain = bdesc;</span><br><span class="line">	&#125;</span><br><span class="line">	retval = (<span class="keyword">void</span> *) bdesc-&gt;freeptr;</span><br><span class="line">	bdesc-&gt;freeptr = *((<span class="keyword">void</span> **) retval);	<span class="comment">// 指向下一个空闲块</span></span><br><span class="line">	bdesc-&gt;refcnt++;</span><br><span class="line">	sti();	<span class="comment">/* OK, we're safe again */</span></span><br><span class="line">	<span class="keyword">return</span>(retval);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="free-s-函数"><a href="#free-s-函数" class="headerlink" title="free_s 函数"></a><strong>free_s 函数</strong></h1><p>free_s 函数定义如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/malloc.c --------------------------------</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Here is the free routine.  If you know the size of the object that you</span></span><br><span class="line"><span class="comment"> * are freeing, then free_s() will use that information to speed up the</span></span><br><span class="line"><span class="comment"> * search for the bucket descriptor.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * We will #define a macro so that "free(x)" is becomes "free_s(x, 0)"</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_s</span><span class="params">(<span class="keyword">void</span> *obj, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span>		*page;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">bucket_dir</span>	*<span class="title">bdir</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bucket_desc</span>	*<span class="title">bdesc</span>, *<span class="title">prev</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Calculate what page this object lives in */</span></span><br><span class="line">	page = (<span class="keyword">void</span> *)  ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) obj &amp; <span class="number">0xfffff000</span>);</span><br><span class="line">	<span class="comment">/* Now search the buckets looking for that page */</span></span><br><span class="line">	<span class="keyword">for</span> (bdir = bucket_dir; bdir-&gt;size; bdir++) &#123;</span><br><span class="line">		prev = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">/* If size is zero then this conditional is always false */</span></span><br><span class="line">		<span class="keyword">if</span> (bdir-&gt;size &lt; size)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">for</span> (bdesc = bdir-&gt;chain; bdesc; bdesc = bdesc-&gt;next) &#123;</span><br><span class="line">			<span class="keyword">if</span> (bdesc-&gt;page == page) </span><br><span class="line">				<span class="keyword">goto</span> found;</span><br><span class="line">			prev = bdesc;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	panic(<span class="string">"Bad address passed to kernel free_s()"</span>);</span><br><span class="line">found:</span><br><span class="line">	cli(); <span class="comment">/* To avoid race conditions */</span></span><br><span class="line">	*((<span class="keyword">void</span> **)obj) = bdesc-&gt;freeptr;</span><br><span class="line">	bdesc-&gt;freeptr = obj;</span><br><span class="line">	bdesc-&gt;refcnt--;</span><br><span class="line">	<span class="keyword">if</span> (bdesc-&gt;refcnt == <span class="number">0</span>) &#123;	<span class="comment">// 若引用计数为 0，表示该桶描述符对应的页面已经完全空出</span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * We need to make sure that prev is still accurate.  It</span></span><br><span class="line"><span class="comment">		 * may not be, if someone rudely interrupted us....</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> ((prev &amp;&amp; (prev-&gt;next != bdesc)) ||</span><br><span class="line">		    (!prev &amp;&amp; (bdir-&gt;chain != bdesc)))</span><br><span class="line">			<span class="keyword">for</span> (prev = bdir-&gt;chain; prev; prev = prev-&gt;next)</span><br><span class="line">				<span class="keyword">if</span> (prev-&gt;next == bdesc)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (prev)</span><br><span class="line">			prev-&gt;next = bdesc-&gt;next;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (bdir-&gt;chain != bdesc)</span><br><span class="line">				panic(<span class="string">"malloc bucket chains corrupted"</span>);</span><br><span class="line">			bdir-&gt;chain = bdesc-&gt;next;</span><br><span class="line">		&#125;</span><br><span class="line">		free_page((<span class="keyword">unsigned</span> <span class="keyword">long</span>) bdesc-&gt;page);</span><br><span class="line">		bdesc-&gt;next = free_bucket_desc;</span><br><span class="line">		free_bucket_desc = bdesc;</span><br><span class="line">	&#125;</span><br><span class="line">	sti();</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="现代-malloc-实现"><a href="#现代-malloc-实现" class="headerlink" title="现代 malloc 实现"></a><strong>现代 malloc 实现</strong></h1><p>在现代 Linux 系统中，有专用于内核程序的 kmalloc（在 Linux 0.11 称为 malloc）和专用于用户程序的 malloc 函数。</p>
<p>在这里，我们指的是专用于用户程序的 malloc 函数。关于其实现还是比较复杂的，可参考资料：  </p>
<ul>
<li><a href="http://blog.codinglabs.org/articles/a-malloc-tutorial.html" target="_blank" rel="noopener">如何实现一个 malloc</a>（<a href="http://pan.baidu.com/s/1nuA2AyX" target="_blank" rel="noopener">百度云盘备份</a>）</li>
<li><a href="http://pan.baidu.com/s/1c1GkCnu" target="_blank" rel="noopener">A malloc tutorial</a></li>
<li>《深入理解计算机系统》第 9.9 节“动态存储器分配”</li>
<li><a href="http://repo.or.cz/w/glibc.git/blob/HEAD:/malloc/malloc.c" target="_blank" rel="noopener">glibc.git/malloc/malloc.c</a></li>
</ul>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/03/14/linux-kenel-0-11-topic-timer-interrupt/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Linux 内核学习笔记：时钟中断
        
      </div>
    </a>
  
  
    <a href="/2016/03/13/linux-kenel-0-11-topic-inter-process-communication-signal/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Linux 内核学习笔记：进程通信之“信号”</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>







      <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>

<script>
var gitalk = new Gitalk({
  clientID: '64c19d7f57bebbb343c4',
  clientSecret: '287daeba39e73fdde92f24540c9f3c0fd5238512',
  repo: 'BlogComments',
  owner: 'xiemax100',
  admin: ['xiemax100'],
  id: md5(window.location.pathname),
  distractionFreeMode: true
})

gitalk.render('gitalk-container')
</script>






    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#数据结构"><span class="toc-number">1.</span> <span class="toc-text">数据结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#malloc-函数"><span class="toc-number">2.</span> <span class="toc-text">malloc 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#桶描述符链表初始化"><span class="toc-number">2.1.</span> <span class="toc-text">桶描述符链表初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc-函数-1"><span class="toc-number">2.2.</span> <span class="toc-text">malloc 函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#free-s-函数"><span class="toc-number">3.</span> <span class="toc-text">free_s 函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#现代-malloc-实现"><span class="toc-number">4.</span> <span class="toc-text">现代 malloc 实现</span></a></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录" title="点击按钮隐藏或者显示文章目录">

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var toc_button = document.getElementById("tocButton");
    var toc_div = document.getElementById("toc");
    toc_button.onclick=function() {
        if (toc_div.style.display == "none") {
            toc_div.style.display = "block";
            toc_button.value = "隐藏目录";
            document.getElementById("switch-btn").style.display = "none";
            document.getElementById("switch-area").style.display = "none";
        }
        else {
            toc_div.style.display = "none";
            toc_button.value = "显示目录";
            document.getElementById("switch-btn").style.display = "block";
            document.getElementById("switch-area").style.display = "block";
        }
    }

    if ($(".toc").length < 1) {
        $("#toc").css("display","none");
        $("#tocButton").css("display","none");
        $(".switch-btn").css("display","block");
        $(".switch-area").css("display","block");
    }
</script>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2020 Max
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>