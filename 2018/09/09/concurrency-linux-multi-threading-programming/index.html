<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>并发学习笔记：Linux 多线程编程初探 | Max&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本文迁移并整理自个人之前在博客园的博客。  本文参考资料：  《UNIX环境高级编程》 Linux 多线程编程（不限 Linux）（介绍部分摘录自该文，示例参考了该文） Linux 的多线程编程的高效开发经验  Linux 线程介绍进程与线程典型的 UNIX/Linux 进程可以看成只有一个控制线程：一个进程在同一时刻只做一件事情。有了多个控制线程后，在程序设计时可以把进程设计成在同一时刻做不止一">
<meta name="keywords" content="多线程">
<meta property="og:type" content="article">
<meta property="og:title" content="并发学习笔记：Linux 多线程编程初探">
<meta property="og:url" content="http://xiehongfeng100.github.io/2018/09/09/concurrency-linux-multi-threading-programming/index.html">
<meta property="og:site_name" content="Max&#39;s Blog">
<meta property="og:description" content="本文迁移并整理自个人之前在博客园的博客。  本文参考资料：  《UNIX环境高级编程》 Linux 多线程编程（不限 Linux）（介绍部分摘录自该文，示例参考了该文） Linux 的多线程编程的高效开发经验  Linux 线程介绍进程与线程典型的 UNIX/Linux 进程可以看成只有一个控制线程：一个进程在同一时刻只做一件事情。有了多个控制线程后，在程序设计时可以把进程设计成在同一时刻做不止一">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/concurrency/linux-multi-threading/linux-multi-threading-api-overview.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/concurrency/linux-multi-threading/example1-main-thread-dont-wait-for-children.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/concurrency/linux-multi-threading/example2-main-thread-wait-for-children.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/concurrency/linux-multi-threading/example3-outputs.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/concurrency/linux-multi-threading/example4-outputs.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/concurrency/linux-multi-threading/example5-outputs.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/concurrency/linux-multi-threading/example6-outputs.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/concurrency/linux-multi-threading/example7-outputs1.png">
<meta property="og:image" content="http://xiehongfeng100.github.io/images/concurrency/linux-multi-threading/example7-outputs2.png">
<meta property="og:updated_time" content="2019-05-01T04:37:19.464Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="并发学习笔记：Linux 多线程编程初探">
<meta name="twitter:description" content="本文迁移并整理自个人之前在博客园的博客。  本文参考资料：  《UNIX环境高级编程》 Linux 多线程编程（不限 Linux）（介绍部分摘录自该文，示例参考了该文） Linux 的多线程编程的高效开发经验  Linux 线程介绍进程与线程典型的 UNIX/Linux 进程可以看成只有一个控制线程：一个进程在同一时刻只做一件事情。有了多个控制线程后，在程序设计时可以把进程设计成在同一时刻做不止一">
<meta name="twitter:image" content="http://xiehongfeng100.github.io/images/concurrency/linux-multi-threading/linux-multi-threading-api-overview.png">
  
    <link rel="alternative" href="/atom.xml" title="Max&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="img/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/author.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Max</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Stay hungry, stay foolish.</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/categories/架构">架构</a></li>
				        
							<li><a href="/categories/读书">读书</a></li>
				        
							<li><a href="/tags/翻译">翻译</a></li>
				        
							<li><a href="/categories/网络">网络</a></li>
				        
							<li><a href="/categories/并发">并发</a></li>
				        
							<li><a href="/categories/安全">安全</a></li>
				        
							<li><a href="/categories/运维">运维</a></li>
				        
							<li><a href="/categories/数据库">数据库</a></li>
				        
							<li><a href="/categories/云计算">云计算</a></li>
				        
							<li><a href="/categories/编程语言">编程语言</a></li>
				        
							<li><a href="/categories/操作系统">操作系统</a></li>
				        
							<li><a href="/categories/机器学习">机器学习</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/xiehongfeng100" title="github">github</a>
					        
								<a class="linkedin" target="_blank" href="http://cn.linkedin.com/in/xiehongfeng100" title="linkedin">linkedin</a>
					        
								<a class="mail" target="_blank" href="mailto:xiehongfeng100@hotmail.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/tmp/" style="font-size: 10px;">/tmp</a> <a href="/tags/AT-T/" style="font-size: 10px;">AT&T</a> <a href="/tags/Affin/" style="font-size: 10px;">Affin</a> <a href="/tags/Alembic/" style="font-size: 10px;">Alembic</a> <a href="/tags/B-树/" style="font-size: 10px;">B+ 树</a> <a href="/tags/BIOS/" style="font-size: 10px;">BIOS</a> <a href="/tags/C-C/" style="font-size: 16.36px;">C/C++</a> <a href="/tags/CA/" style="font-size: 10px;">CA</a> <a href="/tags/CBOW/" style="font-size: 10px;">CBOW</a> <a href="/tags/CNN/" style="font-size: 10.91px;">CNN</a> <a href="/tags/DHCP/" style="font-size: 10px;">DHCP</a> <a href="/tags/Decorator/" style="font-size: 10px;">Decorator</a> <a href="/tags/Django/" style="font-size: 10px;">Django</a> <a href="/tags/Dnsmasq/" style="font-size: 10px;">Dnsmasq</a> <a href="/tags/ELF/" style="font-size: 10px;">ELF</a> <a href="/tags/ELK/" style="font-size: 10px;">ELK</a> <a href="/tags/Elasticsearch/" style="font-size: 11.82px;">Elasticsearch</a> <a href="/tags/GCC/" style="font-size: 10px;">GCC</a> <a href="/tags/HBR/" style="font-size: 10px;">HBR</a> <a href="/tags/IO-Multiplexing/" style="font-size: 11.82px;">IO Multiplexing</a> <a href="/tags/IPTables/" style="font-size: 10px;">IPTables</a> <a href="/tags/Immunity-Debugger/" style="font-size: 10px;">Immunity Debugger</a> <a href="/tags/InnoDB/" style="font-size: 10px;">InnoDB</a> <a href="/tags/KD-Tree/" style="font-size: 10.91px;">KD-Tree</a> <a href="/tags/KNN/" style="font-size: 10px;">KNN</a> <a href="/tags/KVM/" style="font-size: 10px;">KVM</a> <a href="/tags/Kali-Linux/" style="font-size: 10px;">Kali Linux</a> <a href="/tags/Keras/" style="font-size: 10px;">Keras</a> <a href="/tags/Keystone/" style="font-size: 13.64px;">Keystone</a> <a href="/tags/Kibana/" style="font-size: 10px;">Kibana</a> <a href="/tags/Lemmatization/" style="font-size: 10px;">Lemmatization</a> <a href="/tags/Libvirt/" style="font-size: 10.91px;">Libvirt</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/LinuxBridge/" style="font-size: 11.82px;">LinuxBridge</a> <a href="/tags/Logging/" style="font-size: 10px;">Logging</a> <a href="/tags/Logstash/" style="font-size: 10px;">Logstash</a> <a href="/tags/MRO/" style="font-size: 10px;">MRO</a> <a href="/tags/Metasploit-Framwork/" style="font-size: 10px;">Metasploit Framwork</a> <a href="/tags/MySQL/" style="font-size: 10.91px;">MySQL</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/Namespace/" style="font-size: 10px;">Namespace</a> <a href="/tags/Neo4J/" style="font-size: 10.91px;">Neo4J</a> <a href="/tags/Neutron/" style="font-size: 13.64px;">Neutron</a> <a href="/tags/Nova/" style="font-size: 14.55px;">Nova</a> <a href="/tags/OpenStack/" style="font-size: 17.27px;">OpenStack</a> <a href="/tags/OpenVSwitch/" style="font-size: 10px;">OpenVSwitch</a> <a href="/tags/PKI/" style="font-size: 10.91px;">PKI</a> <a href="/tags/PasteDeploy/" style="font-size: 10.91px;">PasteDeploy</a> <a href="/tags/Policy/" style="font-size: 10px;">Policy</a> <a href="/tags/Python/" style="font-size: 18.18px;">Python</a> <a href="/tags/QEMU/" style="font-size: 10px;">QEMU</a> <a href="/tags/RBAC/" style="font-size: 10px;">RBAC</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/SQLAlchemy-Migrate/" style="font-size: 10px;">SQLAlchemy-Migrate</a> <a href="/tags/SSL/" style="font-size: 10px;">SSL</a> <a href="/tags/Sigmoid/" style="font-size: 10px;">Sigmoid</a> <a href="/tags/Skip-Gram/" style="font-size: 10px;">Skip-Gram</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Stop-Words/" style="font-size: 10px;">Stop Words</a> <a href="/tags/TCP/" style="font-size: 10px;">TCP</a> <a href="/tags/Tap/" style="font-size: 10.91px;">Tap</a> <a href="/tags/Token/" style="font-size: 11.82px;">Token</a> <a href="/tags/Tokenization/" style="font-size: 10px;">Tokenization</a> <a href="/tags/Trampolining/" style="font-size: 10px;">Trampolining</a> <a href="/tags/Tun/" style="font-size: 10.91px;">Tun</a> <a href="/tags/Tunnel/" style="font-size: 10px;">Tunnel</a> <a href="/tags/UUID/" style="font-size: 10px;">UUID</a> <a href="/tags/VNC/" style="font-size: 10px;">VNC</a> <a href="/tags/VPN/" style="font-size: 10px;">VPN</a> <a href="/tags/Veth/" style="font-size: 11.82px;">Veth</a> <a href="/tags/VirtualBox/" style="font-size: 10px;">VirtualBox</a> <a href="/tags/Vlan/" style="font-size: 10px;">Vlan</a> <a href="/tags/Vue/" style="font-size: 10px;">Vue</a> <a href="/tags/WSGI/" style="font-size: 13.64px;">WSGI</a> <a href="/tags/Webob/" style="font-size: 10px;">Webob</a> <a href="/tags/Word2Vec/" style="font-size: 10.91px;">Word2Vec</a> <a href="/tags/Yelper/" style="font-size: 15.45px;">Yelper</a> <a href="/tags/bootsect/" style="font-size: 10px;">bootsect</a> <a href="/tags/cookiecutter/" style="font-size: 10px;">cookiecutter</a> <a href="/tags/delete/" style="font-size: 10px;">delete</a> <a href="/tags/dnsmasq/" style="font-size: 10px;">dnsmasq</a> <a href="/tags/entry-points/" style="font-size: 10px;">entry_points</a> <a href="/tags/epoll/" style="font-size: 10px;">epoll</a> <a href="/tags/fork/" style="font-size: 10px;">fork</a> <a href="/tags/head/" style="font-size: 10px;">head</a> <a href="/tags/inode/" style="font-size: 10px;">inode</a> <a href="/tags/malloc/" style="font-size: 10px;">malloc</a> <a href="/tags/mona/" style="font-size: 10px;">mona</a> <a href="/tags/new/" style="font-size: 10px;">new</a> <a href="/tags/property/" style="font-size: 10px;">property</a> <a href="/tags/read/" style="font-size: 10px;">read</a> <a href="/tags/routes/" style="font-size: 10px;">routes</a> <a href="/tags/select/" style="font-size: 10px;">select</a> <a href="/tags/setup/" style="font-size: 10px;">setup</a> <a href="/tags/setuptools/" style="font-size: 10px;">setuptools</a> <a href="/tags/shell/" style="font-size: 10.91px;">shell</a> <a href="/tags/stevedore/" style="font-size: 10px;">stevedore</a> <a href="/tags/string/" style="font-size: 10px;">string</a> <a href="/tags/tcpdump/" style="font-size: 10px;">tcpdump</a> <a href="/tags/uWSGI/" style="font-size: 10px;">uWSGI</a> <a href="/tags/update-进程/" style="font-size: 10px;">update 进程</a> <a href="/tags/write/" style="font-size: 10px;">write</a> <a href="/tags/wsgiref/" style="font-size: 10px;">wsgiref</a> <a href="/tags/yield/" style="font-size: 14.55px;">yield</a> <a href="/tags/中断/" style="font-size: 10.91px;">中断</a> <a href="/tags/任务调度/" style="font-size: 10px;">任务调度</a> <a href="/tags/传记/" style="font-size: 10.91px;">传记</a> <a href="/tags/信号/" style="font-size: 10px;">信号</a> <a href="/tags/信号量/" style="font-size: 10px;">信号量</a> <a href="/tags/内存对齐/" style="font-size: 10px;">内存对齐</a> <a href="/tags/内存映射-I-O/" style="font-size: 10px;">内存映射 I/O</a> <a href="/tags/内存规划/" style="font-size: 10px;">内存规划</a> <a href="/tags/内核/" style="font-size: 19.09px;">内核</a> <a href="/tags/内核栈/" style="font-size: 10px;">内核栈</a> <a href="/tags/分页/" style="font-size: 10px;">分页</a> <a href="/tags/加密/" style="font-size: 10.91px;">加密</a> <a href="/tags/加载/" style="font-size: 10.91px;">加载</a> <a href="/tags/协程/" style="font-size: 13.64px;">协程</a> <a href="/tags/可执行目标文件/" style="font-size: 10.91px;">可执行目标文件</a> <a href="/tags/可重定位目标文件/" style="font-size: 10px;">可重定位目标文件</a> <a href="/tags/同步/" style="font-size: 10px;">同步</a> <a href="/tags/商业/" style="font-size: 11.82px;">商业</a> <a href="/tags/地心坐标系/" style="font-size: 10px;">地心坐标系</a> <a href="/tags/多线程/" style="font-size: 10.91px;">多线程</a> <a href="/tags/多进程/" style="font-size: 10px;">多进程</a> <a href="/tags/字符串/" style="font-size: 10px;">字符串</a> <a href="/tags/存储器/" style="font-size: 10.91px;">存储器</a> <a href="/tags/宏/" style="font-size: 10px;">宏</a> <a href="/tags/寄存器/" style="font-size: 10px;">寄存器</a> <a href="/tags/开发环境/" style="font-size: 10px;">开发环境</a> <a href="/tags/异常/" style="font-size: 10px;">异常</a> <a href="/tags/异步/" style="font-size: 10px;">异步</a> <a href="/tags/引导块/" style="font-size: 10px;">引导块</a> <a href="/tags/引导程序/" style="font-size: 12.73px;">引导程序</a> <a href="/tags/归一化/" style="font-size: 10px;">归一化</a> <a href="/tags/微处理器/" style="font-size: 13.64px;">微处理器</a> <a href="/tags/总结/" style="font-size: 10px;">总结</a> <a href="/tags/情感分析/" style="font-size: 10px;">情感分析</a> <a href="/tags/扩容/" style="font-size: 10px;">扩容</a> <a href="/tags/指令集/" style="font-size: 10px;">指令集</a> <a href="/tags/指针/" style="font-size: 12.73px;">指针</a> <a href="/tags/数字签名/" style="font-size: 10px;">数字签名</a> <a href="/tags/数字证书/" style="font-size: 10px;">数字证书</a> <a href="/tags/整数/" style="font-size: 10px;">整数</a> <a href="/tags/文件系统/" style="font-size: 12.73px;">文件系统</a> <a href="/tags/时钟/" style="font-size: 10px;">时钟</a> <a href="/tags/时钟中断/" style="font-size: 10px;">时钟中断</a> <a href="/tags/时间衰减函数/" style="font-size: 10px;">时间衰减函数</a> <a href="/tags/权限/" style="font-size: 10px;">权限</a> <a href="/tags/架构实践/" style="font-size: 10px;">架构实践</a> <a href="/tags/标准输入/" style="font-size: 10px;">标准输入</a> <a href="/tags/标准输出/" style="font-size: 10px;">标准输出</a> <a href="/tags/标准错误输出/" style="font-size: 10px;">标准错误输出</a> <a href="/tags/栈帧/" style="font-size: 10px;">栈帧</a> <a href="/tags/栈溢出/" style="font-size: 10px;">栈溢出</a> <a href="/tags/根设备/" style="font-size: 10px;">根设备</a> <a href="/tags/母板/" style="font-size: 10px;">母板</a> <a href="/tags/汇编/" style="font-size: 10px;">汇编</a> <a href="/tags/浮点数/" style="font-size: 10px;">浮点数</a> <a href="/tags/消息摘要/" style="font-size: 10px;">消息摘要</a> <a href="/tags/特权级/" style="font-size: 10px;">特权级</a> <a href="/tags/环境变量/" style="font-size: 10px;">环境变量</a> <a href="/tags/生成器/" style="font-size: 14.55px;">生成器</a> <a href="/tags/用户栈/" style="font-size: 10px;">用户栈</a> <a href="/tags/相似度/" style="font-size: 10.91px;">相似度</a> <a href="/tags/硬盘/" style="font-size: 12.73px;">硬盘</a> <a href="/tags/硬链接/" style="font-size: 10px;">硬链接</a> <a href="/tags/管道/" style="font-size: 10px;">管道</a> <a href="/tags/系统调用/" style="font-size: 10px;">系统调用</a> <a href="/tags/索引/" style="font-size: 10px;">索引</a> <a href="/tags/缓冲区/" style="font-size: 10.91px;">缓冲区</a> <a href="/tags/缓冲区溢出/" style="font-size: 10px;">缓冲区溢出</a> <a href="/tags/缺页中断/" style="font-size: 10px;">缺页中断</a> <a href="/tags/网络/" style="font-size: 13.64px;">网络</a> <a href="/tags/翻译/" style="font-size: 14.55px;">翻译</a> <a href="/tags/虚拟地址空间/" style="font-size: 10px;">虚拟地址空间</a> <a href="/tags/虚拟盘/" style="font-size: 10px;">虚拟盘</a> <a href="/tags/请求项/" style="font-size: 10px;">请求项</a> <a href="/tags/质数/" style="font-size: 10px;">质数</a> <a href="/tags/超级块/" style="font-size: 10px;">超级块</a> <a href="/tags/软盘/" style="font-size: 10px;">软盘</a> <a href="/tags/软链接/" style="font-size: 10px;">软链接</a> <a href="/tags/进程派生/" style="font-size: 10px;">进程派生</a> <a href="/tags/进程通信/" style="font-size: 10.91px;">进程通信</a> <a href="/tags/迭代器/" style="font-size: 10px;">迭代器</a> <a href="/tags/金融/" style="font-size: 10px;">金融</a> <a href="/tags/阻塞/" style="font-size: 10.91px;">阻塞</a> <a href="/tags/非阻塞/" style="font-size: 10.91px;">非阻塞</a> <a href="/tags/黑客/" style="font-size: 10px;">黑客</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">谢宏峰，毕业于暨南大学（2009 - 2013）、中国科学院（2013 - 2016），现就职于深信服科技，从事 OpenStack 开发。</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Max</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/img/author.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Max</h1>
			</hgroup>
			
			<p class="header-subtitle">Stay hungry, stay foolish.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/categories/架构">架构</a></li>
		        
					<li><a href="/categories/读书">读书</a></li>
		        
					<li><a href="/tags/翻译">翻译</a></li>
		        
					<li><a href="/categories/网络">网络</a></li>
		        
					<li><a href="/categories/并发">并发</a></li>
		        
					<li><a href="/categories/安全">安全</a></li>
		        
					<li><a href="/categories/运维">运维</a></li>
		        
					<li><a href="/categories/数据库">数据库</a></li>
		        
					<li><a href="/categories/云计算">云计算</a></li>
		        
					<li><a href="/categories/编程语言">编程语言</a></li>
		        
					<li><a href="/categories/操作系统">操作系统</a></li>
		        
					<li><a href="/categories/机器学习">机器学习</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/xiehongfeng100" title="github">github</a>
			        
						<a class="linkedin" target="_blank" href="http://cn.linkedin.com/in/xiehongfeng100" title="linkedin">linkedin</a>
			        
						<a class="mail" target="_blank" href="mailto:xiehongfeng100@hotmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-concurrency-linux-multi-threading-programming" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/09/09/concurrency-linux-multi-threading-programming/" class="article-date">
  	<time datetime="2018-09-09T04:02:16.000Z" itemprop="datePublished">2018-09-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      并发学习笔记：Linux 多线程编程初探
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/多线程/">多线程</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/并发/">并发</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文迁移并整理自个人之前在博客园的<a href="https://www.cnblogs.com/xiehongfeng100/p/4620852.html" target="_blank" rel="noopener">博客</a>。</p>
<hr>
<p>本文参考资料：</p>
<ul>
<li>《UNIX环境高级编程》</li>
<li><a href="http://www.cnblogs.com/skynet/archive/2010/10/30/1865267.HTML" target="_blank" rel="noopener">Linux 多线程编程（不限 Linux）</a>（介绍部分摘录自该文，示例参考了该文）</li>
<li><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-mthreadps/" target="_blank" rel="noopener">Linux 的多线程编程的高效开发经验</a></li>
</ul>
<h1 id="Linux-线程介绍"><a href="#Linux-线程介绍" class="headerlink" title="Linux 线程介绍"></a><strong>Linux 线程介绍</strong></h1><h2 id="进程与线程"><a href="#进程与线程" class="headerlink" title="进程与线程"></a><strong>进程与线程</strong></h2><p>典型的 UNIX/Linux 进程可以看成只有一个控制线程：一个进程在同一时刻只做一件事情。有了多个控制线程后，在程序设计时可以把进程设计成在同一时刻做不止一件事，每个线程各自处理独立的任务。　　</p>
<p>进程是程序执行时的一个实例，是担当分配系统资源（CPU 时间、内存等）的基本单位。在面向线程设计的系统中，进程本身不是基本运行单位，而是线程的容器。程序本身只是指令、数据及其组织形式的描述，进程才是程序（那些指令和数据）的真正运行实例。</p>
<p>线程是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务。线程包含了表示进程内执行环境必须的信息，其中包括进程中表示线程的线程ID、一组寄存器值、栈、调度优先级和策略、信号屏蔽字、errno 常量以及线程私有数据。进程的所有信息对该进程的所有线程都是共享的，包括可执行的程序文本、程序的全局内存和堆内存、栈以及文件描述符。在 Unix 和类 Unix 操作系统中线程也被称为轻量级进程（lightweight processes），但轻量级进程更多指的是内核线程（kernel thread），而把用户线程（user thread）称为线程。</p>
<blockquote>
<p>进程 — 资源分配的最小单位，线程 — 程序执行的最小单位</p>
</blockquote>
<p>进程有独立的地址空间，一个进程崩溃后，在保护模式下不会对其它进程产生影响，而线程只是一个进程中的不同执行路径。线程有自己的堆栈和局部变量，但线程没有单独的地址空间，一个线程死掉就等于整个进程死掉，所以多进程的程序要比多线程的程序健壮，但在进程切换时，耗费资源较大，效率要差一些。但对于一些要求同时进行并且又要共享某些变量的并发操作，只能用线程，不能用进程。</p>
<p>从函数调用上来说，进程创建使用fork()操作；线程创建使用clone()操作。<a href="http://poincare.matf.bg.ac.rs/~ivana/courses/tos/sistemi_knjige/pomocno/unp/UNP/0131411551_ch26lev1sec1.html" target="_blank" rel="noopener">Richard Stevens大师</a>这样说过：</p>
<blockquote>
<ul>
<li>fork is expensive. Memory is copied from the parent to the child, all descriptors are duplicated in the child, and so on. Current implementations use a technique called copy-on-write, which avoids a copy of the parent’s data space to the child until the child needs its own copy. But, regardless of this optimization,fork is expensive.</li>
<li>IPC is required to pass information between the parent and child after the fork. Passing information from the parent to the child before the fork is easy, since the child starts with a copy of the parent’s data space and with a copy of all the parent’s descriptors. But, returning information from the child to the parent takes more work.<br><code>Threads help with both problems. Threads are sometimes called lightweight processes since a thread is &quot;lighter weight&quot; than a process.</code> That is, thread creation can be 10–100 times faster than process creation.<br><code>All threads within a process share the same global memory. This makes the sharing of information easy between the threads, but along with this simplicity comes the problem of synchronization.</code></li>
</ul>
</blockquote>
<a id="more"></a>
<h2 id="使用线程的理由"><a href="#使用线程的理由" class="headerlink" title="使用线程的理由"></a><strong>使用线程的理由</strong></h2><p>从上面我们知道了进程与线程的区别，其实这些区别也就是我们使用线程的理由。总的来说就是：进程有独立的地址空间，线程没有单独的地址空间（同一进程内的线程共享进程的地址空间）。</p>
<p>使用多线程的<strong>理由之一</strong>是和进程相比，它是一种非常”节俭”的多任务操作方式。我们知道，在 Linux 系统下，启动一个新的进程必须分配给它独立的地址空间，建立众多的数据表来维护它的代码段、堆栈段和数据段，这是一种”昂贵”的多任务工作方式。而运行于一个进程中的多个线程，它们彼此之间使用相同的地址空间，共享大部分数据，启动一个线程所花费的空间远远小于启动一个进程所花费的空间，而且，线程间彼此切换所需的时间也远远小于进程间切换所需要的时间。据统计，总的说来，一个进程的开销大约是一个线程开销的 30 倍左右，当然，在具体的系统上，这个数据可能会有较大的区别。</p>
<p>使用多线程的<strong>理由之二</strong>是线程间方便的通信机制。对不同进程来说，它们具有独立的数据空间，要进行数据的传递只能通过通信的方式进行，这种方式不仅费时，而且很不方便。线程则不然，由于同一进程下的线程之间共享数据空间，所以一个线程的数据可以直接为其它线程所用，这不仅快捷，而且方便。当然，数据的共享也带来其他一些问题，有的变量不能同时被两个线程所修改，有的子程序中声明为 static 的数据更有可能给多线程程序带来灾难性的打击，这些正是编写多线程程序时最需要注意的地方。</p>
<p>除了以上所说的优点外，不和进程比较，多线程程序作为一种多任务、并发的工作方式，当然有以下的优点：</p>
<ul>
<li>提高应用程序响应。这对图形界面的程序尤其有意义，当一个操作耗时很长时，整个系统都会等待这个操作，此时程序不会响应键盘、鼠标、菜单的操作，而使用多线程技术，将耗时长的操作（time consuming）置于一个新的线程，可以避免这种尴尬的情况。</li>
<li>使多 CPU 系统更加有效。操作系统会保证当线程数不大于 CPU 数目时，不同的线程运行于不同的 CPU 上。</li>
<li>改善程序结构。一个既长又复杂的进程可以考虑分为多个线程，成为几个独立或半独立的运行部分，这样的程序会利于理解和修改。</li>
</ul>
<h1 id="Linux-上线程开发-API-概要"><a href="#Linux-上线程开发-API-概要" class="headerlink" title="Linux 上线程开发 API 概要"></a><strong>Linux 上线程开发 API 概要</strong></h1><p>多线程开发在 Linux 平台上已经有成熟的 pthread 库支持。其涉及的多线程开发的最基本概念主要包含三点：线程，互斥锁，条件。其中，线程操作又分线程的创建，退出，等待 3 种。互斥锁则包括 4 种操作，分别是创建，销毁，加锁和解锁。条件操作有 5 种操作：创建，销毁，触发，广播和等待。其他的一些线程扩展概念，如信号灯等，都可以通过上面的三个基本元素的基本操作封装出来。详细请见下表：</p>
<p><img src="/images/concurrency/linux-multi-threading/linux-multi-threading-api-overview.png" alt>  </p>
<h2 id="与线程自身相关-API"><a href="#与线程自身相关-API" class="headerlink" title="与线程自身相关 API"></a><strong>与线程自身相关 API</strong></h2><p><strong>1. 线程创建</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_create</span><span class="params">(<span class="keyword">pthread_t</span> *<span class="keyword">restrict</span> tidp, <span class="keyword">const</span> <span class="keyword">pthread_attr_t</span> *<span class="keyword">restrict</span> attr, <span class="keyword">void</span> *(*start_rtn)(<span class="keyword">void</span> *), <span class="keyword">void</span> *<span class="keyword">restrict</span> arg)</span></span>;</span><br><span class="line"><span class="comment">// 返回：若成功返回 0，否则返回错误编号</span></span><br></pre></td></tr></table></figure></p>
<p>当 <a href="http://man7.org/linux/man-pages/man3/pthread_create.3.html" target="_blank" rel="noopener">pthread_create</a> 成功返回时，由 tidp 指向的内存单元被设置为新创建线程的线程ID。attr 参数用于定制各种不同的线程属性，暂可以把它设置为 NULL，以创建默认属性的线程。</p>
<p>新创建的线程从 start_rtn 函数的地址开始运行，该函数只有一个无类型指针参数 arg。如果需要向 start_rtn 函数传递的参数不止一个，那么需要把这些参数放到一个结构中，然后把这个结构的地址作为arg参数传入。</p>
<p><strong>2. 线程退出</strong><br>单个线程可以通过以下三种方式退出，在不终止整个进程的情况下停止它的控制流：<br>1）线程只是从启动例程中返回，返回值是线程的退出码。<br>2）线程可以被同一进程中的其他线程取消。<br>3）线程调用 pthread_exit：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_exit</span><span class="params">(<span class="keyword">void</span> *rval_ptr)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>rval_ptr 是一个无类型指针，与传给启动例程的单个参数类似。进程中的其他线程可以通过调用 pthread_join 函数访问到这个指针。</p>
<p><strong>注意： pthread_exit、return 及 exit 区别</strong></p>
<blockquote>
<p>pthread_exit 用于线程退出，可以指定返回值，以便其他线程通过 pthread_join 函数获取该线程的返回值。<br>return 是函数返回，只有线程函数 return，线程才会退出。<br>exit 是进程退出，如果在线程函数中调用 exit，进程中的所有函数都会退出！</p>
</blockquote>
<p><strong>3. 线程等待</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_join</span><span class="params">(<span class="keyword">pthread_t</span> thread, <span class="keyword">void</span> **rval_ptr)</span></span>;</span><br><span class="line"><span class="comment">// 返回：若成功返回 0，否则返回错误编号</span></span><br></pre></td></tr></table></figure></p>
<p>调用这个函数的线程将一直阻塞，直到指定的线程调用 pthread_exit、从启动例程中返回或者被取消。如果例程只是从它的启动例程返回，rval_ptr 将包含返回码。如果线程被取消，由 rval_ptr 指定的内存单元就置为 PTHREAD_CANCELED。</p>
<p>可以通过调用 pthread_join 自动把线程置于分离状态，这样资源就可以恢复。如果线程已经处于分离状态，pthread_join 调用就会失败，返回 EINVAL。</p>
<p>如果对线程的返回值不感兴趣，可以把 rval_ptr 置为 NULL。在这种情况下，调用 pthread_join 函数将等待指定的线程终止，但并不获得线程的终止状态。</p>
<p><strong>4. 线程脱离</strong><br>一个线程或者是可汇合（joinable，默认值），或者是脱离的（detached）。当一个可汇合的线程终止时，它的线程 ID 和退出状态将留存到另一个线程对它调用 pthread_join。脱离的线程却像守护进程，当它们终止时，所有相关的资源都被释放，我们不能等待它们终止。如果一个线程需要知道另一线程什么时候终止，那就最好保持第二个线程的可汇合状态。</p>
<p>pthread_detach 函数把指定的线程转变为脱离状态。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_detach</span><span class="params">(<span class="keyword">pthread_t</span> thread)</span></span>;</span><br><span class="line"><span class="comment">// 返回：若成功返回 0，否则返回错误编号</span></span><br></pre></td></tr></table></figure></p>
<p>本函数通常由想让自己脱离的线程使用，就如以下语句：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pthread_detach(pthread_self());</span><br></pre></td></tr></table></figure></p>
<p><strong>5. 线程ID获取及比较</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="keyword">pthread_t</span> pthread_self(<span class="keyword">void</span>);</span><br><span class="line"><span class="comment">// 返回：调用线程的 ID</span></span><br></pre></td></tr></table></figure></p>
<p>对于线程 ID 比较，为了可移植操作，我们不能简单地把线程 ID 当作整数来处理，因为不同系统对线程 ID 的定义可能不一样。我们应该要用下边的函数：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_equal</span><span class="params">(<span class="keyword">pthread_t</span> tid1, <span class="keyword">pthread_t</span> tid2)</span></span>;</span><br><span class="line"><span class="comment">// 返回：若相等则返回非 0 值，否则返回 0</span></span><br></pre></td></tr></table></figure></p>
<p>对于多线程程序来说，我们往往需要对这些多线程进行同步。<code>同步（synchronization）是指在一定的时间内只允许某一个线程访问某个资源。而在此时间内，不允许其它的线程访问该资源。</code>我们可以通过互斥锁（mutex），条件变量（condition variable）和读写锁（reader-writer lock）来同步资源。在这里，我们暂不介绍读写锁。</p>
<h2 id="与互斥锁相关-API"><a href="#与互斥锁相关-API" class="headerlink" title="与互斥锁相关 API"></a><strong>与互斥锁相关 API</strong></h2><p>互斥量（mutex）从本质上来说是一把锁，在访问共享资源前对互斥量进行加锁，在访问完成后释放互斥量上的锁。对互斥量进行加锁后，任何其他试图再次对互斥量加锁的线程将会被阻塞直到当前线程释放该互斥锁。如果释放互斥锁时有多个线程阻塞，所有在该互斥锁上的阻塞线程都会变成可运行状态，第一个变为可运行状态的线程可以对互斥量加锁，其他线程将会看到互斥锁依然被锁住，只能回去等待它重新变为可用。在这种方式下，每次只有一个线程可以向前运行。</p>
<p>在设计时需要规定所有的线程必须遵守相同的数据访问规则。只有这样，互斥机制才能正常工作。操作系统并不会做数据访问的串行化。如果允许其中的某个线程在没有得到锁的情况下也可以访问共享资源，那么即使其它的线程在使用共享资源前都获取了锁，也还是会出现数据不一致的问题。</p>
<p>互斥变量用 pthread_mutex_t 数据类型表示。在使用互斥变量前必须对它进行初始化，可以把它置为常量 PTHREAD_MUTEX_INITIALIZER（只对静态分配的互斥量），也可以通过调用 pthread_mutex_init 函数进行初始化。如果动态地分配互斥量（例如通过调用 malloc 函数），那么在释放内存前需要调用 pthread_mutex_destroy。</p>
<p><strong>1. 创建及销毁互斥锁</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_init</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex, <span class="keyword">const</span> <span class="keyword">pthread_mutexattr_t</span> *<span class="keyword">restrict</span> attr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_destroy</span><span class="params">(<span class="keyword">pthread_mutex_t</span> mutex)</span></span>;</span><br><span class="line"><span class="comment">// 返回：若成功返回 0，否则返回错误编号</span></span><br></pre></td></tr></table></figure></p>
<p>要用默认的属性初始化互斥量，只需把 attr 设置为 NULL。</p>
<p><strong>2. 加锁及解锁</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_lock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> mutex)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_trylock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> mutex)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_unlock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> mutex)</span></span>;</span><br><span class="line"><span class="comment">// 返回：若成功返回 0，否则返回错误编号</span></span><br></pre></td></tr></table></figure></p>
<p>如果线程不希望被阻塞，它可以使用 pthread_mutex_trylock 尝试对互斥量进行加锁。如果调用 pthread_mutex_trylock 时互斥量处于未锁住状态，那么 pthread_mutex_trylock 将锁住互斥量，不会出现阻塞并返回 0，否则 pthread_mutex_trylock 就会失败，不能锁住互斥量，而返回 EBUSY。</p>
<h2 id="与条件变量相关-API"><a href="#与条件变量相关-API" class="headerlink" title="与条件变量相关 API"></a><strong>与条件变量相关 API</strong></h2><p>条件变量是线程另一可用的同步机制。条件变量给多个线程提供了一个会合的场所。条件变量与互斥量一起使用时，允许线程以无竞争的方式等待特定的条件发生。</p>
<p>条件本身是由互斥量保护的。线程在改变条件状态前必须首先锁住互斥量，其他线程在获得互斥量之前不会察觉到这种改变，因为必须锁定互斥量以后才能计算条件。</p>
<p>条件变量使用之前必须首先初始化，pthread_cond_t 数据类型代表的条件变量可以用两种方式进行初始化，可以把常量 PTHREAD_COND_INITIALIZER 赋给静态分配的条件变量，但是如果条件变量是动态分配的，可以使用 pthread_cond_destroy 函数对条件变量进行去除初始化（deinitialize）。</p>
<p><strong>1. 创建及销毁条件变量</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_init</span><span class="params">(<span class="keyword">pthread_cond_t</span> *<span class="keyword">restrict</span> cond, <span class="keyword">const</span> <span class="keyword">pthread_condattr_t</span> *<span class="keyword">restrict</span> attr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_destroy</span><span class="params">(<span class="keyword">pthread_cond_t</span> cond)</span></span>;</span><br><span class="line"><span class="comment">// 返回：若成功返回 0，否则返回错误编号</span></span><br></pre></td></tr></table></figure></p>
<p>除非需要创建一个非默认属性的条件变量，否则 pthread_cont_init 函数的 attr 参数可以设置为 NULL。</p>
<p><strong>2. 等待</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_wait</span><span class="params">(<span class="keyword">pthread_cond_t</span> *<span class="keyword">restrict</span> cond, <span class="keyword">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_timedwait</span><span class="params">(<span class="keyword">pthread_cond_t</span> *<span class="keyword">restrict</span> cond, <span class="keyword">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex, cond struct timespec *<span class="keyword">restrict</span> timeout)</span></span>;</span><br><span class="line"><span class="comment">// 返回：若成功返回 0，否则返回错误编号</span></span><br></pre></td></tr></table></figure></p>
<p>pthread_cond_wait 等待条件变为真。如果在给定的时间内条件不能满足，那么会生成一个代表一个出错码的返回变量。传递给 pthread_cond_wait 的互斥量对条件进行保护，调用者把锁住的互斥量传给函数。函数把调用线程放到等待条件的线程列表上，然后对互斥量解锁，这两个操作都是原子操作。这样就关闭了条件检查和线程进入休眠状态等待条件改变这两个操作之间的时间通道，这样线程就不会错过条件的任何变化。pthread_cond_wait 返回时，互斥量再次被锁住。</p>
<p>pthread_cond_timedwait 函数的工作方式与 pthread_cond_wait 函数类似，只是多了一个 timeout。timeout 指定了等待的时间，它是通过 timespec 结构指定。</p>
<p><strong>3. 触发</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_signal</span><span class="params">(<span class="keyword">pthread_cond_t</span> cond)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_broadcast</span><span class="params">(<span class="keyword">pthread_cond_t</span> cond)</span></span>;</span><br><span class="line"><span class="comment">// 返回：若成功返回 0，否则返回错误编号</span></span><br></pre></td></tr></table></figure></p>
<p>这两个函数可以用于通知线程条件已经满足。pthread_cond_signal 函数将唤醒等待该条件的某个线程，而 pthread_cond_broadcast 函数将唤醒等待该条件的所有进程。</p>
<p>注意一定要在改变条件状态以后再给线程发信号。</p>
<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a><strong>示例</strong></h1><h2 id="示例-1：创建一个简单的线程"><a href="#示例-1：创建一个简单的线程" class="headerlink" title="示例 1：创建一个简单的线程"></a><strong>示例 1：创建一个简单的线程</strong></h2><p>下边程序中创建了一个简单的线程 thread1，负责将全局变量 g_Flag 重置为 1：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unsigned int unit;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_Flag = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread1</span><span class="params">(<span class="keyword">void</span> *)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter main function.\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> tid1;</span><br><span class="line">    <span class="keyword">int</span> err1 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    err1 = pthread_create(&amp;tid1, <span class="literal">NULL</span>, thread1, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(err1 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err1));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"This is main the thread, process ID is %u, thread ID is %u, and g_Flag is %d.\n"</span>, (uint)getpid(), (uint)pthread_self, g_Flag);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Leave main functiona.\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread1</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter thread1.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"This is thread1, process ID is %u, thread ID is %u, and g_Flag is %d.\n"</span>, (uint)getpid(), (uint)pthread_self, g_Flag);</span><br><span class="line">    g_Flag = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"This is thread1, process ID is %u, thread ID is %u, and g_Flag is %d.\n"</span>, (uint)getpid(), (uint)pthread_self, g_Flag);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Leave thread1.\n"</span>);</span><br><span class="line">    pthread_exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序运行结果如下：<br><img src="/images/concurrency/linux-multi-threading/example1-main-thread-dont-wait-for-children.png" alt>  </p>
<p>很明显，该程序的进程并没有执行线程 thread1。</p>
<p>具体原因是主线程与新线程存在竞争：<strong>主线程需要休眠，如果主线程不休眠，它就可能退出，这样在新线程有机会运行之前整个进程就已经终止了。</strong>这种行为依赖于操作系统的线程实现方法和调度方法。</p>
<p>这个程序还有一点值得注意的，就是新线程 thread1 是通过调用 pthread_self 函数获取自己的线程 ID，而不是从共享内存中读出或者从线程的启动例程（pthread_create(…)）中以参数（tid）的形式接收到。<code>在上边的程序中，主线程把新线程 ID 存放在 tid1 中，但是新建的线程并不能安全地使用它。如果新线程在主线程调用 pthread_create 返回之前就运行了，那么新线程看到的是未经初始化的 tid1 的内容，这个内容并不是正确的线程 ID。</code></p>
<h2 id="示例-2：改进示例-1"><a href="#示例-2：改进示例-1" class="headerlink" title="示例 2：改进示例 1"></a><strong>示例 2：改进示例 1</strong></h2><p>这一次，我们在示例1程序的第 25、26 行之间插入<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sleep(<span class="number">1</span>);</span><br></pre></td></tr></table></figure></p>
<p>程序输出如下：<br><img src="/images/concurrency/linux-multi-threading/example2-main-thread-wait-for-children.png" alt>  </p>
<p>这一次，很明显线程 1 已被执行。主线程和线程 1 的进程 ID 号一样是没问题的，关键是线程号还一样（新线程中输出的线程 ID 是主线程的），这说明主线程跟新线程还是存在竞争。</p>
<h2 id="示例-3：改进示例-2"><a href="#示例-3：改进示例-2" class="headerlink" title="示例 3：改进示例 2"></a><strong>示例 3：改进示例 2</strong></h2><p>示例3程序如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unsigned int unit;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_Flag = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printids</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread1</span><span class="params">(<span class="keyword">void</span> *)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter main function.\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> tid1;</span><br><span class="line">    <span class="keyword">int</span> err1 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    err1 = pthread_create(&amp;tid1, <span class="literal">NULL</span>, thread1, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(err1 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err1));</span><br><span class="line"></span><br><span class="line">    printids(<span class="string">"This is the main thread"</span>);    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Leave main function.\n"</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printids</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span>        pid;</span><br><span class="line">    <span class="keyword">pthread_t</span>    tid;</span><br><span class="line"></span><br><span class="line">    pid = getpid();</span><br><span class="line">    tid = pthread_self();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s, process ID is %u, thread ID is %u, and g_Flag is %d.\n"</span>, s, (uint)pid, (uint)tid, g_Flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread1</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter thread1.\n"</span>);</span><br><span class="line">    printids(<span class="string">"This is thread1"</span>);</span><br><span class="line">    g_Flag = <span class="number">1</span>;</span><br><span class="line">    printids(<span class="string">"This is thread1"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Leave thread1.\n"</span>);</span><br><span class="line">    pthread_exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序输出如下：<br><img src="/images/concurrency/linux-multi-threading/example3-outputs.png" alt>  </p>
<p>这下程序就正确了。</p>
<h2 id="示例-4：比示例-3-更通用的方式"><a href="#示例-4：比示例-3-更通用的方式" class="headerlink" title="示例 4：比示例 3 更通用的方式"></a><strong>示例 4：比示例 3 更通用的方式</strong></h2><p>在这里我们采用另一种比示例3更通用的方式。我们贴出与示例3程序不同的部分：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter main function.\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> tid1;</span><br><span class="line">    <span class="keyword">int</span> err1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">void</span> *rval1;</span><br><span class="line"></span><br><span class="line">    err1 = pthread_create(&amp;tid1, <span class="literal">NULL</span>, thread1, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(err1 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err1));</span><br><span class="line"></span><br><span class="line">    printids(<span class="string">"This is the main thread"</span>);    </span><br><span class="line">    </span><br><span class="line">    err1 = pthread_join(tid1, &amp;rval1);</span><br><span class="line">    <span class="keyword">if</span>(err1 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err1));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"thread1 exit code is %d.\n"</span>, (<span class="keyword">int</span>)rval1);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Leave main function.\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序输出如下：<br><img src="/images/concurrency/linux-multi-threading/example4-outputs.png" alt>  </p>
<p>这下程序也是正确的。不过调用这个 pthread_join 函数的线程将一直阻塞，直到指定的线程调用 pthread_exit、从启动例程中返回或者被取消。</p>
<h2 id="示例-5：比示例-4-稍微复杂的例子"><a href="#示例-5：比示例-4-稍微复杂的例子" class="headerlink" title="示例 5：比示例 4 稍微复杂的例子"></a><strong>示例 5：比示例 4 稍微复杂的例子</strong></h2><p>示例5程序如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unsigned int unit;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_Flag = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printids</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread1</span><span class="params">(<span class="keyword">void</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread2</span><span class="params">(<span class="keyword">void</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread3</span><span class="params">(<span class="keyword">void</span> *)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter main function.\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> tid1, tid2, tid3;</span><br><span class="line">    <span class="keyword">int</span> err1 = <span class="number">0</span>, err2 = <span class="number">0</span>, err3 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">void</span> *rval1, *rval2, *rval3;</span><br><span class="line"></span><br><span class="line">    err1 = pthread_create(&amp;tid1, <span class="literal">NULL</span>, thread1, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(err1 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err1));</span><br><span class="line"></span><br><span class="line">    err2 = pthread_create(&amp;tid2, <span class="literal">NULL</span>, thread2, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(err2 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err2));</span><br><span class="line">    </span><br><span class="line">    err3 = pthread_create(&amp;tid3, <span class="literal">NULL</span>, thread3, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(err3 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err3));</span><br><span class="line">    </span><br><span class="line">    err1 = pthread_join(tid1, &amp;rval1);</span><br><span class="line">    <span class="keyword">if</span>(err1 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err1));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"thread1 exit code is %d.\n"</span>, (<span class="keyword">int</span>)rval1);</span><br><span class="line">    </span><br><span class="line">    err2 = pthread_join(tid2, &amp;rval2);</span><br><span class="line">    <span class="keyword">if</span>(err2 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err2));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"thread2 exit code is %d.\n"</span>, (<span class="keyword">int</span>)rval2);</span><br><span class="line">    </span><br><span class="line">    err3 = pthread_join(tid3, &amp;rval3);</span><br><span class="line">    <span class="keyword">if</span>(err3 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err3));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"thread3 exit code is %d.\n"</span>, (<span class="keyword">int</span>)rval3);</span><br><span class="line">    </span><br><span class="line">    printids(<span class="string">"This is the main thread"</span>);    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Leave main function.\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printids</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span>        pid;</span><br><span class="line">    <span class="keyword">pthread_t</span>    tid;</span><br><span class="line"></span><br><span class="line">    pid = getpid();</span><br><span class="line">    tid = pthread_self();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s, process ID is %u, thread ID is %u, and g_Flag is %d.\n"</span>, s, (uint)pid, (uint)tid, g_Flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread1</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter thread1.\n"</span>);</span><br><span class="line">    printids(<span class="string">"This is thread1"</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>( i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++)</span><br><span class="line">        g_Flag++;</span><br><span class="line">    printids(<span class="string">"This is thread1"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Leave thread1.\n"</span>);</span><br><span class="line">    pthread_exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread2</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter thread2.\n"</span>);</span><br><span class="line">    printids(<span class="string">"This is thread2"</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>( i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++)</span><br><span class="line">        g_Flag++;</span><br><span class="line">    printids(<span class="string">"This is thread2"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Leave thread2.\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)<span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread3</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter thread3.\n"</span>);</span><br><span class="line">    printids(<span class="string">"This is thread3"</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>( i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++)</span><br><span class="line">        g_Flag++;</span><br><span class="line">    printids(<span class="string">"This is thread3"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Leave thread3.\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)<span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序运行结果如下：<br><img src="/images/concurrency/linux-multi-threading/example5-outputs.png" alt>  </p>
<p>很明显，线程 2 和线程 3 存在竞争，导致线程 2 的输出存在问题。</p>
<h2 id="示例-6：改进示例-5"><a href="#示例-6：改进示例-5" class="headerlink" title="示例 6：改进示例 5"></a><strong>示例 6：改进示例 5</strong></h2><p>为了防止线程同时更改同一数据，我们需要给每个线程加锁，具体程序如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unsigned int unit;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_Flag = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printids</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread1</span><span class="params">(<span class="keyword">void</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread2</span><span class="params">(<span class="keyword">void</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread3</span><span class="params">(<span class="keyword">void</span> *)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter main function.\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> tid1, tid2, tid3;</span><br><span class="line">    <span class="keyword">int</span> err1 = <span class="number">0</span>, err2 = <span class="number">0</span>, err3 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">void</span> *rval1, *rval2, *rval3;</span><br><span class="line"></span><br><span class="line">    err1 = pthread_create(&amp;tid1, <span class="literal">NULL</span>, thread1, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(err1 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err1));</span><br><span class="line"></span><br><span class="line">    err2 = pthread_create(&amp;tid2, <span class="literal">NULL</span>, thread2, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(err2 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err2));</span><br><span class="line">    </span><br><span class="line">    err3 = pthread_create(&amp;tid3, <span class="literal">NULL</span>, thread3, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(err3 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err3));</span><br><span class="line">    </span><br><span class="line">    err1 = pthread_join(tid1, &amp;rval1);</span><br><span class="line">    <span class="keyword">if</span>(err1 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err1));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"thread1 exit code is %d.\n"</span>, (<span class="keyword">int</span>)rval1);</span><br><span class="line">    </span><br><span class="line">    err2 = pthread_join(tid2, &amp;rval2);</span><br><span class="line">    <span class="keyword">if</span>(err2 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err2));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"thread2 exit code is %d.\n"</span>, (<span class="keyword">int</span>)rval2);</span><br><span class="line">    </span><br><span class="line">    err3 = pthread_join(tid3, &amp;rval3);</span><br><span class="line">    <span class="keyword">if</span>(err3 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err3));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"thread3 exit code is %d.\n"</span>, (<span class="keyword">int</span>)rval3);</span><br><span class="line">    </span><br><span class="line">    printids(<span class="string">"This is the main thread"</span>);    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Leave main function.\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printids</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span>        pid;</span><br><span class="line">    <span class="keyword">pthread_t</span>    tid;</span><br><span class="line"></span><br><span class="line">    pid = getpid();</span><br><span class="line">    tid = pthread_self();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s, process ID is %u, thread ID is %u, and g_Flag is %d.\n"</span>, s, (uint)pid, (uint)tid, g_Flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(pthread_mutex_lock(&amp;mutex) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s has lock error!"</span>, s);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(pthread_mutex_unlock(&amp;mutex) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s has unlock error!"</span>, s);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread1</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    lock(<span class="string">"Thread1"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter thread1.\n"</span>);</span><br><span class="line">    printids(<span class="string">"This is thread1"</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>( i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++)</span><br><span class="line">        g_Flag++;</span><br><span class="line">    printids(<span class="string">"This is thread1"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Leave thread1.\n"</span>);</span><br><span class="line">    unlock(<span class="string">"Thread1"</span>);</span><br><span class="line">    pthread_exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread2</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    lock(<span class="string">"Thread2"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter thread2.\n"</span>);</span><br><span class="line">    printids(<span class="string">"This is thread2"</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>( i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++)</span><br><span class="line">        g_Flag++;</span><br><span class="line">    printids(<span class="string">"This is thread2"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Leave thread2.\n"</span>);</span><br><span class="line">    unlock(<span class="string">"Thread2"</span>);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)<span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread3</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    lock(<span class="string">"Thread3"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter thread3.\n"</span>);</span><br><span class="line">    printids(<span class="string">"This is thread3"</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>( i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++)</span><br><span class="line">        g_Flag++;</span><br><span class="line">    printids(<span class="string">"This is thread3"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Leave thread3.\n"</span>);</span><br><span class="line">    unlock(<span class="string">"Thread3"</span>);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)<span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序输出如下：<br><img src="/images/concurrency/linux-multi-threading/example6-outputs.png" alt>  </p>
<p>这下程序输出是正确的。想要更改线程的执行顺序，我们可以将 pthread_join 放在恰当的地方。另外，我们的锁主要是要保护数据操作的安全性，而不是 printf 函数输出的正确性。不过我们在程序中将 printf 函数同时保护起来，这样保证每个线程的输出完整性。</p>
<h2 id="示例-7：运用条件变量"><a href="#示例-7：运用条件变量" class="headerlink" title="示例 7：运用条件变量"></a><strong>示例 7：运用条件变量</strong></h2><p>示例 7 程序实现的功能是当全局变量 g_Flag 从 2 变为 1 或从 1 变为 2 时，主线程退出。具体程序（存在竞争）如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unsigned int unit;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_Flag = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"><span class="keyword">pthread_cond_t</span> cond = PTHREAD_COND_INITIALIZER;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printids</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread1</span><span class="params">(<span class="keyword">void</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread2</span><span class="params">(<span class="keyword">void</span> *)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter main function.\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> tid1, tid2;</span><br><span class="line">    <span class="keyword">int</span> err1 = <span class="number">0</span>, err2 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">void</span> *rval1, *rval2;</span><br><span class="line"></span><br><span class="line">    err1 = pthread_create(&amp;tid1, <span class="literal">NULL</span>, thread1, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(err1 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err1));</span><br><span class="line"></span><br><span class="line">    err2 = pthread_create(&amp;tid2, <span class="literal">NULL</span>, thread2, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(err2 != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, __func__, strerror(err2));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//err1 = pthread_join(tid1, &amp;rval1);</span></span><br><span class="line">    <span class="comment">//if(err1 != 0)</span></span><br><span class="line">    <span class="comment">//    printf("%s: %d\n", __func__, strerror(err1));</span></span><br><span class="line">    <span class="comment">//printf("thread1 exit code is %d.\n", (int)rval1);</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//err2 = pthread_join(tid2, &amp;rval2);</span></span><br><span class="line">    <span class="comment">//if(err2 != 0)</span></span><br><span class="line">    <span class="comment">//    printf("%s: %d\n", __func__, strerror(err2));</span></span><br><span class="line">    <span class="comment">//printf("thread2 exit code is %d.\n", (int)rval2);</span></span><br><span class="line"></span><br><span class="line">    pthread_cond_wait(&amp;cond, &amp;mutex);</span><br><span class="line">    printids(<span class="string">"This is the main thread"</span>);    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Leave main function.\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printids</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span>        pid;</span><br><span class="line">    <span class="keyword">pthread_t</span>    tid;</span><br><span class="line"></span><br><span class="line">    pid = getpid();</span><br><span class="line">    tid = pthread_self();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s, process ID is %u, thread ID is %u, and g_Flag is %d.\n"</span>, s, (uint)pid, (uint)tid, g_Flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(pthread_mutex_lock(&amp;mutex) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s has lock error!"</span>, s);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(pthread_mutex_unlock(&amp;mutex) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s has unlock error!"</span>, s);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread1</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    lock(<span class="string">"Thread1"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter thread1.\n"</span>);</span><br><span class="line">    printids(<span class="string">"This is thread1"</span>);</span><br><span class="line">    <span class="keyword">if</span>(g_Flag == <span class="number">2</span>)</span><br><span class="line">        pthread_cond_signal(&amp;cond);</span><br><span class="line">    g_Flag = <span class="number">1</span>;</span><br><span class="line">    printids(<span class="string">"This is thread1"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Leave thread1.\n"</span>);</span><br><span class="line">    unlock(<span class="string">"Thread1"</span>);</span><br><span class="line">    pthread_exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread2</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    lock(<span class="string">"Thread2"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter thread2.\n"</span>);</span><br><span class="line">    printids(<span class="string">"This is thread2"</span>);</span><br><span class="line">    <span class="keyword">if</span>(g_Flag == <span class="number">1</span>)</span><br><span class="line">        pthread_cond_signal(&amp;cond);</span><br><span class="line">    g_Flag = <span class="number">2</span>;</span><br><span class="line">    printids(<span class="string">"This is thread2"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Leave thread2.\n"</span>);</span><br><span class="line">    unlock(<span class="string">"Thread2"</span>);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)<span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序输出如下：<br><img src="/images/concurrency/linux-multi-threading/example7-outputs1.png" alt>  </p>
<p>或是<br><img src="/images/concurrency/linux-multi-threading/example7-outputs2.png" alt>  </p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/09/09/concurrency-semaphore/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          并发学习笔记：信号量
        
      </div>
    </a>
  
  
    <a href="/2018/09/09/net-tcp-state-transition-diagram/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">网络学习笔记：TCP 状态转换图</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>







      <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>

<script>
var gitalk = new Gitalk({
  clientID: '64c19d7f57bebbb343c4',
  clientSecret: '287daeba39e73fdde92f24540c9f3c0fd5238512',
  repo: 'BlogComments',
  owner: 'xiemax100',
  admin: ['xiemax100'],
  id: md5(window.location.pathname),
  distractionFreeMode: true
})

gitalk.render('gitalk-container')
</script>






    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Linux-线程介绍"><span class="toc-number">1.</span> <span class="toc-text">Linux 线程介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#进程与线程"><span class="toc-number">1.1.</span> <span class="toc-text">进程与线程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用线程的理由"><span class="toc-number">1.2.</span> <span class="toc-text">使用线程的理由</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Linux-上线程开发-API-概要"><span class="toc-number">2.</span> <span class="toc-text">Linux 上线程开发 API 概要</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#与线程自身相关-API"><span class="toc-number">2.1.</span> <span class="toc-text">与线程自身相关 API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#与互斥锁相关-API"><span class="toc-number">2.2.</span> <span class="toc-text">与互斥锁相关 API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#与条件变量相关-API"><span class="toc-number">2.3.</span> <span class="toc-text">与条件变量相关 API</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#示例"><span class="toc-number">3.</span> <span class="toc-text">示例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#示例-1：创建一个简单的线程"><span class="toc-number">3.1.</span> <span class="toc-text">示例 1：创建一个简单的线程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#示例-2：改进示例-1"><span class="toc-number">3.2.</span> <span class="toc-text">示例 2：改进示例 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#示例-3：改进示例-2"><span class="toc-number">3.3.</span> <span class="toc-text">示例 3：改进示例 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#示例-4：比示例-3-更通用的方式"><span class="toc-number">3.4.</span> <span class="toc-text">示例 4：比示例 3 更通用的方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#示例-5：比示例-4-稍微复杂的例子"><span class="toc-number">3.5.</span> <span class="toc-text">示例 5：比示例 4 稍微复杂的例子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#示例-6：改进示例-5"><span class="toc-number">3.6.</span> <span class="toc-text">示例 6：改进示例 5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#示例-7：运用条件变量"><span class="toc-number">3.7.</span> <span class="toc-text">示例 7：运用条件变量</span></a></li></ol></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录" title="点击按钮隐藏或者显示文章目录">

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var toc_button = document.getElementById("tocButton");
    var toc_div = document.getElementById("toc");
    toc_button.onclick=function() {
        if (toc_div.style.display == "none") {
            toc_div.style.display = "block";
            toc_button.value = "隐藏目录";
            document.getElementById("switch-btn").style.display = "none";
            document.getElementById("switch-area").style.display = "none";
        }
        else {
            toc_div.style.display = "none";
            toc_button.value = "显示目录";
            document.getElementById("switch-btn").style.display = "block";
            document.getElementById("switch-area").style.display = "block";
        }
    }

    if ($(".toc").length < 1) {
        $("#toc").css("display","none");
        $("#tocButton").css("display","none");
        $(".switch-btn").css("display","block");
        $(".switch-area").css("display","block");
    }
</script>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2020 Max
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>